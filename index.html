<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pinoy Pool</title>
    <!-- Tone.js for audio synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Nunito:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
    --felt-green: #006A4E;
    --wood-brown: #6B4226;
    --light-wood: #A0522D;
    --gold-accent: #FFD700;
    --dark-bg: rgba(0, 0, 0, 0.7);
    --light-text: #FFFFFF;
}

body, html {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    background-color: #2c3e50;
    background-image: url('https://www.transparenttextures.com/patterns/dark-denim-3.png');
    
    justify-content: center;
    
    overflow: hidden;
    font-family: 'Nunito', sans-serif;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* === FRIENDS LIST MODAL STYLES === */
.friends-search-container {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

#friend-search-input {
    flex-grow: 1; /* Para humaba at sakupin ang space */
    font-family: 'Nunito', sans-serif;
    font-size: 1em;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
}

#add-friend-btn {
    flex-shrink: 0; /* Para hindi lumitit */
    padding: 5px 15px !important;
    font-size: 0.9em !important;
    margin: 0 !important;
}

.friends-search-results {
    /* Ito ang lalagyan ng search results, parang sa pending list */
    max-height: 120px;
    overflow-y: auto;
    margin-bottom: 15px;
}

.friends-subheader {
    font-family: 'Luckiest Guy', cursive;
    color: var(--gold-accent);
    margin-top: 20px;
    margin-bottom: 8px;
    text-align: left;
    font-size: 1.4em;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding-bottom: 5px;
}

.friends-list-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 10px;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid rgba(0,0,0,0.4);
}

.friend-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 5px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.friend-info {
    display: flex;
    flex-direction: column;
    text-align: left;
}

.friend-name {
    font-size: 1.1em;
    font-weight: bold;
    color: var(--light-text);
}

.friend-rank {
    font-size: 0.9em;
    opacity: 0.8;
}

.friend-actions {
    display: flex;
    gap: 5px;
    flex-shrink: 0;
}

.friend-item-empty {
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
    padding: 10px;
    text-align: center;
}

/* Specific button colors */
.invite-btn {
    background-color: #007bff !important;
}
.accept-btn {
    background-color: #28a745 !important;
}
.decline-btn {
    background-color: #dc3545 !important;
}

#credits-container {
Â  Â  display: none;
}

/* === VERSUS SCREEN STYLES === */
#vs-screen-modal {
Â  Â  /*
Â  Â  Â * BINURA NATIN YUNG LAMAN DITO.
Â  Â  Â * Hahayaan nating 'yung .modal-overlay class ang mag-handle 
Â  Â  Â * ng pagtago, background, at blur.
Â  Â  */
}

#vs-screen-modal.show {
Â  Â  /*
Â  Â  Â * Ito na lang ang kailangan natin.
Â  Â  Â * Kinukuha na niya 'yung "show" state galing sa .modal-overlay.show,
Â  Â  Â * tapos idadagdag lang natin 'yung unique animation.
Â  Â  */
Â  Â  animation: vsFadeOut 0.5s ease-out 3.5s forwards;
}

#vs-content-box {
Â  Â  display: flex;
Â  Â  flex-direction: row;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  gap: 40px;
Â  Â  width: 90vw;
Â  Â  max-width: 800px;
}

.vs-player-box {
Â  Â  flex: 1; /* Para pantay ang laki */
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  padding: 20px;
Â  Â  background-color: rgba(0, 0, 0, 0.5);
Â  Â  border-radius: 10px;
Â  Â  border: 2px solid rgba(255, 255, 255, 0.3);
}

#vs-player-1-box {
Â  Â  align-items: flex-end; /* Para 'right-aligned' ang text ni P1 */
Â  Â  animation: vsSlideInLeft 0.7s ease-out 0.2s forwards;
Â  Â  opacity: 0; /* Naka-tago by default para sa animation */
}
#vs-player-2-box {
Â  Â  align-items: flex-start; /* Para 'left-aligned' ang text ni P2 */
Â  Â  animation: vsSlideInRight 0.7s ease-out 0.2s forwards;
Â  Â  opacity: 0; /* Naka-tago by default para sa animation */
}

.vs-player-rank {
Â  Â  font-size: 1.5em;
Â  Â  font-weight: bold;
Â  Â  font-family: 'Nunito', sans-serif;
Â  Â  opacity: 0.8;
}

.vs-player-name {
Â  Â  font-family: 'Luckiest Guy', cursive;
Â  Â  font-size: 3em;
Â  Â  color: var(--gold-accent);
Â  Â  text-shadow: 2px 2px 6px rgba(0,0,0,0.7);
Â  Â  line-height: 1.1;
Â  Â  word-break: break-all; /* Para 'di lumagpas ang mahabang pangalan */
}

#vs-divider {
Â  Â  font-family: 'Luckiest Guy', cursive;
Â  Â  font-size: 5em;
Â  Â  color: #ff6b6b; /* Red */
Â  Â  text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
Â  Â  transform: scale(0); /* Naka-tago by default */
Â  Â  animation: vsPopIn 0.5s ease-out 0.8s forwards; /* Lilitaw sa gitna */
}

#vs-game-mode {
Â  Â  position: absolute;
Â  Â  bottom: 30px;
Â  Â  font-family: 'Luckiest Guy', cursive;
Â  Â  font-size: 2em;
Â  Â  color: var(--light-text);
Â  Â  text-shadow: 1px 1px 4px rgba(0,0,0,0.6);
Â  Â  opacity: 0; /* Naka-tago by default */
Â  Â  animation: vsFadeIn 1s ease-out 1.2s forwards; /* Lilitaw sa dulo */
}

/* === KEYFRAME ANIMATIONS === */
@keyframes vsFadeOut {
Â  Â  from { opacity: 1; transform: translateY(0); }
Â  Â  to { opacity: 0; transform: translateY(-20px); }
}
@keyframes vsPopIn {
Â  Â  from { transform: scale(0); }
Â  Â  to { transform: scale(1); }
}
@keyframes vsSlideInLeft {
Â  Â  from { opacity: 0; transform: translateX(-100px); }
Â  Â  to { opacity: 1; transform: translateX(0); }
}
@keyframes vsSlideInRight {
Â  Â  from { opacity: 0; transform: translateX(100px); }
Â  Â  to { opacity: 1; transform: translateX(0); }
}
@keyframes vsFadeIn {
Â  Â  from { opacity: 0; }
Â  Â  to { opacity: 1; }
}

/* === BAGONG XP BAR (CLEAN SLATE) === */
#xp-container {
Â  Â  position: absolute;
Â  Â  bottom: 0px; /* Mas malapit sa currency */
Â  Â  left: 0px;
Â  Â  background-color: var(--dark-bg);
Â  Â  border: 1px solid rgba(255, 255, 255, 0.2);
Â  Â  border-radius: 8px;
Â  Â  padding: 4px 8px;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 3px;
Â  Â  backdrop-filter: blur(5px);
Â  Â  z-index: 10;
}
#xp-level {
Â  Â  font-size: 0.9em; 
Â  Â  font-weight: bold;
Â  Â  color: var(--light-text);
Â  Â  flex-shrink: 0; 
}
#xp-bar-wrapper {
Â  Â  width: 30px; 
Â  Â  height: 12px; 
Â  Â  background-color: rgba(0,0,0,0.5);
Â  Â  border: 1px solid rgba(0,0,0,0.7);
Â  Â  border-radius: 6px;
Â  Â  position: relative;
Â  Â  overflow: hidden;
}
#xp-bar-fill-new {
Â  Â  position: absolute;
Â  Â  top: 0;
Â  Â  left: 0;
Â  Â  height: 100%;
Â  Â  width: 0%; 
Â  Â  background: linear-gradient(to right, #33FF57, #28a745);
Â  Â  border-radius: 6px;
Â  Â  transition: width 0.3s ease;
Â  Â  z-index: 1;
}
#xp-text-display-new {
Â  Â  position: absolute;
Â  Â  top: 0;
Â  Â  left: 0;
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  Â  display: flex;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  font-size: 10px;
Â  Â  font-weight: bold;
Â  Â  color: white;
Â  Â  text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
Â  Â  z-index: 2;
}
/* === DULO NG BAGONG XP BAR === */

/* === ITO ANG TAMANG STYLE PARA SA SHOP CONTAINER === */
/* Ito na 'yung "patong-patong" at scroll pababa */
#shop-items-container {
    display: flex;
    flex-direction: column; /* Ito ang nagpapatong-patong */
    gap: 20px;
    padding: 15px; 
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    margin-bottom: 20px; 
    flex-grow: 1; /* Para kunin ang natitirang space */
    overflow-y: auto; /* Dito ka mag-i-scroll PABABA */
    overflow-x: hidden;
    min-height: 100px; /* Para may minimum na taas */
}
/* === DITO NAGTAPOS ANG TAMA === */


/* === STYLES PARA SA STATS BARS === */
.shop-item-stats {
    width: 100%;
    padding: 5px 0;
    margin-bottom: 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.stat-entry {
    display: flex;
    align-items: center;
    width: 100%;
}
.stat-label {
    font-size: 0.75em;
    color: #ddd;
    width: 40px;
    text-align: left;
    margin-right: 5px;
    flex-shrink: 0;
}
.stat-bar-background {
    flex-grow: 1;
    height: 10px;
    background-color: rgba(0, 0, 0, 0.4);
    border-radius: 5px;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.6);
}
.stat-bar-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 0.3s ease-out;
    box-shadow: inset 0 0 3px rgba(255,255,255,0.2);
}
.stat-bar-fill.power {
    background: linear-gradient(to right, #ff6b6b, #ee5253); /* Red */
}
.stat-bar-fill.aim {
    background: linear-gradient(to right, #54a0ff, #2e86de); /* Blue */
}
.stat-bar-fill.spin {
    background: linear-gradient(to right, #1dd1a1, #10ac84); /* Green */
}
/* === END NG STYLES PARA SA STATS BARS === */


#shop-modal .content {
    width: 80%; 
    max-width: 600px; 
    max-height: 85vh;
    background-color: rgba(40, 40, 90, 0.85); 
    padding: 20px 30px;
    border-radius: 15px;
    border: 1px solid rgba(255,255,255,0.2);
    display: flex; /* Kailangan ito para gumana ang flex-grow */
    flex-direction: column; /* Kailangan ito para mag-stack ang title at container */
}

/* === TANGGAL NA DITO YUNG CONFLICTING RULE === */

.shop-item {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.shop-item-preview {
    width: 100%;
    height: 100px;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    margin-bottom: 10px;
    filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.7)); 
}

.shop-item-name {
    font-weight: bold;
    font-size: 0.9em;
    margin-bottom: 10px;
}

.shop-buy-button {
    padding: 8px 12px;
    font-size: 0.9em;
    font-weight: bold;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.shop-buy-button.buy {
    background-color: #28a745;
}
.shop-buy-button.buy:hover {
    background-color: #218838;
}
.shop-buy-button.equip {
    background-color: #007bff;
}
.shop-buy-button.equip:hover {
    background-color: #0069d9;
}
.shop-buy-button.equipped {
    background-color: #6c757d;
    cursor: not-allowed;
    opacity: 0.7;
}
.shop-buy-button.disabled {
    background-color: #dc3545;
    cursor: not-allowed;
    opacity: 0.7;
}

#cue-stick-element {
    display: none;
    position: absolute;
    pointer-events: none;
    z-index: 30;
    transform-origin: 100% 50%;
    filter: drop-shadow(2px 2px 5px rgba(0,0,0,0.5));
}

#game-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}

#table-frame {
    padding: 25px; 
    background-image: url('https://www.transparenttextures.com/patterns/shley-tree-2.png');
    background-color: #e09412; 
    border-radius: 10px;
    box-sizing: border-box; 
    box-shadow: 
        0 15px 30px 5px rgba(0,0,0,0.6), 
        inset 0 0 10px rgba(0,0,0,0.7),
        inset 2px 2px 5px rgba(255, 255, 255, 0.2),
        inset -2px -2px 5px rgba(0, 0, 0, 0.4);
}

#game-canvas {
    background-color: #C59D5F;
    cursor: crosshair;
    width: 100%;
    height: 100%;

    /* --- IDAGDAG MO ITONG MGA ITO SA BABA --- */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

#ghost-hand {
    display: none;
    position: absolute;
    width: 80px;
    height: auto;
    opacity: 0.7;
    z-index: 50;
    pointer-events: none;
    transform: translate(-25px, -15px);
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.4));
}

#non-interactive-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5;
}

#message-box {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--dark-bg);
    color: var(--gold-accent);
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 1.3em;
    display: none;
    text-align: center;
    font-weight: bold;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.info-box {
    position: absolute;
    color: var(--gold-accent);
    background-color: var(--dark-bg);
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 4px 7px;
    border-radius: 10px;
    font-size: 0.8em;
    font-weight: bold;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    max-width: 210px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.modal-coin-display {
    font-size: 1.1em;
    font-weight: bold;
    color: var(--gold-accent);
    background-color: rgba(0, 0, 0, 0.2);
    padding: 8px 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: inline-block;
}

#currency-display {
    top: 5px;
    left: 5px;
    font-size: 0.7em;
    color: var(--gold-accent);
    display: flex; 
    align-items: center;
    gap: 5px; 
    padding: 2px 7px;
}

#player-info { top: 0px; left: 70px; }
#opponent-info { top: 0px; right: 70px; }

.ui-button {
    position: absolute;
    padding: 20px 15px;
    font-size: 1em;
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 5px;
    cursor: pointer;
    pointer-events: all;
    z-index: 10;
}

#exit-button {
    bottom: 0px; 
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(220, 53, 69, 0.7);
    padding: 4px 16px;
    font-size: 0.8em;
    z-index: 100;
    transition: all 0.2s ease-in-out;
    border-radius: 8px;
}
#exit-button:hover {
    background-color: rgba(220, 53, 69, 1);
    transform: translateX(-50%) scale(1.05);
}

.icon-button {
    background-color: rgba(0, 0, 0, 0.6);
    width: 40px; 
    height: 40px;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    transition: all 0.2s ease-in-out;
}
.icon-button:hover {
    transform: scale(1.1);
    border-color: var(--gold-accent);
}

#card-hand-container, #poker-foul-cards {
    position: absolute;
    top: 0px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: row; 
    gap: 8px; 
    pointer-events: all;
    z-index: 10;
}

#poker-foul-cards {
    top: auto; 
    position: relative;
    transform: none;
    left: auto;
    margin-top: 20px;
    justify-content: center;
}

.card {
    width: 40px;
    height: 60px;
    background-color: rgba(255, 255, 255, 0.9); 
    border: 1px solid rgba(0, 0, 0, 0.2); 
    border-radius: 4px; 
    display: flex;
    flex-direction: column; 
    justify-content: space-between;
    align-items: center;
    padding: 2px;
    font-weight: bold;
    color: #333;
    text-shadow: none;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
#card-hand-container .card {
    width: 13px;
    height: 23px;
}
.card-rank { font-size: 1.0em; }
.card-suit { font-size: 0.9em; align-self: flex-end; }
#card-hand-container .card-rank { font-size: 0.6em; }
#card-hand-container .card-suit { font-size: 0.6em; }

.card.face-down {
    background-image: linear-gradient(135deg, #4a90e2 25%, #50e3c2 100%);
    cursor: pointer;
}
.card.face-down:hover {
    transform: translateY(-10px) scale(1.05);
    box-shadow: 0 8px 15px rgba(0,0,0,0.3);
}

.control-area {
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: all;
    z-index: 20;
}

#power-control {
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    width: 40px; 
    height: 230px;
    background-color: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    flex-direction: column;
    justify-content: flex-end;
    padding: 4px;
}
#power-bar {
    width: 100%;
    background: linear-gradient(to top, #00ff00, #ffff00, #ff0000);
    border-radius: 10px;
    height: 0%;
}

#pektus-control {
    bottom: 70px;
    left: 10px; 
    top: auto; 
    right: auto;
    transform: none;
    width: 30px;
    height: 30px;
    background: var(--gold-accent);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: inset 0 0 8px rgba(0,0,0,0.6);
    border: 2px solid rgba(0,0,0,0.3);
}

#pektus-dot {
    position: absolute;
    width: 10px;
    height: 10px;
    background-color: transparent;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    border: 1px solid #D32F2F;
    box-sizing: border-box;
}
#pektus-dot::before,
#pektus-dot::after {
    content: '';
    position: absolute;
    background-color: #D32F2F;
}
#pektus-dot::before {
    top: 50%;
    left: 2px;
    right: 2px;
    height: 1px;
    transform: translateY(-50%);
}
#pektus-dot::after {
    left: 50%;
    top: 2px;
    bottom: 2px;
    width: 1px;
    transform: translateX(-50%);
}

.arrow-button {
    position: absolute;
    bottom: 0px;
    width: 70px;
    height: 33px;
    background-color: rgba(0, 0, 0, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
}
.arrow-button:active {
    transform: scale(0.95);
    background-color: rgba(0,0,0,0.6);
}
#left-arrow {
    right: 50%;
    transform: translateX(-120px);
}
#right-arrow {
    left: 50%;
    transform: translateX(120px);
}

.modal-overlay {
    display: flex; 
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.85);
    justify-content: center;
    align-items: center;
    text-align: center;
    color: white;
    flex-direction: column;
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    backdrop-filter: blur(8px);
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
    pointer-events: all;
}

.modal-overlay.faded {
    opacity: 0.1; 
}

#confirm-exit-modal {
    z-index: 300;
}

.modal-overlay h2 {
    font-family: 'Luckiest Guy', cursive;
    font-size: 3em;
    margin-bottom: 20px;
    color: var(--gold-accent);
    letter-spacing: 2px;
    text-shadow: 3px 3px 8px rgba(0,0,0,0.8);
}

.menu-button {
    font-size: 1.3em;
    padding: 15px 25px;
    margin: 10px;
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.7);
    background-color: rgba(76, 175, 80, 0.5);
    color: white;
    cursor: pointer;
    width: 320px;
    pointer-events: all;
    transition: all 0.3s;
    font-weight: bold;
    text-transform: uppercase;
}
.menu-button:hover {
    transform: scale(1.05);
    background-color: rgba(76, 175, 80, 0.8);
    border-color: var(--gold-accent);
}
.menu-button:disabled {
    background-color: rgba(108, 117, 125, 0.3);
    border-color: rgba(255, 255, 255, 0.3);
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}
.back-button {
    background-color: rgba(108, 117, 125, 0.5);
    margin-top: 20px;
}
.back-button:hover {
    background-color: rgba(108, 117, 125, 0.8);
}

#winner-modal h2 {
    margin-bottom: 0;
}
#ai-rematch-button, #back-to-menu-button {
    font-size: 1.2em;
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    color: white;
    width: 250px;
    margin: 5px 0;
}
#ai-rematch-button {
    background-color: #4CAF50;
}
#back-to-menu-button {
    background-color: #6c757d;
}

.winner-modal-content-wrapper {
    display: flex;
    flex-direction: row-reverse; 
    align-items: flex-start;
    justify-content: center;
    gap: 50px;
    background-color: rgba(30, 30, 30, 0.7);
    padding: 30px 40px;
    border-radius: 15px;
    border: 1px solid rgba(255,255,255,0.2);
    max-width: 90vw;
    max-height: 80vh;
    overflow-y: auto;
}

.winner-text-and-buttons {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    text-align: center;
    min-width: 300px;
    padding-top: 20px;
    gap: 15px;
}

#opponent-hand-reveal {
    margin-top: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
}

#rematch-button {
    display: none; 
    width: 250px; 
    margin: 5px 0;
    font-size: 1.2em;
    padding: 10px 20px;
}

#online-menu input {
    font-family: 'Nunito', sans-serif;
    font-size: 1.1em;
    padding: 12px;
    margin: 10px;
    width: 280px;
    border-radius: 5px;
    border: 1px solid #ccc;
}
#opponent-hand-reveal .card {
    transform: scale(0.8);
}

.instruction-modal .content, #leaderboard-modal .content {
    background-color: rgba(40, 40, 90, 0.85);
    padding: 20px 30px;
    border-radius: 15px;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid rgba(255,255,255,0.2);
}
.instruction-modal .play-button-container {
    margin-bottom: 20px;
}
.instruction-modal p {
    font-style: italic;
    line-height: 1.6;
    font-size: 1.1em;
    text-align: left;
}

.guide-text {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(255, 255, 0, 0.8);
    color: black;
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 1.1em;
    font-weight: bold;
    display: none; 
    text-align: center;
}

#waiting-room p {
    font-size: 1.2em;
    margin-bottom: 15px;
}
#waiting-room #game-id-display {
    background-color: rgba(0,0,0,0.4);
    padding: 15px 25px;
    border-radius: 8px;
    font-size: 2.5em;
    font-weight: bold;
    letter-spacing: 5px;
    border: 1px solid rgba(255,255,255,0.3);
    margin-bottom: 20px;
    cursor: pointer;
}

#confirm-exit-modal .button-group {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}
#confirm-exit-modal .confirm-button {
    width: 140px;
    pointer-events: all;
}
#confirm-exit-yes {
    background-color: rgba(220, 53, 69, 0.7);
}
#confirm-exit-cancel {
    background-color: rgba(108, 117, 125, 0.7);
}

#leaderboard-modal .content {
    width: 80%; 
    max-width: 500px;
}
#leaderboard-modal table {
    width: 100%; 
    text-align: left; 
    border-collapse: collapse;
}
#leaderboard-modal th, #leaderboard-modal td {
    padding: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.3);
}

#chat-container {
    position: absolute;
    bottom: 10px;
    left: 10px;
    width: 300px;
    height: 200px;
    background-color: rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    display: none; 
    flex-direction: column;
    z-index: 150;
    pointer-events: all;
    font-size: 0.9em;
    backdrop-filter: blur(5px);
}
#chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 8px;
    display: flex;
    flex-direction: column-reverse;
}
#chat-messages p { margin: 2px 0; padding: 4px 8px; border-radius: 5px; color: white; word-wrap: break-word; }
#chat-messages .my-message { background-color: #007bff; align-self: flex-end; text-align: right; }
#chat-messages .opponent-message { background-color: #454d55; align-self: flex-start; text-align: left; }
#chat-input-area { display: flex; padding: 5px; border-top: 1px solid rgba(255, 255, 255, 0.2); }
#chat-input { flex-grow: 1; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 5px; border-radius: 4px; }
#chat-send-btn { margin-left: 5px; background-color: #28a745; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

.loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--gold-accent); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; margin-bottom: 20px; }
@keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

#chat-toggle-button { top: 75% !important; left: 5px !important; }

#credits-container {
    position: absolute;
    bottom: 5px;
    right: 10px;
    font-size: 0.5em;
    color: rgba(255, 255, 255, 0.6);
    text-align: right;
    z-index: 100;
    pointer-events: none;
}

/* START: Tutorial Styles */
#tutorial-overlay {
    z-index: 500;
    background-color: transparent;
    backdrop-filter: none;
    pointer-events: none; 
}
#tutorial-highlight {
    position: absolute;
    border: 3px dashed var(--gold-accent);
    border-radius: 10px;
    box-shadow: none; 
    pointer-events: none;
    transition: all 0.4s ease-in-out;
    z-index: 501;
    box-sizing: border-box;
}
#tutorial-box {
    position: absolute;
    background-color: var(--dark-bg);
    color: var(--light-text);
    padding: 20px;
    border-radius: 10px;
    border: 2px solid var(--gold-accent);
    max-width: 350px;
    text-align: center;
    font-size: 1.1em;
    pointer-events: all;
    z-index: 502;
    line-height: 1.5;
    box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    transition: all 0.4s ease-in-out;
}
#tutorial-box p {
    margin: 0 0 15px 0;
}
#tutorial-next-btn {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    font-weight: bold;
    transition: transform 0.2s;
}
#tutorial-next-btn:hover {
    transform: scale(1.05);
}
/* END: Tutorial Styles */

.modal-close-btn {
    position: absolute;
    top: 10px;
    right: 20px;
    font-size: 2.5em;
    font-weight: bold;
    color: #fff;
    line-height: 1;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
    text-shadow: 0 0 5px rgba(0,0,0,0.5);
    z-index: 10;
}
.modal-close-btn:hover {
    opacity: 1;
}

#main-menu-buttons {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 320px; 
}

@media (orientation: landscape) {
    #main-menu-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        width: 100%;
        max-width: 660px;
    }
    #vs-ai-button { order: 1; }
    #shop-button { order: 2; } 
    #online-button { order: 3; }
    #leaderboard-button { order: 4; }
    #game-mode-select .menu-button {
        width: 100%; 
        box-sizing: border-box;
        margin: 5px 0;
    }
}

#online-menu-columns {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 320px;
}
#online-menu .online-column {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
}
#online-menu #find-match-button {
    margin-top: 15px;
}

@media (orientation: landscape) {
    #online-menu {
        justify-content: center;
    }
    #online-menu-columns {
        flex-direction: row;
        justify-content: center;
        align-items: flex-start;
        gap: 20px;
        width: 100%;
        max-width: 680px;
        margin-top: 15px;
    }
    #online-menu .online-column {
        flex: 1;
    }
    #online-column-left { order: 1; }
    #create-game-button { order: 1; }
    #join-game-button { order: 2; }
    #game-id-input { 
        order: 3;
        display: block;
    } 
    #online-column-right { order: 2; }
    #find-match-button { order: 1; }
    #online-back-button { order: 2; }
    #online-menu .online-column .menu-button,
    #online-menu .online-column input {
        width: 100%;
        box-sizing: border-box;
    }
}

#game-mode-select {
    display: none !important;
}

#lobby-buttons-container {
    pointer-events: all;
    backdrop-filter: blur(3px);
}

.lobby-button {
    width: auto;
    min-width: 50px;
    height: 35px;
    padding: 5px 10px;
    font-size: 0.8em;
    margin: 0;
    border-width: 1px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.4);
}
.lobby-button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
}

#daily-reward-button.claimed {
    background-color: rgba(108, 117, 125, 0.5) !important;
    opacity: 0.7;
    cursor: not-allowed;
}
#daily-reward-button.claimed:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    transform: none;
}

@keyframes glow {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (orientation: landscape) {
    #lobby-buttons-container {
        flex-direction: row;
    }
    .lobby-button {
        width: auto !important;
        margin: 0 !important;
    }
}

#utility-controls-container {
    position: absolute;
    top: 50%; 
    left: 10px;
    transform: translateY(-50%);
    z-index: 000;
    display: flex;
    flex-direction: column;
    gap: 8px;
    pointer-events: all;
}

#utility-controls-container .icon-button {
    width: 35px;
    height: 35px;
    padding: 0;
    margin: 0;
}

#fullscreen-button,
#mute-button,
#voice-toggle-button {
    position: relative !important; 
    top: auto !important;
    right: auto !important;
    transform: none !important;
    font-size: 1em !important;
}

#fullscreen-button svg, 
#mute-button svg,
#voice-toggle-button svg {
    width: 20px;
    height: 20px;
}

#mute-button svg {
    display: block;
}

#mute-button {
    font-size: 1em !important;
}

/* === ITO YUNG FIX PARA SA LANDSCAPE TITLE === */
/* Para sa mga screen na mababa ang taas (tulad ng landscape na phone) */
@media (max-height: 550px) {
    
    .modal-overlay h2 {
        font-size: 1.8em !important; /* Pinaliiit ang title */
        margin-bottom: 8px !important; /* Binabawasan ang space sa baba */
    }

    /* Ayusin din natin ang padding ng content para 'di siksik */
    .modal-overlay .content {
        padding-top: 15px !important;
        padding-bottom: 15px !important;
    }
    
    /* Specific para sa shop subtitle */
    #shop-modal p {
        margin-top: -8px !important;
        font-size: 0.9em !important;
        margin-bottom: 8px !important;
    }
    
    /* Baka kailangan din liitan ang coin display */
    .modal-coin-display {
        margin-bottom: 10px !important;
        font-size: 1em !important;
    }
}
/* === DITO NAGTAPOS ANG FIX === */

/* Ginagawa nitong flex container ang modal content */
#friends-modal .content {
    display: flex;
    flex-direction: column;
}

/* Ito ang magic: ito lang ang mag-s-scroll, 
   habang 'yung title at search bar ay mananatili sa taas */
.friends-lists-wrapper {
    flex-grow: 1; /* Kukunin nito ang natitirang space */
    overflow-y: auto; /* LALABAS ANG SCROLLBAR DITO */
    min-height: 100px; /* Para may minimum na taas */
    padding-top: 10px; /* Kaunting espasyo mula sa search results */
}

    </style>
</head>
<body>
    <div id="start-overlay" class="modal-overlay show">
    <h2>Pinoy Pool</h2>
    <p id="start-prompt-text" style="font-size: 1.5em; margin-top: -10px; color: rgba(255,255,255,0.8); cursor: pointer; display: none;">
        Click anywhere to start
    </p>

    <div id="start-name-input-area" style="display: flex; flex-direction: column; align-items: center;">
        <p style="font-size: 1.2em; margin-bottom: 10px; color: rgba(255,255,255,0.9);">
            Enter your name to start:
        </p>
        <input type="text" id="start-player-name-input" placeholder="Your Name" maxlength="15" style="font-family: 'Nunito', sans-serif; font-size: 1.3em; padding: 12px; margin: 10px; width: 280px; border-radius: 5px; border: 1px solid #ccc; text-align: center; background-color: rgba(255,255,255,0.1); color: white;">
        <button id="start-name-submit-btn" class="menu-button" style="width: 200px; margin-top: 15px; font-size: 1.1em; padding: 10px 20px;">Continue</button>
    </div>
    </div>

    <!-- MOVED: Fullscreen button is now outside the game wrapper to be always visible -->
  

    <div id="game-wrapper">

    <div id="utility-controls-container">
        
        <button id="mute-button" class="ui-button icon-button" title="Toggle Music">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="color: white;"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8a6.472 6.472 0 0 1-1.904 4.596l1.414 1.414zM10.121 12.596A6.48 6.48 0 0 0 12.026 8a6.48 6.48 0 0 0-1.905-4.596l-1.414 1.414A4.486 4.486 0 0 1 10.026 8a4.486 4.486 0 0 1-1.319 3.182l1.414 1.414zM8.707 11.182A2.482 2.482 0 0 0 9.026 8a2.482 2.482 0 0 0-.32-1.182L8 7.525v1.95l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10H1.5A.5.5 0 0 1 1 9.5v-3A.5.5 0 0 1 1.5 6h2.325l2.363-2.39a.5.5 0 0 1 .529-.06z"/></svg>
        </button>
        
        <button id="voice-toggle-button" class="ui-button icon-button" title="Toggle AI Voice">
            <svg id="voice-on-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="color: white;">
                <path d="M7 4.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-7zM5 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-3zM9 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v5a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-5zM11 7.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/>
                <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-6.6 9.684.5.5 0 0 0 .5.316h1.244A6.452 6.452 0 0 0 2 8a6 6 0 1 1 11.2 3.535l-.014-.002h-.58a.5.5 0 0 0-.5.5v.195a.5.5 0 0 0 .61.488A7 7 0 0 0 8 15a7 7 0 0 0 6.643-9.595.5.5 0 0 0-.508-.316h-1.244A6.47 6.47 0 0 0 14 8a6 6 0 0 1-5.6-8.316z"/>
            </svg>
            <svg id="voice-off-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="color: white; display: none;">
                <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-1.414 1.414A6.472 6.472 0 0 1 12.026 8c0 1.554-.54 2.97-.904 4.596l1.414 1.414zM10.121 12.596A6.48 6.48 0 0 0 12.026 8a6.48 6.48 0 0 0-1.905-4.596l-1.414 1.414A4.486 4.486 0 0 1 10.026 8c0 .93-.28 1.78-.752 2.582l1.414 1.414zM8.707 11.182A2.482 2.482 0 0 0 9.026 8a2.482 2.482 0 0 0-.32-1.182L8 7.525v1.95l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10H1.5A.5.5 0 0 1 1 9.5v-3A.5.5 0 0 1 1.5 6h2.325l2.363-2.39a.5.5 0 0 1 .529-.06zm-6.288-.31L1.5 2.5v11l-.288-.288a.5.5 0 0 1 0-.707l12-12a.5.5 0 0 1 .707.707L1.135 14.135a.5.5 0 0 1-.707 0L.139 13.849a.5.5 0 0 1 0-.707l12-12a.5.5 0 0 1 .707.707L.429 3.24z"/>
            </svg>
        </button>
        
        <button id="fullscreen-button" class="ui-button icon-button" title="Toggle Fullscreen">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="color: white;"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/></svg>
        </button>
    </div>   

        <img id="cue-stick-element">

        <div id="table-frame">
            <canvas id="game-canvas"></canvas>
        </div>

        <button id="chat-toggle-button" class="icon-button" style="display: none; position: absolute; transform: translateY(-50%); z-index: 151; background: none; border: none; box-shadow: none; width: 30px; height: 30px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" style="color: white;"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h2.5a2 2 0 0 1 1.6.8L8 14.333 9.9 11.8a2 2 0 0 1 1.6-.8H14a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2z"/></svg>
        </button>

        <img id="ghost-hand" src="https://i.imgur.com/ZPG3GhI.png">
        
        <div id="non-interactive-overlay">
    
    <div id="currency-display" class="info-box">
    ğŸ’° <span class="coin-balance-display">0</span>
</div>

<div id="xp-container" style="position: absolute; bottom: 5px; left: 5px; background-color: var(--dark-bg); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; 
    
    /* â–¼â–¼â–¼ DITO KO INAYOS ANG PADDING (ESPASYO) â–¼â–¼â–¼ */
    padding: 3px 5px; /* <--- GINAWA KONG 3px (taas/baba) at 5px (kaliwa/kanan) */
    
    display: flex; align-items: center; backdrop-filter: blur(5px); z-index: 10; white-space: nowrap;
    
    /* â–¼â–¼â–¼ DITO KO INALIS ANG PESTENG 'GAP' â–¼â–¼â–¼ */
    gap: 0px; 
">
    
    <div id="xp-level" style="font-size: 0.8em; font-weight: bold; color: var(--light-text); flex-shrink: 0;
        
        /* â–¼â–¼â–¼ DITO KO KINONTROL ANG ESPASYO â–¼â–¼â–¼ */
        padding-right: 4px;
    ">
          <span id="player-level-display">1</span>
    </div>
    
    <div id="xp-bar-wrapper" style="width: 80px; height: 8px; background-color: rgba(0,0,0,0.5); border: 1px solid rgba(0,0,0,0.7); border-radius: 4px; position: relative; overflow: hidden;">
        <div id="xp-bar-fill-new" style="position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: linear-gradient(to right, #33FF57, #28a745); border-radius: 4px; transition: width 0.3s ease; z-index: 1;"></div>
    </div>

    <div id="xp-text-display-new" style="font-size: 0.8em; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        
        /* â–¼â–¼â–¼ DITO KO KINONTROL ANG ESPASYO â–¼â–¼â–¼ */
        padding-left: 4px;
    ">
        0/100
    </div>

</div>
    
    <div id="player-info" class="info-box">You: ?</div>
    <div id="opponent-info" class="info-box">Opponent: ?</div>
    </div>
            <div id="message-box"></div>
            <div id="cue-ball-guide" class="guide-text"></div>
            <div id="chat-container">
                <div id="chat-messages"></div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Type a message...">
                    <button id="chat-send-btn">Send</button>
                </div>
            </div>
            <div id="drag-guide-text" class="guide-text">Place the cue ball</div>
        </div>

        <button id="exit-button" class="ui-button">Exit</button>
        <div id="card-hand-container"></div>
        
        
        <div id="power-control" class="control-area">
            <div id="power-bar"></div>
        </div>
        <div id="pektus-control" class="control-area">
            <div id="pektus-dot"></div>
        </div>
        <div id="left-arrow" class="arrow-button control-area">&lt;</div>
        <div id="right-arrow" class="arrow-button control-area">&gt;</div>
    </div>

<div id="lobby-buttons-container" style="display: none; position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; gap: 10px; padding: 5px; background-color: rgba(0,0,0,0.4); border-radius: 10px;">

    <button class="menu-button lobby-button" id="vs-ai-button" title="Player vs AI">ğŸ® AI</button>
    <button class="menu-button lobby-button" id="online-button" title="Online Multiplayer">ğŸŒ Online</button>
    <button class="menu-button lobby-button" id="leaderboard-button" title="Leaderboard" style="background-color: rgba(255, 193, 7, 0.5);">ğŸ† Top</button>
    <button class="menu-button lobby-button" id="shop-button" title="Shop" style="background-color: rgba(23, 162, 184, 0.5);">ğŸ›’ Shop</button>
    <button class="menu-button lobby-button" id="daily-reward-button" title="Daily Reward" style="background-color: rgba(255, 165, 0, 0.5);">ğŸ Reward</button>
<button class="menu-button lobby-button" id="friends-button" title="Friends" style="background-color: rgba(40, 167, 69, 0.5);">ğŸ¤ Friends</button>
    Â  Â  
</div>

  </div> <div id="game-mode-select" class="modal-overlay" style="display: none;">
</div>

<div id="ai-menu" class="modal-overlay">
    <span class="modal-close-btn" id="ai-menu-close-btn">&times;</span> <h2>Player vs AI</h2>
    <button class="menu-button" id="ai-straight-ball-button">STRAIGHT BALL</button>
    <button class="menu-button" id="ai-poker-button">POKER</button>
    <button class="menu-button" id="ai-61-button">61 BALL</button>
    </div>
    <!-- REMOVED: Difficulty select modal is no longer needed -->
    <!-- <div id="difficulty-select" class="modal-overlay"> ... 
 </div> -->
   <div id="straight-ball-instructions" class="modal-overlay instruction-modal"> ... <div class="content"> <div class="play-button-container"> <button class="menu-button" id="play-straight-ball-button">Play</button> </div> <h2>Straight Ball Rules</h2> <p> - Continue your turn by legally pocketing your balls.<br> - The first color legally pocketed on an 'open table' becomes yours.<br> - <strong>Foul:</strong> Pocketing the cue ball returns one of your pocketed balls to the table.<br> - <strong>Foul:</strong> Hitting an opponent's ball first returns any of your balls pocketed on that shot.<br> - First to pocket all their balls wins! </p> </div> </div>
    <div id="poker-instructions" class="modal-overlay instruction-modal"> <div class="content"> <div class="play-button-container"> <button class="menu-button" id="play-poker-button">Play</button> </div> <h2>Poker Pool Rules</h2> <p> - You get 7 cards. Pocket balls matching your cards to win.<br> - A hand of all Kings is an automatic win.<br> - <strong>Cue Ball Foul:</strong> Pocketing the cue ball forces you to draw a penalty card.<br> - <strong>Last Ball Foul:</strong> If you scratch on your last ball, you draw a card. A King wins the game, otherwise, play continues with the new card.<br> - A penalty card matching a pocketed ball is discarded. </p> </div> </div>
    <div id="61-ball-instructions" class="modal-overlay instruction-modal"> <div class="content"> <div class="play-button-container"> <button class="menu-button" id="play-61-ball-button">Play</button> </div> <h2>61 Ball Rules</h2> <p> - The goal is to be the first to score 61 points.<br> - You must always hit the lowest numbered chip on the table first.<br> - Your score is the sum of the numbers on the chips you legally pocket.<br> - <strong>Example:</strong> Hit the 1-chip first, and the 15-chip is pocketed. You get 15 points.<br> - Your turn continues as long as you legally pocket a chip.<br> - <strong>Foul:</strong> Hitting the wrong chip first, or scratching the cue chip, ends your turn. Your opponent gets ball-in-hand. Any chips pocketed on a foul shot will be returned to the table. </p> </div> </div>
    <div id="poker-foul-card-pick-modal" class="modal-overlay"> <h2>Foul! Pick a card.</h2> <div id="poker-foul-cards"></div> </div>
    <div id="online-game-select" class="modal-overlay"> <span class="modal-close-btn" id="online-select-close-btn">&times;</span> <h2>Online: Select Game Type</h2> <button class="menu-button" id="online-poker-button">POKER POOL</button> <button class="menu-button" id="online-straight-ball-button">STRAIGHT BALL</button> <button class="menu-button" id="online-61-button">61 BALL</button> </div>
    
    <div id="online-menu" class="modal-overlay">
    <span class="modal-close-btn" id="online-menu-close-btn">&times;</span>
    <h2>Online Multiplayer</h2> 

    <div id="online-menu-columns">
        
        <div class="online-column" id="online-column-left">
            <button class="menu-button" id="create-game-button">Create Game (Private)</button>
            <button class="menu-button" id="join-game-button">Join Game</button>
            <input type="text" id="game-id-input" placeholder="Enter Game ID">
        </div>
        
        <div class="online-column" id="online-column-right">
             <button class="menu-button" id="find-match-button" style="background-color: rgba(23, 162, 184, 0.5);">Find Match</button>
             <p style="margin: 15px 0; font-size: 0.9em; color: rgba(255,255,255,0.7);">- OR -</p>
             <button class="menu-button back-button" id="online-back-button" style="display: none;">Back</button> 
             </div>

    </div> 
    
    </div>
Â  Â  <!-- === END PLAYER NAME UPDATE === -->
    <div id="waiting-room" class="modal-overlay"> <span class="modal-close-btn" id="waiting-room-close-btn">&times;</span> <h2>Waiting for Opponent...</h2> <p>Share this Game ID with your friend:</p> <div id="game-id-display" title="Click to copy"></div> </div>
    <div id="matchmaking-wait-modal" class="modal-overlay"> <span class="modal-close-btn" id="matchmaking-close-btn">&times;</span> <h2>Searching for an opponent...</h2> <div class="loader"></div> </div>
    
    <!-- == WINNER MODAL UPDATE == -->
    <div id="winner-modal" class="modal-overlay">
        <div class="winner-modal-content-wrapper">
            <div class="winner-text-and-buttons">
                <h2 id="winner-text"></h2>
                <!-- Button for AI Rematch (formerly Play Again) -->
                <button id="ai-rematch-button" style="display: none;">Rematch vs AI</button>
                <!-- Button to go back to Menu (New) -->
                <button id="back-to-menu-button" style="display: none;">Back to Menu</button>
                 <!-- Button for Online Rematch Request (Original, stays hidden for AI) -->
                <button id="rematch-button" class="menu-button">Request Rematch</button>
            </div>
            <div id="opponent-hand-reveal"></div>
        </div>
    </div>
    <!-- == END WINNER MODAL UPDATE == -->

    <div id="confirm-exit-modal" class="modal-overlay"> <h2>Are you sure you want to exit?</h2> <p>This will count as a loss if you are in an online game.</p> <div class="button-group"> <button id="confirm-exit-yes" class="menu-button confirm-button">Yes</button> <button id="confirm-exit-cancel" class="menu-button confirm-button">Cancel</button> </div> </div>
    <div id="leaderboard-modal" class="modal-overlay"> <div class="content"> <span class="modal-close-btn" id="leaderboard-close-btn">&times;</span> <h2>Top Players</h2> <table> <thead> <tr> <th>Rank</th> <th>Name</th> <th>Wins</th> </tr> </thead> <tbody id="leaderboard-body"> <tr><td colspan="3" style="text-align: center; padding: 20px;">Loading...</td></tr> </tbody> </table> </div> </div>

<div id="shop-modal" class="modal-overlay">
    <div class="content" style="width: 80%; max-width: 600px; max-height: 80vh;">

        <span class="modal-close-btn" id="shop-close-btn">&times;</span>

        <h2>ğŸ›’ Shop</h2>
        <p style="margin-top: -10px; margin-bottom: 10px;">
            Buy new cue sticks with your coins!
        </p>
        <div class="modal-coin-display" style="margin-bottom: 15px; font-size: 1.2em;">
            Your Coins: ğŸ’° <span class="coin-balance-display">0</span>
        </div>
        <div id="shop-items-container">
            

           <div class="shop-item">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="shop-item-preview" style="background-image: url('https://i.imgur.com/FYXWKhr.png');"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="shop-item-name">Default Cue</div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="shop-buy-button equipped" disabled>Equipped</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div> Â  Â  </div> </div> Â  Â  <div id="credits-container">
Â  Â  Â  Â  <p style="margin: 2px;">Gawa ni: DugZHak</p>
Â  Â  Â  Â  <p style="margin: 2px; font-size: 0.8em;">Music from GitHub</p>
Â  Â  </div>

Â  Â  Â  Â  <div id="tutorial-overlay" class="modal-overlay">
Â  Â  Â  Â  <div id="tutorial-highlight"></div>
Â  Â  Â  Â  <div id="tutorial-box">
Â  Â  Â  Â  Â  Â  <p id="tutorial-text"></p>
Â  Â  Â  Â  Â  Â  <button id="tutorial-next-btn">Next</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="vs-screen-modal" class="modal-overlay">
Â  Â  Â  Â  <div id="vs-content-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="vs-player-box" id="vs-player-1-box">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="vs-player-rank" id="vs-player-1-rank">[Master]</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="vs-player-name" id="vs-player-1-name">Player 1</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="vs-divider">VS</div>

Â  Â  Â  Â  Â  

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="vs-player-box" id="vs-player-2-box">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="vs-player-rank" id="vs-player-2-rank">[Hustler]</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="vs-player-name" id="vs-player-2-name">Player 2</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <h3 id="vs-game-mode">POKER POOL</h3>
Â  Â  </div>

</div>

    <div id="friends-modal" class="modal-overlay">
    <div class="content" style="width: 80%; max-width: 500px; max-height: 80vh;">
        
        <span class="modal-close-btn" id="friends-modal-close-btn">&times;</span>
        <h2>ğŸ¤ Friends List</h2>

        <div class="friends-search-container">
            <input type="text" id="friend-search-input" placeholder="Enter player name...">
            <button class="menu-button lobby-button" id="add-friend-btn">Add</button>
        </div>
        <div id="friend-search-results" class="friends-search-results">
            </div>

        <div class="friends-lists-wrapper">

            <h3 class="friends-subheader">Pending Requests</h3>
            <div id="friends-list-pending" class="friends-list-container">
                <div class="friend-item-empty">No pending requests.</div>
            </div>
    
            <h3 class="friends-subheader">My Friends</h3>
            <div id="friends-list-accepted" class="friends-list-container">
                <div class="friend-item-empty">You have no friends yet.</div>
            </div>

        </div> </div>
</div>

      <div id="invite-popup-modal" class="modal-overlay">
    <div class="content" style="width: 80%; max-width: 450px;">
        
        <h2 id="invite-popup-title" style="font-size: 2.2em; margin-bottom: 10px;">Game Invite!</h2>
        <p id="invite-popup-text" style="font-size: 1.2em; line-height: 1.5; margin-bottom: 25px;">
            Si [Player Name] ay iniimbita ka sa isang laro!
        </p>
        
        <div class="button-group">
             <button id="invite-accept-btn" class="menu-button confirm-button" style="background-color: #28a745; width: 150px;">Accept</button>
             <button id="invite-decline-btn" class="menu-button confirm-button" style="background-color: #dc3545; width: 150px;">Decline</button>
        </div>
        
    </div>
</div>

<div id="invite-wait-modal" class="modal-overlay">
    <span class="modal-close-btn" id="invite-wait-close-btn">&times;</span>
    <h2>Waiting for Friend</h2>
    <p id="invite-wait-text" style="font-size: 1.2em; margin-bottom: 20px;">
        Waiting for [Friend Name] to accept...
    </p>
    <div class="loader"></div>
</div>

<div id="invite-game-select" class="modal-overlay">
    <span class="modal-close-btn" id="invite-game-select-close-btn">&times;</span>
    <h2>Select Game Type</h2>
    <p style="font-size: 1.1em; margin-top: -10px; margin-bottom: 20px;">
        Anong laro ang gusto mong i-invite kay <strong id="invite-friend-name-display" style="color:var(--gold-accent)">...</strong>?
    </p>
    <button class="menu-button" id="invite-poker-button">POKER POOL</button>
    <button class="menu-button" id="invite-straight-ball-button">STRAIGHT BALL</button>
    <button class="menu-button" id="invite-61-button">61 BALL</button>
</div>
    
    <audio id="bg-music-reggae-1" src="https://arnoldtasipit66-wq.github.io/my-game-assets/mrbas-music-labs-roots-reggae-285790.mp3" crossorigin="anonymous" loop></audio>
    <audio id="bg-music-reggae-2" src="https://arnoldtasipit66-wq.github.io/my-game-assets/mrbas-music-labs-roots-reggae-285790.mp3" crossorigin="anonymous" loop></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, deleteDoc, serverTimestamp, increment, collection, query, orderBy, limit, getDocs, addDoc, runTransaction, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, onDisconnect, set } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";


                let db, auth, rtdb, firebaseInitialized = false, isAuthReady = false;

let tempInviteFriendUid = null;
let tempInviteFriendName = null;

        const musicPlayer1 = document.getElementById('bg-music-reggae-1'), musicPlayer2 = document.getElementById('bg-music-reggae-2'), muteButton = document.getElementById('mute-button');
        const backgroundPlaylist = [musicPlayer1, musicPlayer2];
const VIRTUAL_WIDTH = 970;
const VIRTUAL_HEIGHT = 500;
// Ilagay ito sa taas ng iyong script, kasama ng ibang global variables
let lastTime = 0;
        let accumulator = 0;
        const FIXED_DELTA_TIME_MS = 1000 / 60; // 60 updates per second (approx 16.67ms)
        const FIXED_DELTA_TIME_SEC = 1 / 60.0; // Gagamitin para sa physics
        const VELOCITY_MULTIPLIER = 60; // Para i-convert ang "power" sa speed
let playerTotalCurrency = 0;
const CURRENCY_NAME = "Coins"; // Pwede mong palitan ang pangalan
const REWARD_PER_BALL = 10;
const REWARD_WIN_BONUS = 100;
const REWARD_LOSE_CONSOLATION = 25;

// â–¼â–¼â–¼ SIMULA NG DAGDAG PARA SA XP SYSTEM â–¼â–¼â–¼

let playerLevel = 1;
let playerXP = 0;
let xpToNextLevel = 100; // XP na kailangan para mag-level 2

// Pwede mong i-adjust ang values na ito
const XP_PER_BALL = 10;
const XP_WIN_BONUS = 50;
const XP_LOSE_CONSOLATION = 15;
const LEVEL_UP_COIN_REWARD = 250; // Pabuya sa bawat level up

// â–¼â–¼â–¼ SIMULA NG RANKED TIERS (Step 1) â–¼â–¼â–¼
const RANKS = [
Â  Â  // index: 0
Â  Â  { name: "Beginner",Â  Â  Â  level: 1,Â  Â  color: "#CD7F32" }, // Bronze
Â  Â  // index: 1
Â  Â  { name: "Rookie",Â  Â  Â  Â  level: 10,Â  Â  color: "#C0C0C0" }, // Silver (BAGONG DAGDAG)
Â  Â  // index: 2
Â  Â  { name: "Hustler",Â  Â  Â  Â level: 25,Â  Â color: "#FFD700" }, // Gold (Inusog)
Â  Â  // index: 3
Â  Â  { name: "Master",Â  Â  Â  Â  level: 40,Â  Â color: "#50C878" }, // Emerald (Inusog)
Â  Â  // index: 4
Â  Â  { name: "Grand Master",Â  level: 75,Â  Â color: "#7DF9FF" }, // Diamond (Inusog)
Â  Â  // index: 5
Â  Â  { name: "Pro Legend",Â  Â  Â  Â  level: 100,Â  Â color: "#FFFFFF" }Â  // Puti/White (Bago)
];
// â–²â–²â–² DULO NG RANKED TIERS (Step 1) â–²â–²â–²

// Database ng mga binebenta sa shop (May Stats na)
const SHOP_ITEMS = {
Â  Â  cues: [
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  id: 'default',
Â  Â  Â  Â  Â  Â  name: 'Default Cue',
Â  Â  Â  Â  Â  Â  price: 0,
Â  Â  Â  Â  Â  Â  imageSrc: 'https://i.imgur.com/FYXWKhr.png',
Â  Â  Â  Â  Â  Â  displayWidth: 400,
Â  Â  Â  Â  Â  Â  displayHeight: 130,
Â  Â  Â  Â  Â  Â  stats: { Power: 2, Aim: 3, Spin: 1 } // <-- Stats (out of 10)
Â  Â  Â  Â  },
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  id: 'red_cue',
Â  Â  Â  Â  Â  Â  name: 'Red Rocket',
Â  Â  Â  Â  Â  Â  price: 7250,
Â  Â  Â  Â  Â  Â  imageSrc: 'https://i.imgur.com/yJZkUxs.png',
Â  Â  Â  Â  Â  Â  displayWidth: 450,
Â  Â  Â  Â  Â  Â  displayHeight: 70,
Â  Â  Â  Â  Â  Â  stats: { Power: 4, Aim: 5, Spin: 3 } // <-- Stats (out of 10)
Â  Â  Â  Â  },
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  id: 'blue_cue',
Â  Â  Â  Â  Â  Â  name: 'Dark Lightning',
Â  Â  Â  Â  Â  Â  price: 15350,
Â  Â  Â  Â  Â  Â  imageSrc: 'https://i.imgur.com/Nnw16gB.png',
Â  Â  Â  Â  Â  Â  displayWidth: 480,
Â  Â  Â  Â  Â  Â  displayHeight: 470,
Â  Â  Â  Â  Â  Â  stats: { Power: 6, Aim: 7, Spin: 5 } // <-- Stats (out of 10)
Â  Â  Â  Â  },
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  id: 'acc_special',Â 
Â  Â  Â  Â  Â  Â  name: 'ACC Special',Â 
Â  Â  Â  Â  Â  Â  price: 35550,Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  imageSrc: 'https://i.imgur.com/TCuxPKz.png',
Â  Â  Â  Â  Â  Â  displayWidth: 450,
Â  Â  Â  Â  Â  Â  displayHeight: 30,
Â  Â  Â  Â  Â  Â  stats: { Power: 8, Aim: 9, Spin: 8 } // <-- Stats (out of 10)
Â  Â  Â  Â  }
Â  Â  ]
};

// â–¼â–¼â–¼ IDAGDAG MO ITONG BAGONG FUNCTION â–¼â–¼â–¼

/**
 * Kinukuha ang stats object ng kasalukuyang naka-equip na tako.
 * Nagbibigay ng default stats kung sakaling may error.
 */
function getCurrentCueStats() {
    // Hanapin ang data ng cue na naka-equip
    const equippedCue = SHOP_ITEMS.cues.find(cue => cue.id === equippedItems.cue);

    // Kung nahanap, ibalik ang stats nito
    if (equippedCue && equippedCue.stats) {
        return equippedCue.stats;
    }

    // Kung hindi nahanap (e.g., error), ibalik ang pinakamahinang stats
    return { Power: 1, Aim: 1, Spin: 1 };
}

// â–²â–²â–² HANGGANG DITO â–²â–²â–²
// â–¼ IDAGDAG MO ITO â–¼
let opponentEquippedCueId = 'default'; // Para malaman kung anong tako gamit ng kalaban online
// â–² END NG DAGDAG â–²

// â–² END NG PAGPALIT â–²
// Dito ise-save ang mga nabili na
let playerInventory = {
    cues: ['default'] // Default na pagmamay-ari
};

// Dito ise-save ang gamit
let equippedItems = {
    cue: 'default'
};
// â–² END NG DAGDAG NA VARIABLES â–²
        let currentTrackIndex = Math.floor(Math.random() * backgroundPlaylist.length), musicHasStarted = false;     
const canvas = document.getElementById('game-canvas'), ctx = canvas.getContext('2d'), gameWrapper = document.getElementById('game-wrapper'), backgroundCanvas = document.createElement('canvas'), backgroundCtx = backgroundCanvas.getContext('2d'), messageBox = document.getElementById('message-box'), winnerModal = document.getElementById('winner-modal'), winnerText = document.getElementById('winner-text'), playerInfo = document.getElementById('player-info'), opponentInfo = document.getElementById('opponent-info'), powerControl = document.getElementById('power-control'), powerBar = document.getElementById('power-bar'), gameModeSelect = document.getElementById('game-mode-select'), /*difficultySelect = document.getElementById('difficulty-select'),*/ onlineMenu = document.getElementById('online-menu'), exitButton = document.getElementById('exit-button'), vsAiButton = document.getElementById('vs-ai-button'), onlineButton = document.getElementById('online-button'), createGameButton = document.getElementById('create-game-button'), joinGameButton = document.getElementById('join-game-button'), gameIdInput = document.getElementById('game-id-input'), /*difficultyBackButton = document.getElementById('difficulty-back-button'),*/  cardHandContainer = document.getElementById('card-hand-container'), opponentHandReveal = document.getElementById('opponent-hand-reveal'),
            // == WINNER MODAL BUTTONS ==
            aiRematchButton = document.getElementById('ai-rematch-button'), // Updated ID
            backToMenuButton = document.getElementById('back-to-menu-button'), // New button
            // == END WINNER MODAL BUTTONS ==
            aiMenu = document.getElementById('ai-menu'), aiStraightBallButton = document.getElementById('ai-straight-ball-button'), aiPokerButton = document.getElementById('ai-poker-button'), ai61Button = document.getElementById('ai-61-button'),  straightBallInstructions = document.getElementById('straight-ball-instructions'), pokerInstructions = document.getElementById('poker-instructions'), sixtyOneInstructions = document.getElementById('61-ball-instructions'), playStraightBallButton = document.getElementById('play-straight-ball-button'), playPokerButton = document.getElementById('play-poker-button'), play61BallButton = document.getElementById('play-61-ball-button'), cueBallGuide = document.getElementById('cue-ball-guide'), waitingRoom = document.getElementById('waiting-room'), gameIdDisplay = document.getElementById('game-id-display'),  onlineGameSelect = document.getElementById('online-game-select'), onlinePokerButton = document.getElementById('online-poker-button'), onlineStraightBallButton = document.getElementById('online-straight-ball-button'), online61Button = document.getElementById('online-61-button'),  confirmExitModal = document.getElementById('confirm-exit-modal'), confirmExitYes = document.getElementById('confirm-exit-yes'), confirmExitCancel = document.getElementById('confirm-exit-cancel'), pektusControl = document.getElementById('pektus-control'), pektusDot = document.getElementById('pektus-dot'), leftArrow = document.getElementById('left-arrow'), rightArrow = document.getElementById('right-arrow'), fullscreenButton = document.getElementById('fullscreen-button'), pokerFoulCardPickModal = document.getElementById('poker-foul-card-pick-modal'), pokerFoulCardsContainer = document.getElementById('poker-foul-cards'), leaderboardModal = document.getElementById('leaderboard-modal'), leaderboardButton = document.getElementById('leaderboard-button'),  leaderboardBody = document.getElementById('leaderboard-body'), 
shopModal = document.getElementById('shop-modal'),
dailyRewardModal = document.getElementById('daily-reward-modal'),
ghostHand = document.getElementById('ghost-hand'),
            
            // === START PLAYER NAME UPDATE ===
            playerNameInput = document.getElementById('player-name-input'),
            // === END PLAYER NAME UPDATE ===

            dragGuideText = document.getElementById('drag-guide-text'), findMatchButton = document.getElementById('find-match-button'), matchmakingWaitModal = document.getElementById('matchmaking-wait-modal'),  chatContainer = document.getElementById('chat-container'), chatMessages = document.getElementById('chat-messages'), chatInput = document.getElementById('chat-input'), chatSendBtn = document.getElementById('chat-send-btn'), cueStickElement = document.getElementById('cue-stick-element'); 
        
        // START: Tutorial variables
        const tutorialOverlay = document.getElementById('tutorial-overlay');
        const tutorialHighlight = document.getElementById('tutorial-highlight');
        const tutorialBox = document.getElementById('tutorial-box');
        const tutorialText = document.getElementById('tutorial-text');
        const tutorialNextBtn = document.getElementById('tutorial-next-btn');
        let isTutorialActive = false;
        let tutorialStep = 0;
        let tutorialSteps = [];
        const interactiveElements = [canvas, powerControl, pektusControl, leftArrow, rightArrow];
        // END: Tutorial variables

        const TABLE_ASPECT_RATIO = 1.94, 
Â  Â  Â  Â BALL_RADIUS = 18,Â  Â  Â // <-- Pinalitan galing 16
Â  Â  Â  Â  Â  Â  Â  CUE_BALL_RADIUS = 20,Â  // <-- Pinalitan galing 18
Â  Â  Â  Â  Â  Â  Â  HOLE_RADIUS = 38,Â  Â  // <-- Pinalitan galing 35
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  // â–¼â–¼â–¼ IDAGDAG MO ITO â–¼â–¼â–¼
Â  Â  Â  Â  Â  Â  Â  CUE_CHIP_MASS = 3.5,     // Bigat ng Cue Chip (mas mabigat)
Â  Â  Â  Â  Â  Â  Â  OBJECT_CHIP_MASS = 1.0,  // Bigat ng Object Chip (mas magaan)
              
              // â–¼â–¼â–¼ IDAGDAG MO ITO â–¼â–¼â–¼
              COLLISION_FRICTION = 0.5, // 0 = Walang preno sa banggaan, 1 = Sobrang preno
              // â–²â–²â–² HANGGANG DITO â–²â–²â–²

              // Ang 'FRICTION' na ito ay ibig sabihin na pagkatapos ng 1 segundo,

Â  Â  Â  Â  Â  Â  Â  // Ang 'FRICTION' na ito ay ibig sabihin na pagkatapos ng 1 segundo,
Â  Â  Â  Â  Â  Â  Â  // ang bilis ng picha ay 10% na lang ng original.
Â  Â  Â  Â  Â  Â  Â  FRICTION_PER_SECOND = 0.3, // <-- ITO ANG PALIT SA 'FRICTION'
Â  Â  Â  Â  Â  Â  Â  MIN_VELOCITY = 0.5, // <-- ITO ANG PALIT SA 'MIN_VELOCITY'
Â  Â  Â  Â  Â  Â  Â  MIN_ROTATION_SPEED = 0.01,Â 
Â  Â  Â  Â  Â  Â  Â  ROTATION_SPEED = 0.001,
Â  Â  Â  Â  Â  Â  Â  TOUCH_AIM_SENSITIVITY = 0.00001;
        
        // START: SPINNING CHIP UPDATE (Nagdagdag ng spin friction)
        const SPIN_FRICTION_PER_SECOND = 0.15;
        const WALL_SPIN_FACTOR = 0.005; // Lakas ng spin galing sa pader
        const COLLISION_SPIN_FACTOR = 0.03; // Lakas ng spin galing sa banggaan
        
        

        const aiChatter = { 'tl': { start: ["Good luck!", "Game na!", "Simulan na natin!"], goodShot: ["Ayos!", "chamba lang!", "Swabe!", "Pasok! ğŸ˜"], foul: ["Ay, sablay.ğŸ˜‚", "Sayang.ğŸ¥º", "Oops, mali.ğŸ¤­"], playerGoodShot: ["Wow, nice shot!ğŸ˜²", "Ang galing naman!", "Ganda ng tira mo!", "Hanep, smooth! ğŸ‘"], playerFoul: ["Sayang 'yon.", "Nangyayari talaga 'yan.", "Bawi na lang.", "Ayy, malas."], winning: ["Isa na lang!", "Malapit na...", "Mukhang akin na 'to."], lose: ["Good game! Ang galing mo!", "GG! Rematch?"], win: ["Good game! Salamat sa laro.", "Panalo!"] } };
        let isAiVoiceEnabled = true, scale = 1, table = { width: 0, height: 0 }, chips = [], holes = [], cueStick = { angle: 0, length: 10000, visible: true, power: 0, pullback: 0 }, gameState = 'menu', gameMode = 'ai-classic', playerTurn = true, colorsAssigned = false, playerChipsType = null, opponentChipsType = null, canMoveCueBall = false, chipsMoving = false, chipsPocketedInTurn = [], firstChipHitInTurn = null, isPoweringUp = false, isAimingOnCanvas = false, isDraggingCueBall = false, difficulty = 'pro', deck = [], playerHand = [], opponentHand = [], originalPlayerHand = [], originalOpponentHand = [], selectedGameConfig = {}, isBreakShot = false, pektusOffset = { x: 0, y: 0 }, shotPektusOffset = { x: 0, y: 0 }, isDraggingPektusDot = false, isRotatingLeft = false, isRotatingRight = false, isInvalidPlacement = false, player61Score = 0, opponent61Score = 0, lowestChipNumber = 1, aiConsecutivePots = 0;
let currentShotStats = { Power: 2, Aim: 3, Spin: 1 }; // Default stats, para lang may laman
// â–²â–²â–² HANGGANG DITO â–²â–²â–²
        let gameId = null, localPlayerId = null, localPlayerUid = null, currentTurnUid = null, unsubscribeGameListener, isOnlineGame = false, isMyTurnOnline = false, isProcessingTurnEnd = false, lastProcessedTurnId = -1, isSyncing = false, selectedOnlineGameType = 'poker', lastAimUpdateTime = 0;
        const AIM_UPDATE_INTERVAL = 50;
        let lastTurnControllerUid = null, unsubscribeFromQueue, matchmakingTimeoutId = null, isAiTakeoverActive = false;
        // --- Sound Variables ---
        let audioInitialized = false, chipCollisionSynth, pocketSynth, uiSynth, cueHitSynth, cushionSynth;
        let aimingSynth, powerSynth; // BAGONG synths
        let lastCollisionSoundTime = -1, lastCushionSoundTime = -1, lastAimSoundTime = -1, buttonSoundPlaying = false;
        let isPowerSoundPlaying = false;
        const AIM_SOUND_INTERVAL = 80; // Gaano kadalas tutunog ang aiming sound (milliseconds)
        // --- End Sound Variables ---
        const cueStickImage = new Image();
        cueStickImage.src = 'https://i.imgur.com/FYXWKhr.png';
const feltTextureImage = new Image();
        let unsubscribeFromChat, isInitialChatLoad = true;
        let legalTargetChipIds = new Set(); // <-- BAGONG DAGDAG para sa ring light

        // === START PLAYER NAME UPDATE ===
        let localPlayerName = "You";
        let opponentPlayerName = "Opponent";
        let opponentRankIndex = 0;
        let vsScreenShownThisGame = false;
        // === END PLAYER NAME UPDATE ===

        function init() {
    
    
Â  Â  Â  Â  Â  Â  resizeCanvas();

Â  Â  Â  Â  Â  Â  // --- MGA BAGONG DAGDAG ---
Â  Â  Â  Â  Â  Â  loadCurrency(); // I-load ang pera ng player
Â  Â  Â  Â  Â  Â  loadInventory(); // I-load ang mga nabiling tako
            loadPlayerStats();
Â  Â  Â  Â  Â  Â  applyEquippedItems(); // I-apply agad yung naka-equip na tako
Â  Â  Â  Â  Â  Â  const isReturningPlayer = loadPlayerName(); // I-load ang pangalan
Â  Â  Â  Â  Â  Â  // --- END NG DAGDAG ---

Â  Â  Â  Â  Â  Â  setupEventListeners(isReturningPlayer); // <-- NAGBAGO ITO!
Â  Â  Â  Â  Â  Â  initializeFirebase();
Â  Â  Â  Â  Â  Â  history.replaceState({ modal: 'start' }, 'Start', '#start');
Â  Â  Â  Â  Â  Â  requestAnimationFrame(update); // Ito na ang magsisimula ng game loop
Â  Â  Â  Â  }
        
        Â  Â  Â  Â  function startGame(mode, difficultyLevel = 'pro') {
Â  Â  Â  Â  Â  Â  // ITO ANG IPALIT MO:

showGameUI();
Â  Â  Â  Â  Â  Â  /* <-- LAGYAN MO NITO SA SIMULA
Â  Â  Â  Â  Â  Â  const needsTutorial = !localStorage.getItem('pinoyPoolTutorialCompleted');
Â  Â  Â  Â  Â  Â  // Tutorial triggers on any first AI game, regardless of (now removed) difficulty
Â  Â  Â  Â  Â  Â  if (needsTutorial && mode.startsWith('ai-')) {
Â  Â  Â  Â  Â  Â  Â  Â  startTutorial(mode, difficultyLevel);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  */  // <-- AT LAGYAN MO NITO SA DULO

Â  Â  Â  Â  Â  Â  

            resizeCanvas(); 
            const allModals = [gameModeSelect, aiMenu, /*difficultySelect,*/ straightBallInstructions, pokerInstructions, sixtyOneInstructions, onlineGameSelect, onlineMenu, waitingRoom, winnerModal, confirmExitModal, pokerFoulCardPickModal, leaderboardModal];
            allModals.forEach(modal => modal.classList.remove('show')); 
            gameMode = mode; 
            isOnlineGame = false; 
            difficulty = difficultyLevel; // Will be 'pro'
            cueBallGuide.style.display = 'none'; 
            dragGuideText.style.display = 'none'; 
            playerTurn = Math.random() < 0.5; 
            canMoveCueBall = false; 
            chipsMoving = false; 
            colorsAssigned = false; 
            playerChipsType = null; 
            opponentChipsType = null; 
            setupChips(); 
            isBreakShot = true; 
            canMoveCueBall = true; 
            gameState = 'moving'; 
            cueStick.visible = true; 
            if (playerTurn) { 
                showMessage("It's your turn to break!", 4000); 
                dragGuideText.style.display = 'block'; 
            } else { 
                showMessage("Opponent will break the balls.", 4000); 
                placeCueChipForAI(); 
            } 
            resetPektus(); 
            if (gameMode.includes('poker')) { 
                createDeck(); 
                dealCards(); 
                updateCardDisplay(); 
            } else if (gameMode.includes('61-ball')) { 
                player61Score = 0; 
                opponent61Score = 0; 
                lowestChipNumber = 1; 
                cardHandContainer.style.display = 'none'; 
            } else {
                cardHandContainer.style.display = 'none'; 
            }
            updateInfoBox(); // Tatawagin nito ang updateLegalTargetChips()
            history.pushState({ modal: 'game' }, 'Game', '#game');
setCueForCurrentTurn();
            if (gameMode.startsWith('ai')) { 
                setTimeout(() => { aiDisplayMessage(getAiChatMessage('start')); }, 1500); 
            } 
        }
        
        // === NEW FUNCTION FOR AI REMATCH ===
        function restartAiGame() {
            playButtonSound();
            winnerModal.classList.remove('show');
            // Reuse existing gameMode and difficulty
            resizeCanvas(); 
            playerTurn = Math.random() < 0.5; 
            canMoveCueBall = false; 
            chipsMoving = false; 
            colorsAssigned = false; 
            playerChipsType = null; 
            opponentChipsType = null; 
            setupChips(); 
            isBreakShot = true; 
            canMoveCueBall = true; 
            gameState = 'moving'; 
            cueStick.visible = true; 
            if (playerTurn) { 
                showMessage("Rematch! Your turn to break.", 4000); 
                dragGuideText.style.display = 'block'; 
            } else { 
                showMessage("Rematch! Opponent will break.", 4000); 
                placeCueChipForAI(); 
            } 
            resetPektus(); 
            if (gameMode.includes('poker')) { 
                createDeck(); 
                dealCards(); 
                updateCardDisplay(); 
            } else if (gameMode.includes('61-ball')) { 
                player61Score = 0; 
                opponent61Score = 0; 
                lowestChipNumber = 1; 
            }
            updateInfoBox(); // Will call updateLegalTargetChips()
            history.pushState({ modal: 'game' }, 'Game', '#game');
setCueForCurrentTurn(); // Update history state
             if (gameMode.startsWith('ai')) { 
                setTimeout(() => { aiDisplayMessage(getAiChatMessage('start')); }, 1500); 
            } 
        }
        // === END NEW FUNCTION ===


        function waitForCardPick() { return new Promise(resolve => { pokerFoulCardPickModal.classList.add('show'); pokerFoulCardsContainer.innerHTML = ''; const cardsToDraw = []; for (let i = 0; i < 5; i++) if (deck.length > 0) cardsToDraw.push(deck.splice(Math.floor(Math.random() * deck.length), 1)[0]); if (cardsToDraw.length === 0) { pokerFoulCardPickModal.classList.remove('show'); resolve(null); return; } cardsToDraw.forEach(card => { const cardDiv = document.createElement('div'); cardDiv.className = 'card face-down'; cardDiv.onclick = () => { playButtonSound(); cardDiv.classList.remove('face-down'); const color = (card.suit === 'â™¥' || card.suit === 'â™¦') ? '#ff0000' : '#212121'; cardDiv.innerHTML = `<span class="card-rank" style="color: ${color};">${card.rank}</span><span class="card-suit" style="color: ${color};">${card.suit}</span>`; pokerFoulCardsContainer.querySelectorAll('.card').forEach(c => { c.onclick = null; c.style.cursor = 'default'; }); setTimeout(() => { pokerFoulCardPickModal.classList.remove('show'); cardsToDraw.forEach(c => { if (c !== card) deck.push(c); }); resolve(card); }, 1500); }; pokerFoulCardsContainer.appendChild(cardDiv); }); }); }
        
        async function endGame(winnerTextMessage, finalGameData = null) {
Â  Â  if (gameState === 'gameover') return; // Siguraduhin na isang beses lang tatakbo

Â  Â  // === SIMULA NG BAGONG LOGIC ===
Â  Â  // 1. Gawin muna ang lahat ng calculations BAGO i-set ang 'gameover'
Â  Â  let bonus = 0;
Â  Â  let xpBonus = 0;
Â  Â  let reason = "";
Â  Â  let shouldSave = false;

Â  Â  if (!isOnlineGame) { // AI Game
Â  Â  Â  Â  if (winnerTextMessage.includes("You Win")) {
Â  Â  Â  Â  Â  Â  bonus = REWARD_WIN_BONUS;
Â  Â  Â  Â  Â  Â  reason = "You Win!";
Â  Â  Â  Â  Â  Â  xpBonus = XP_WIN_BONUS;
Â  Â  Â  Â  } else if (winnerTextMessage.includes("You Lose")) {
Â  Â  Â  Â  Â  Â  bonus = REWARD_LOSE_CONSOLATION;
Â  Â  Â  Â  Â  Â  reason = "Good Game!";
Â  Â  Â  Â  Â  Â  xpBonus = XP_LOSE_CONSOLATION;
Â  Â  Â  Â  }
Â  Â  Â  Â  shouldSave = true;
Â  Â  } else { // Online Game
Â  Â  Â  Â  if (winnerTextMessage.includes("You Win")) {
Â  Â  Â  Â  Â  Â  bonus = REWARD_WIN_BONUS;
Â  Â  Â  Â  Â  Â  reason = "Online Win!";
Â  Â  Â  Â  Â  Â  shouldSave = true;
Â  Â  Â  Â  Â  Â  xpBonus = XP_WIN_BONUS;
Â  Â  Â  Â  }
Â  Â  Â  Â  // Walang consolation prize para sa online loss
Â  Â  }

Â  Â  // 2. Ibigay ang coin bonus
Â  Â  if (bonus > 0) {
Â  Â  Â  Â  playerTotalCurrency += bonus;
Â  Â  Â  Â  showRewardPopup(bonus, reason);
Â  Â  }

Â  Â  // 3. Kunin ang level bago ibigay ang XP bonus
Â  Â  const levelBeforeBonus = playerLevel;

Â  Â  // 4. Ibigay ang XP bonus (GAGANA NA ITO DAHIL HINDI PA 'gameover')
Â  Â  if (xpBonus > 0) {
Â  Â  Â  Â  gainXP(xpBonus);
Â  Â  }

Â  Â  // 5. TINGNAN KUNG NAG-LEVEL UP DAHIL SA BONUS
Â  Â  const levelAfterBonus = playerLevel;
Â  Â  const didLevelUp = levelAfterBonus > levelBeforeBonus;

Â  Â  // 6. NGAYON PA LANG natin ise-set ang gameState sa 'gameover'
Â  Â  gameState = 'gameover'; // <--- INILIPAT SA BABA!

Â  Â  if (shouldSave) {
Â  Â  Â  Â  localStorage.setItem('pinoyPoolCurrency', playerTotalCurrency.toString());
Â  Â  }
Â  Â  updateCurrencyDisplay();
Â  Â  updateLegalTargetChips(); // I-clear ang mga highlights

Â  Â  // 7. Ihanda ang winner modal text (gaya ng dati)
Â  Â  let finalWinnerText = winnerTextMessage;
Â  Â  if (gameMode.includes('61-ball')) {
Â  Â  Â  Â  const mainMessage = winnerTextMessage.split('.')[0];Â 
Â  Â  Â  Â  finalWinnerText = `${mainMessage}`;
Â  Â  Â  Â  winnerText.innerHTML = `${finalWinnerText}<br><span style="font-size: 0.6em; font-weight: normal; color: #eee;">Final Score: ${player61Score} - ${opponent61Score}</span>`;
Â  Â  } else {
Â  Â  Â  Â  winnerText.textContent = finalWinnerText;
Â  Â  }

Â  Â  // 8. Ihanda ang mga buttons (gaya ng dati)
Â  Â  const onlineRematchButton = document.getElementById('rematch-button');
Â  Â  if (isOnlineGame) {
Â  Â  Â  Â  if (winnerTextMessage.includes("You Win")) {
Â  Â  Â  Â  Â  Â  updatePlayerData(localPlayerUid, true);
Â  Â  Â  Â  }
Â  Â  Â  Â  aiRematchButton.style.display = 'none';
Â  Â  Â  Â  backToMenuButton.style.display = 'block';
Â  Â  Â  Â  onlineRematchButton.style.display = 'block';
Â  Â  Â  Â  onlineRematchButton.disabled = false;
Â  Â  Â  Â  onlineRematchButton.textContent = 'Request Rematch';
Â  Â  } else {
Â  Â  Â  Â  aiRematchButton.style.display = 'block';
Â  Â  Â  Â  backToMenuButton.style.display = 'block';
Â  Â  Â  Â  onlineRematchButton.style.display = 'none';
Â  Â  Â  Â  if (winnerTextMessage.includes("You Win") && gameMode.startsWith("ai-")) {
Â  Â  Â  Â  Â  Â  updatePlayerData(localPlayerUid, true);
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // 9. Ihanda ang card reveal (gaya ng dati)
Â  Â  if (gameMode.includes('poker')) {
Â  Â  Â  Â  opponentHandReveal.innerHTML = `<h4>${opponentPlayerName}'s Hand:</h4>`;

Â  Â  Â  Â  let opponentsOriginalHand, opponentsFinalHand;

Â  Â  Â  Â  if (isOnlineGame) {
Â  Â  Â  Â  Â  Â  const gameData = finalGameData || (await getDoc(doc(db, "games", gameId))).data();
Â  Â  Â  Â  Â  Â  if (gameData) {
Â  Â  Â  Â  Â  Â  Â  Â  opponentsOriginalHand = localPlayerId === 'player1' ? gameData.originalPlayer2Hand : gameData.originalPlayer1Hand;
Â  Â  Â  Â  Â  Â  Â  Â  opponentsFinalHand = localPlayerId === 'player1' ? gameData.player2Hand : gameData.player1Hand;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  opponentsOriginalHand = [];
Â  Â  Â  Â  Â  Â  Â  Â  opponentsFinalHand = [];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  opponentsOriginalHand = originalOpponentHand;
Â  Â  Â  Â  Â  Â  opponentsFinalHand = opponentHand;
Â  Â  Â  Â  }

Â  Â  Â  Â  if(!opponentsOriginalHand || !opponentsFinalHand) return;

Â  Â  Â  Â  const pocketedCards = opponentsOriginalHand.filter(originalCard =>Â 
Â  Â  Â  Â  Â  Â  !opponentsFinalHand.some(finalCard =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  finalCard.rank === originalCard.rank && finalCard.suit === originalCard.suit
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  );

Â  Â  Â  Â  const createCardElement = (card) => {
Â  Â  Â  Â  Â  Â  const cardDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  cardDiv.className = 'card';
Â  Â  Â  Â  Â  Â  const color = (card.suit === 'â™¥' || card.suit === 'â™¦') ? '#D32F2F' : '#212121';
Â  Â  Â  Â  Â  Â  cardDiv.innerHTML = `<span class="card-rank" style="color: ${color};">${card.rank}</span><span class="card-suit" style="color: ${color};">${card.suit}</span>`;
Â  Â  Â  Â  Â  Â  return cardDiv;
Â  Â  Â  Â  };

Â  Â  Â  Â  if (pocketedCards.length > 0) {
Â  Â  Â  Â  Â  Â  const pocketedContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  pocketedContainer.innerHTML = '<p style="margin: 10px 0 5px 0;">Pocketed:</p>';
Â  Â  Â  Â  Â  Â  const pocketedCardsDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  pocketedCardsDiv.style.cssText = 'display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;';
Â  Â  Â  Â  Â  Â  pocketedCards.forEach(card => pocketedCardsDiv.appendChild(createCardElement(card)));
Â  Â  Â  Â  Â  Â  pocketedContainer.appendChild(pocketedCardsDiv);
Â  Â  Â  Â  Â  Â  opponentHandReveal.appendChild(pocketedContainer);
Â  Â  Â  Â  }

Â  Â  Â  Â  if (opponentsFinalHand.length > 0) {
Â  Â  Â  Â  Â  Â  const remainingContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  remainingContainer.innerHTML = '<p style="margin: 10px 0 5px 0;">Remaining:</p>';
Â  Â  Â  Â  Â  Â  const remainingCardsDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  remainingCardsDiv.style.cssText = 'display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;';
Â  Â  Â  Â  Â  Â  opponentsFinalHand.forEach(card => remainingCardsDiv.appendChild(createCardElement(card)));
Â  Â  Â  Â  Â  Â  remainingContainer.appendChild(remainingCardsDiv);
Â  Â  Â  Â  Â  Â  opponentHandReveal.appendChild(remainingContainer);
Â  Â  Â  Â  }

Â  Â  Â  Â  opponentHandReveal.style.display = 'flex';
Â  Â  } else if (gameMode.includes('61-ball')) {
Â  Â  Â  Â  opponentHandReveal.innerHTML = `
Â  Â  Â  Â  Â  Â  <div style="text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Final Score</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 1.4em; margin: 10px 0; color: white;">${localPlayerName}: <span style="font-weight: bold; color: var(--gold-accent);">${player61Score}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 1.4em; margin: 10px 0; color: white;">${opponentPlayerName}: <span style="font-weight: bold; color: var(--gold-accent);">${opponent61Score}</span></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  opponentHandReveal.style.display = 'flex';
Â  Â  } else {
Â  Â  Â  Â  opponentHandReveal.innerHTML = '';
Â  Â  Â  Â  opponentHandReveal.style.display = 'none';
Â  Â  }
Â  Â Â 
Â  Â  // 10. (PINAKA-MAHALAGA) I-delay ang pagpakita ng Winner Modal
Â  Â  // 2.5 segundo (2500ms) kung nag-level up, 0.5 segundo (500ms) kung hindi.
Â  Â  const showWinnerModalDelay = didLevelUp ? 2500 : 500; 

Â  Â  setTimeout(() => {
Â  Â  Â  Â  winnerModal.classList.add('show');
Â  Â  Â  Â  history.pushState({ modal: 'winner' }, 'Winner', '#winner');
Â  Â  }, showWinnerModalDelay);
}

async function resetToMenu() {
    playButtonSound();
    document.getElementById('chat-toggle-button').style.display = 'none';
    chatContainer.style.display = 'none';
    if (unsubscribeFromChat) unsubscribeFromChat();
    if (isOnlineGame) await leaveOnlineGame(false); // Disconnect but don't force forfeit via UI

    opponentPlayerName = "Opponent"; // Reset opponent name

    // Updated list of modals to hide
    const modalsToHide = [
        winnerModal, aiMenu, onlineMenu, onlineGameSelect, waitingRoom,
        straightBallInstructions, pokerInstructions, sixtyOneInstructions,
        confirmExitModal, leaderboardModal, shopModal, dailyRewardModal,
        matchmakingWaitModal, pokerFoulCardPickModal, tutorialOverlay
    ];
    modalsToHide.forEach(m => {
         if (m) m.classList.remove('show');
    });

    // --- Eto na yung pagpapakita ng Lobby ---
    showLobbyUI(); // <-- Ito na ang nagpapakita ng lobby buttons/view

    if (unsubscribeGameListener) {
        unsubscribeGameListener();
        unsubscribeGameListener = null;
    }

    gameState = 'lobby'; // <-- State ay lobby na

    // Reset game-specific variables
    isOnlineGame = false;
    gameId = null;
    localPlayerId = null;
    isAiTakeoverActive = false;
    playerHand = [];
    opponentHand = [];
    originalPlayerHand = [];
    originalOpponentHand = [];
    playerChipsType = null;
    opponentChipsType = null;
    colorsAssigned = false;
    player61Score = 0;
    opponent61Score = 0;
    lowestChipNumber = 1;
    canMoveCueBall = false;
    isBreakShot = false;
    opponentPlayerName = "Opponent"; 
Â  Â  opponentRankIndex = 0; // <-- Idagdag mo na rin ito para malinis
Â  Â  vsScreenShownThisGame = false; // <-- â— IDAGDAG MO ITO

    updateCardDisplay(); // Clear card display
    updateLegalTargetChips(); // Clear highlights

    // **MAHALAGA:** Hindi na natin binubura yung 'chips' array dito
    draw(); // Redraw ang lobby state

    history.pushState({ modal: 'lobby' }, 'Lobby', '#lobby'); // <-- History state ay lobby na

    updateDailyRewardButtonState(); // Update reward button state
    const cueEl = document.getElementById('cue-stick-element');
    if(cueEl) cueEl.style.display = 'none';
}

// â–¼â–¼â–¼ ITO ANG IPALIT MO SA LUMANG onpopstate (PART F) â–¼â–¼â–¼

window.onpopstate = (event) => {
    // --- Exit confirmation logic ---
    const isActiveGameState = gameState !== 'lobby' && gameState !== 'menu' && gameState !== 'gameover' && gameState !== 'modal_open';
    const isModalOverlayVisible = Array.from(document.querySelectorAll('.modal-overlay:not(#start-overlay)')).some(m => m.classList.contains('show'));

    if (isActiveGameState && !isModalOverlayVisible) {
         showExitConfirmation();
         history.pushState({ modal: 'game' }, 'Game', '#game');
         return;
    }
    // --- End Exit Confirmation ---

    const state = event.state || { modal: 'lobby' }; // Default state is now lobby

    // Define all modals
    const allModals = {
        aiMenu: document.getElementById('ai-menu'),
        straightBallInstructions: document.getElementById('straight-ball-instructions'),
        pokerInstructions: document.getElementById('poker-instructions'),
        sixtyOneInstructions: document.getElementById('61-ball-instructions'),
        onlineGameSelect: document.getElementById('online-game-select'),
        onlineMenu: document.getElementById('online-menu'),
        waitingRoom: document.getElementById('waiting-room'),
        matchmakingWaitModal: document.getElementById('matchmaking-wait-modal'),
        winnerModal: document.getElementById('winner-modal'),
        confirmExitModal: document.getElementById('confirm-exit-modal'),
        pokerFoulCardPickModal: document.getElementById('poker-foul-card-pick-modal'),
        leaderboardModal: document.getElementById('leaderboard-modal'),
        shopModal: document.getElementById('shop-modal'),
        dailyRewardModal: document.getElementById('daily-reward-modal'),
        tutorialOverlay: document.getElementById('tutorial-overlay'),
        friendsModal: document.getElementById('friends-modal'),
        
        invitePopupModal: document.getElementById('invite-popup-modal'), 
        inviteWaitModal: document.getElementById('invite-wait-modal'),
        inviteGameSelect: document.getElementById('invite-game-select') // <-- IDAGDAG ITO
Â  Â  };
Â  Â  
    // --- Hide everything first ---
    Object.values(allModals).forEach(modal => { if (modal) modal.classList.remove('show') });
    hideLobbyUI();
    const gameControls = ['power-control', 'pektus-control', 'left-arrow', 'right-arrow', 'exit-button', 'player-info', 'opponent-info', 'card-hand-container', 'cue-stick-element', 'chat-toggle-button'];
     gameControls.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
    cueBallGuide.style.display = 'none';
    dragGuideText.style.display = 'none';
    // --- End Hiding ---

    // --- Show the correct view based on the state ---
    if (state.modal === 'lobby') {
        showLobbyUI();
        gameState = 'lobby';
         draw();
    } else if (state.modal === 'game') {
        showGameUI();
         if (gameState !== 'shooting' && gameState !== 'evaluating' && gameState !== 'shooting_animation') {
            gameState = 'aiming';
        }
         draw();
    } else if (allModals[state.modal]) {
        allModals[state.modal].classList.add('show');
         // Keep lobby buttons visible underneath certain modals
         if (state.modal === 'shopModal' || state.modal === 'leaderboardModal' || state.modal === 'dailyRewardModal' || state.modal === 'aiMenu' || state.modal === 'onlineGameSelect' || state.modal === 'onlineMenu') {
             const lobbyContainer = document.getElementById('lobby-buttons-container');
             if (lobbyContainer) lobbyContainer.style.display = 'flex';
         }
         gameState = 'modal_open';
         draw();
    } else {
        // Fallback
        showLobbyUI();
        gameState = 'lobby';
        draw();
    }

    updateDailyRewardButtonState(); // Ensure reward button is up-to-date
};

// â–²â–²â–² HANGGANG DITO (PART F) â–²â–²â–²

// â–²â–²â–² HANGGANG DITO (PART F) â–²â–²â–²
        function showExitConfirmation() { playButtonSound(); if (gameState !== 'menu' && gameState !== 'gameover' && !confirmExitModal.classList.contains('show')) { confirmExitModal.classList.add('show'); } }
        
        async function forfeitOnlineGame() {
            if (!isOnlineGame || !gameId) {
                endGame("You Forfeited. Opponent Wins!"); // Fallback for safety
                return;
            }

            const gameDocRef = doc(db, "games", gameId);
            try {
                const gameData = (await getDoc(gameDocRef)).data();
                if (gameData && gameData.gameState !== 'finished') {
                    const opponentId = localPlayerId === 'player1' ? 'player2' : 'player1';
                    const winnerUid = gameData.players[opponentId]?.uid;

                    if (winnerUid) {
                        await updateDoc(gameDocRef, {
                            gameState: 'finished',
                            winner: winnerUid,
                            [`players.${localPlayerId}.status`]: 'forfeited' 
                        });
                    }
                }
            } catch (error) {
                console.error("Error forfeiting game:", error);
            } finally {
                // This will be displayed, but the listener will soon get the final state and call endGame again.
                // This is fine and provides immediate feedback to the forfeiting player.
                endGame("You Forfeited. Opponent Wins!"); 
            }
        }

        // === START PLAYER NAME UPDATE ===
        // Bagong function para i-manage ang pangalan
        function updateAndSavePlayerName() {
            const newName = playerNameInput.value.trim();
            if (newName && newName !== "") {
                localPlayerName = newName;
                localStorage.setItem('pinoyPoolPlayerName', newName);
            } else {
                // Kung walang laman, bigyan ng default
                localPlayerName = "Guest" + Math.floor(Math.random() * 1000);
                playerNameInput.value = localPlayerName; // I-update din ang input box
                localStorage.setItem('pinoyPoolPlayerName', localPlayerName);
            }
            return localPlayerName;
        }
        // === END PLAYER NAME UPDATE ===

function setupEventListeners(isReturningPlayer) { // <-- NAGBAGO ITO!
Â  Â  const startOverlay = document.getElementById('start-overlay');
    const startPromptText = document.getElementById('start-prompt-text');
    const startNameInputArea = document.getElementById('start-name-input-area');
    const startNameInput = document.getElementById('start-player-name-input');
    const startNameSubmitBtn = document.getElementById('start-name-submit-btn');

    // Function para ituloy papuntang lobby
    async function proceedToLobby(playerName) {
        console.log("proceedToLobby function CALLED with name:", playerName); // Debug log
        if (!playerName) {
             console.error("Proceeding to lobby without player name!");
             localPlayerName = "Player"; // Fallback name
        } else {
            localPlayerName = playerName; // Set the name variable for the current session's use
        }

        // Start Audio Context
        try {
            if (!audioInitialized) {
                console.log("Initializing audio in proceedToLobby..."); // Debug log
                await initAudio();
            }
            if (audioInitialized) {
                 console.log("Playing background music..."); // Debug log
                 playBackgroundMusic();
            } else {
                 console.log("Audio still not initialized after initAudio call."); // Debug log
            }
        } catch (audioError) {
            console.error("Error initializing or playing audio:", audioError);
        }

        console.log("Hiding start overlay..."); // Debug log
        startOverlay.classList.remove('show');
        console.log("Showing lobby UI..."); // Debug log
        showLobbyUI();
        console.log("Replacing history state..."); // Debug log
        history.replaceState({ modal: 'lobby' }, 'Lobby', '#lobby');

        // Show welcome message only once after setting name
        if (!localStorage.getItem('pinoyPoolPlayerNameWasSet')) {
             console.log("Showing welcome message..."); // Debug log
             showMessage(`Welcome to Pinoy Pool, ${localPlayerName}!`, 4000);
             localStorage.setItem('pinoyPoolPlayerNameWasSet', 'true');
        }

        console.log("Loading last claim time..."); // Debug log
        loadLastClaimTime();
        console.log("Updating info box..."); // Debug log
        updateInfoBox();
        console.log("proceedToLobby finished."); // Debug log
createPlayerDocument();
    }

    // --- BAGO AT MAS MALINIS NA LOGIC ---
Â  Â  if (isReturningPlayer) { // Gagamitin na natin yung variable galing sa init()
Â  Â  Â  Â  // Kung returning player
Â  Â  Â  Â  startPromptText.style.display = 'block'; // Show "Click anywhere" prompt
Â  Â  Â  Â  startNameInputArea.style.display = 'none'; // Hide the name input area

Â  Â  Â  Â  console.log("Attaching CLICK listener to startOverlay for returning player...");
Â  Â  Â  Â  // Add listener for returning player to click anywhere
Â  Â  Â  Â  startOverlay.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â console.log("Start overlay CLICKED (returning player)!");
Â  Â  Â  Â  Â  Â  Â if (startOverlay.classList.contains('show')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.log("Overlay is shown, proceeding to lobby...");
Â  Â  Â  Â  Â  Â  Â  Â  Â proceedToLobby(localPlayerName); // Gagamitin na yung na-load na pangalan
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Overlay not shown, click ignored.");
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }, { once: true }); // Listener runs only once

Â  Â  } else {
Â  Â  Â  Â  // Kung new player
Â  Â  Â  Â  startPromptText.style.display = 'none'; // Hide "Click anywhere" prompt
Â  Â  Â  Â  startNameInputArea.style.display = 'block'; // Show the name input area
Â  Â  Â  Â  console.log("Attaching listeners for NEW player name input...");

Â  Â  Â  Â  // Function to handle name submission
Â  Â  Â  Â  const handleNameSubmit = () => {
Â  Â  Â  Â  Â  Â  console.log("handleNameSubmit function CALLED!");
Â  Â  Â  Â  Â  Â  const name = startNameInput.value.trim();
Â  Â  Â  Â  Â  Â  if (name) { // If name is not empty
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Name entered:", name);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('pinoyPoolPlayerName', name); // Save name permanently
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('pinoyPoolPlayerNameWasSet'); // Reset welcome message flag
Â  Â  Â  Â  Â  Â  Â  Â  proceedToLobby(name); // Proceed to lobby
Â  Â  Â  Â  Â  Â  } else { // If name is empty
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Name input was empty.");
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Please enter your name!", 2000);
Â  Â  Â  Â  Â  Â  Â  Â  startNameInput.focus(); // Focus back on input
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // Add listener to the Continue button
Â  Â  Â  Â  console.log("Attaching CLICK listener to Continue button...");
Â  Â  Â  Â  startNameSubmitBtn.addEventListener('click', handleNameSubmit);

Â  Â  Â  Â  // Add listener for Enter key in the input field
Â  Â  Â  Â  console.log("Attaching KEYUP listener to name input field...");
Â  Â  Â  Â  startNameInput.addEventListener('keyup', (event) => {
Â  Â  Â  Â  Â  Â  if (event.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Enter key pressed in name input.");
Â  Â  Â  Â  Â  Â  Â  Â  handleNameSubmit(); // Submit name on Enter key
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }
Â  Â  // --- END NG BAGO AT MAS MALINIS NA LOGIC ---
    // --- End of Start Overlay Logic ---
    // --- Basic UI Listeners ---
    muteButton.addEventListener('click', toggleMusic);
    fullscreenButton.addEventListener('click', toggleFullScreen);
    chatSendBtn.addEventListener('click', function() { sendMessage(); });
    chatInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') { sendMessage(); } });
    const chatToggleButton = document.getElementById('chat-toggle-button');
    chatToggleButton.addEventListener('click', () => { if (chatContainer.style.display === 'flex') { chatContainer.style.display = 'none'; } else { chatContainer.style.display = 'flex'; } });
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', resizeCanvas);
    window.addEventListener('beforeunload', () => { if (isOnlineGame) leaveOnlineGame(true); });

    // General Sound Listener for all buttons
    document.querySelectorAll('.menu-button, .ui-button, .icon-button, .back-button, .confirm-button, .shop-buy-button, .modal-close-btn').forEach(button => {
        if (!button.hasAttribute('data-sound-listener-added')) {
            button.addEventListener('click', playButtonSound);
            button.setAttribute('data-sound-listener-added', 'true');
        }
    });

    // --- Lobby Button Listeners ---
    vsAiButton.addEventListener('click', () => {
        hideLobbyUI();
        aiMenu.classList.add('show');
        history.pushState({ modal: 'aiMenu' }, 'AI Menu', '#ai');
    });

    onlineButton.addEventListener('click', () => {
        if (!isAuthReady) { showMessage("Connecting... Please wait.", 2000); return; }
        if (!firebaseInitialized) { showMessage("An internet connection is required for online mode.", 3000); return; }
        hideLobbyUI();
        onlineGameSelect.classList.add('show');
        history.pushState({ modal: 'onlineGameSelect' }, 'Online', '#online');
    });

    // ... (ibang event listeners) ...

leaderboardButton.addEventListener('click', showLeaderboard);
document.getElementById('shop-button').addEventListener('click', openShop);
document.getElementById('daily-reward-button').addEventListener('click', claimDailyReward);
document.getElementById('friends-button').addEventListener('click', openFriendsModal);
document.getElementById('add-friend-btn').addEventListener('click', searchAndAddFriend);
// --- Listeners para sa Invite Game Select Modal ---
document.getElementById('invite-poker-button').addEventListener('click', () => sendInvite('poker'));
document.getElementById('invite-straight-ball-button').addEventListener('click', () => sendInvite('straight-ball'));
document.getElementById('invite-61-button').addEventListener('click', () => sendInvite('61-ball'));

// Close button para sa invite select
document.getElementById('invite-game-select-close-btn').addEventListener('click', () => {
    document.getElementById('invite-game-select').classList.remove('show');
    // Gagamitin natin ang history.back() para gumana sa popstate
    history.back();
});
// â–²â–²â–² HANGGANG DITO â–²â–²â–²


    // --- AI Menu Listeners ---
    aiStraightBallButton.addEventListener('click', () => {
        selectedGameConfig.mode = 'ai-straight-ball';
        aiMenu.classList.remove('show');
        straightBallInstructions.classList.add('show');
        history.pushState({ modal: 'straightBallInstructions' }, 'Rules', '#rules');
    });
    aiPokerButton.addEventListener('click', () => {
        selectedGameConfig.mode = 'ai-poker';
        aiMenu.classList.remove('show');
        pokerInstructions.classList.add('show');
        history.pushState({ modal: 'pokerInstructions' }, 'Rules', '#rules');
    });
    ai61Button.addEventListener('click', () => {
        selectedGameConfig.mode = 'ai-61-ball';
        aiMenu.classList.remove('show');
        sixtyOneInstructions.classList.add('show');
        history.pushState({ modal: 'sixtyOneInstructions' }, 'Rules', '#rules');
    });

    // --- Instruction/Play Button Listeners ---
    playStraightBallButton.addEventListener('click', () => startGame(selectedGameConfig.mode, 'pro'));
    playPokerButton.addEventListener('click', () => startGame(selectedGameConfig.mode, 'pro'));
    play61BallButton.addEventListener('click', () => startGame(selectedGameConfig.mode, 'pro'));

    // --- Online Menu Listeners ---
    onlinePokerButton.addEventListener('click', () => { selectedOnlineGameType = 'poker'; onlineGameSelect.classList.remove('show'); onlineMenu.classList.add('show'); history.pushState({ modal: 'onlineMenu' }, 'Online Menu', '#online-menu'); });
    onlineStraightBallButton.addEventListener('click', () => { selectedOnlineGameType = 'straight-ball'; onlineGameSelect.classList.remove('show'); onlineMenu.classList.add('show'); history.pushState({ modal: 'onlineMenu' }, 'Online Menu', '#online-menu'); });
    online61Button.addEventListener('click', () => { selectedOnlineGameType = '61-ball'; onlineGameSelect.classList.remove('show'); onlineMenu.classList.add('show'); history.pushState({ modal: 'onlineMenu' }, 'Online Menu', '#online-menu'); });
    createGameButton.addEventListener('click', createOnlineGame);
    joinGameButton.addEventListener('click', joinOnlineGame);
    findMatchButton.addEventListener('click', findMatch);
    // Ang listener para sa 'cancelMatchmakingButton' ay tinanggal na at pinalitan ng 'matchmaking-close-btn'

    // --- "X" (Close) Button Listeners ---
Â  Â  const backButtonIds = [
Â  Â  Â  Â  'ai-menu-close-btn',
Â  Â  Â  Â  'online-select-close-btn',
Â  Â  Â  Â  'online-menu-close-btn',
Â  Â  Â  Â  'waiting-room-close-btn',
Â  Â  Â  Â  'leaderboard-close-btn',
Â  Â  Â  Â  'shop-close-btn',
Â  Â  Â  Â  'friends-modal-close-btn' // <-- â–¼â–¼â–¼ IDAGDAG MO ITO â–¼â–¼â–¼
Â  Â  ]; 

    backButtonIds.forEach(id => {
        const btn = document.getElementById(id);
        if (btn && !btn.hasAttribute('data-click-listener-added')) {
            btn.addEventListener('click', () => {
                // playButtonSound(); // Handled na ng general listener sa taas
                history.back();
            });
            btn.setAttribute('data-click-listener-added', 'true');
        }
    });

    // --- Special "X" (Close) Buttons ---
    const matchmakingCloseBtn = document.getElementById('matchmaking-close-btn');
    if (matchmakingCloseBtn && !matchmakingCloseBtn.hasAttribute('data-click-listener-added')) {
        matchmakingCloseBtn.addEventListener('click', cancelMatchmaking);
        matchmakingCloseBtn.setAttribute('data-click-listener-added', 'true');
    }

    const dailyRewardCloseBtn = document.getElementById('daily-reward-close-btn');
    if (dailyRewardCloseBtn && !dailyRewardCloseBtn.hasAttribute('data-click-listener-added')) {
        dailyRewardCloseBtn.addEventListener('click', closeDailyRewardModal);
        dailyRewardCloseBtn.setAttribute('data-click-listener-added', 'true');
    }

    const dailyRewardOkBtn = document.getElementById('daily-reward-ok-btn');
    if (dailyRewardOkBtn && !dailyRewardOkBtn.hasAttribute('data-click-listener-added')) {
        dailyRewardOkBtn.addEventListener('click', closeDailyRewardModal);
        dailyRewardOkBtn.setAttribute('data-click-listener-added', 'true');
    }

    // --- In-Game / Modal Specific Listeners ---
    exitButton.addEventListener('click', showExitConfirmation);
    gameIdDisplay.addEventListener('click', () => { navigator.clipboard?.writeText(gameIdDisplay.textContent).then(() => showMessage("Game ID copied!", 1500)); });
    confirmExitYes.addEventListener('click', async () => {
        confirmExitModal.classList.remove('show');
        if (gameState === 'gameover' || gameState === 'menu' || gameState === 'lobby') {
            resetToMenu();
            return;
        }
        if (isOnlineGame) {
            await forfeitOnlineGame();
        } else {
            await endGame("You Forfeited. Opponent Wins!");
        }
    });
    confirmExitCancel.addEventListener('click', () => { confirmExitModal.classList.remove('show'); });

    // Winner Modal buttons
    aiRematchButton.addEventListener('click', restartAiGame);
    backToMenuButton.addEventListener('click', resetToMenu);
    document.getElementById('rematch-button').addEventListener('click', handleRematchRequest);

    // Pointer Event Listeners
    interactiveElements.forEach(el => {
        if (el && !el.hasAttribute('data-pointer-listeners-added')) {
            el.addEventListener('mousedown', handlePointerDown);
            el.addEventListener('touchstart', handlePointerDown, { passive: false });
            el.setAttribute('data-pointer-listeners-added', 'true');
        }
    });
    window.addEventListener('mouseup', handlePointerUp);
    window.addEventListener('touchend', handlePointerUp);
    window.addEventListener('mousemove', handlePointerMove);
    window.addEventListener('touchmove', handlePointerMove, { passive: false });

    // AI Voice Toggle
    const voiceToggleButton = document.getElementById('voice-toggle-button');
    voiceToggleButton.addEventListener('click', toggleAiVoice);
    const savedVoiceSetting = localStorage.getItem('pinoyPoolAiVoice');
    if (savedVoiceSetting !== null) { isAiVoiceEnabled = (savedVoiceSetting === 'true'); }
    updateVoiceButtonIcon();

    // Tutorial Button
    tutorialNextBtn.addEventListener('click', nextTutorialStep);

    // --- Winner Modal Fade Logic ---
    const revealWinnerModal = () => { if(winnerModal) winnerModal.classList.remove('faded'); };
    const fadeWinnerModal = (e) => {
        const target = e.target;
        const buttonContainer = winnerModal.querySelector('.winner-text-and-buttons');
        if (buttonContainer && buttonContainer.contains(target) && target.tagName === 'BUTTON') {
            return;
        }
        if (winnerModal && winnerModal.classList.contains('show')) {
            winnerModal.classList.add('faded');
        }
    };
    if (winnerModal && !winnerModal.hasAttribute('data-fade-listeners-added')) {
        winnerModal.addEventListener('mousedown', fadeWinnerModal);
        winnerModal.addEventListener('touchstart', fadeWinnerModal, { passive: true });
        winnerModal.addEventListener('mouseup', revealWinnerModal);
        winnerModal.addEventListener('touchend', revealWinnerModal);
        winnerModal.addEventListener('mouseleave', revealWinnerModal);
        winnerModal.setAttribute('data-fade-listeners-added', 'true');
    }

}// <-- Dulo ng setupEventListeners

// â–²â–²â–² HANGGANG DITO (KUMPLETONG setupEventListeners FUNCTION) â–²â–²â–²

        function setupChatListener(gameIdForChat) { if (unsubscribeFromChat) { unsubscribeFromChat(); } chatMessages.innerHTML = ''; isInitialChatLoad = true; const chatToggleButton = document.getElementById('chat-toggle-button'); if(chatToggleButton) chatToggleButton.style.display = 'flex'; const messagesRef = collection(db, "games", gameIdForChat, "messages"); const q = query(messagesRef, orderBy("timestamp"), limit(200)); unsubscribeFromChat = onSnapshot(q, (snapshot) => { snapshot.docChanges().forEach(change => { if (change.type === 'added' && !isInitialChatLoad) { const messageData = change.doc.data(); if (messageData.senderId !== localPlayerUid && messageData.text) { showMessage(`${opponentPlayerName}: ${messageData.text}`, 5000); } } }); const allMessages = []; snapshot.docs.forEach(doc => allMessages.push(doc.data())); chatMessages.innerHTML = ''; allMessages.reverse().forEach(messageData => { const messageP = document.createElement('p'); messageP.textContent = messageData.text; if (messageData.senderId === localPlayerUid) { messageP.className = 'my-message'; } else { messageP.className = 'opponent-message'; } chatMessages.appendChild(messageP); }); isInitialChatLoad = false; }); }
        async function sendMessage() { const messageText = chatInput.value.trim(); if (messageText === '') { showMessage("ERROR: Hindi pwedeng walang laman ang message!", 3000); return; } if (isOnlineGame) { if (!gameId) { console.error("Cannot send message, no game ID."); return; } const messagesRef = collection(db, "games", gameId, "messages"); try { await addDoc(messagesRef, { text: messageText, senderId: localPlayerUid, timestamp: serverTimestamp() }); } catch (error) { showMessage("FIREBASE ERROR: Tingnan ang console.", 4000); console.error("Ang Firebase error ay:", error); } } else { const messageP = document.createElement('p'); messageP.textContent = messageText; messageP.className = 'my-message'; chatMessages.insertBefore(messageP, chatMessages.firstChild); } chatInput.value = ''; chatContainer.style.display = 'none'; }

        // Updated initAudio function
        function initAudio() {
            if (audioInitialized || typeof Tone === 'undefined') {
                return Promise.resolve();
            }
            return Tone.start().then(() => {
                // Existing Synths
                chipCollisionSynth = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 5, oscillator: { type: "triangle" }, envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.1, attackCurve: "exponential", }, }).toDestination();
                chipCollisionSynth.volume.value = -4;

                cueHitSynth = new Tone.PluckSynth({ attackNoise: 1, dampening: 2000, resonance: 0.5, }).toDestination();
                cueHitSynth.volume.value = -1;

                cushionSynth = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 4, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination();
                cushionSynth.volume.value = -10;

                pocketSynth = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.005, decay: 0.15, sustain: 0.1 } }).toDestination();
                pocketSynth.volume.value = -5;

                uiSynth = new Tone.PluckSynth({ attackNoise: 0.5, dampening: 4000, resonance: 0.8 }).toDestination();
                uiSynth.volume.value = -4;

                // --- BAGONG Synths ---
                aimingSynth = new Tone.MetalSynth({
                    frequency: 300,
                    envelope: { attack: 0.001, decay: 0.05, release: 0.05 },
                    harmonicity: 3.1,
                    modulationIndex: 16,
                    resonance: 2000,
                    octaves: 0.5
                }).toDestination();
                aimingSynth.volume.value = -25; // Mahina lang dapat

                powerSynth = new Tone.AMSynth({
                    harmonicity: 1.5,
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 },
                    modulationEnvelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 }
                }).toDestination();
                powerSynth.volume.value = -15; // Medyo mahina para hindi masakit sa tenga
                // --- End BAGONG Synths ---


                audioInitialized = true;
                console.log("Tone.js audio context started successfully.");
            }).catch(e => {
                console.error("Could not start Tone.js audio context:", e);
                audioInitialized = false;
            });
        }

        async function playButtonSound() {
             if (buttonSoundPlaying) return;
             // Ensure audio is initialized, especially if this is the first interaction
             if (!audioInitialized) await initAudio();
             if (!audioInitialized || !uiSynth) {
                console.log("Cannot play button sound: Audio not ready or synth missing.");
                return;
             }
             buttonSoundPlaying = true;
             try {
                uiSynth.triggerAttackRelease("C5", "8n", Tone.now());
             } catch (e) {
                 console.error("Error playing button sound:", e);
             }
             setTimeout(() => { buttonSoundPlaying = false; }, 50); // Prevent rapid re-triggering
        }

        async function playAimingSound() {
             if (!audioInitialized || !aimingSynth) return;
             const now = Tone.now();
             if (now < lastAimSoundTime + (AIM_SOUND_INTERVAL / 1000)) return; // Throttle the sound
             lastAimSoundTime = now;
             try {
                 // Adjust frequency slightly for variation
                 const freq = 200 + Math.random() * 50;
                 aimingSynth.frequency.setValueAtTime(freq, now);
                 aimingSynth.triggerAttackRelease("32n", now);
             } catch (e) {
                 console.error("Error playing aiming sound:", e);
             }
        }

        async function playPowerSound(powerLevel) { // powerLevel is 0 to 1
             if (!audioInitialized || !powerSynth) return;
             const now = Tone.now();
             const minFreq = 100;
             const maxFreq = 600;
             const freq = minFreq + (maxFreq - minFreq) * powerLevel * powerLevel; // Exponential increase sounds better
             const volume = -20 + (powerLevel * 15); // Louder as power increases

             if (!isPowerSoundPlaying) {
                 isPowerSoundPlaying = true;
                 powerSynth.volume.linearRampToValueAtTime(volume, now + 0.01);
                 powerSynth.frequency.linearRampToValueAtTime(freq, now + 0.01);
                 powerSynth.triggerAttack(now);
             } else {
                 // Adjust volume and frequency smoothly if already playing
                 powerSynth.volume.linearRampToValueAtTime(volume, now + 0.05);
                 powerSynth.frequency.linearRampToValueAtTime(freq, now + 0.05);
             }
        }

        async function stopPowerSound() {
            if (!audioInitialized || !powerSynth || !isPowerSoundPlaying) return;
            isPowerSoundPlaying = false;
            try {
                 const now = Tone.now();
                 // Ramp down volume quickly before release
                 powerSynth.volume.linearRampToValueAtTime(-60, now + 0.05);
                 powerSynth.triggerRelease(now + 0.06);
            } catch (e) {
                console.error("Error stopping power sound:", e);
            }
        }


        // START: SPINNING CHIP UPDATE (Pinalitan ang note para maging "clack!")
        async function playCollisionSound(speed) { if (!audioInitialized) await initAudio(); if (!audioInitialized) return; const now = Tone.now(); if (now <= lastCollisionSoundTime) return; lastCollisionSoundTime = now + 0.04; const volume = -12 + Math.min(1, speed / 25) * 14; const note = speed > 15 ? 'C3' : (speed > 5 ? 'A2' : 'G2'); chipCollisionSynth.volume.value = volume; chipCollisionSynth.triggerAttackRelease(note, "32n", now); }
        async function playCushionSound(speed) { if (!audioInitialized) await initAudio(); if (!audioInitialized) return; const now = Tone.now(); if (now <= lastCushionSoundTime) return; lastCushionSoundTime = now + 0.03; const volume = -12 + Math.min(1, speed / 15) * 8; const note = speed > 10 ? 'C2' : 'D1'; cushionSynth.volume.value = volume; cushionSynth.triggerAttackRelease(note, '16n', now); }
        async function playCueHitSound(power) { if (!audioInitialized) await initAudio(); if (!audioInitialized) return; const now = Tone.now(); const volume = -6 + (power * 6); const note = 'C4'; cueHitSynth.volume.value = volume; cueHitSynth.triggerAttack(note, now); }
        async function playPocketSound() { if (!audioInitialized) await initAudio(); if (!audioInitialized) return; pocketSynth.triggerAttackRelease("0.2"); }
        function update(timestamp) { // <-- Ito na 'yung bago, na may (timestamp)
            
            // Kung 'di pa nagsisimula, set mo ang lastTime
            if (lastTime === 0) {
                lastTime = timestamp;
            }
            
            // 1. Kalkulahin kung gaano katagal ang lumipas
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            // 2. Idagdag ang lumipas na oras sa "accumulator"
            accumulator += deltaTime;

            // 3. I-proseso ang input (ito 'yung dati mong code sa update)
            if (isRotatingLeft || isRotatingRight) {
                if (isRotatingLeft) cueStick.angle -= ROTATION_SPEED;
                if (isRotatingRight) cueStick.angle += ROTATION_SPEED;
                if (!isTutorialActive) sendLiveAimData();
                playAimingSound();
            }

            // 4. Ito ang magic: Ang Physics Loop
Â  Â  Â  Â  Â  Â  // (Idagdag ito para maiwasan ang "spiral of death" kung mag-lag ng 1 segundo)
Â  Â  Â  Â  Â  Â  let maxLoops = 5; // Limitahan sa 5 physics update bawat frame

Â  Â  Â  Â  Â  Â  // Habang may sapat na oras na naipon, patakbuhin ang physics
Â  Â  Â  Â  Â  Â  while (accumulator >= FIXED_DELTA_TIME_MS && maxLoops > 0) { // <--- BINAGO
Â  Â  Â  Â  Â  Â  Â  Â  if (chipsMoving) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateChipPositions(FIXED_DELTA_TIME_SEC);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  accumulator -= FIXED_DELTA_TIME_MS;
Â  Â  Â  Â  Â  Â  Â  Â  maxLoops--; // <--- DINAGDAG
Â  Â  Â  Â  Â  Â  }

            // 5. I-drawing ang resulta (kahit gaano kabilis ang screen)
            draw();
            
            // 6. Ulitin
            requestAnimationFrame(update); // <-- Tatawagin ulit ang sarili niya
        }
        // â–¼â–¼â–¼ PALITAN MO ANG BUONG draw FUNCTION NITO â–¼â–¼â–¼

function draw() { 
    // 1. I-drawing ang "master copy" (litrato) ng mesa. Sobrang bilis nito.
    // (Pinalitan nito ang dating ctx.clearRect at drawTable)
    ctx.drawImage(backgroundCanvas, 0, 0);

    // 2. I-drawing ang mga bagay na gumagalaw (Walang babaguhin dito)
    drawChips(); 
    
    const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn; 
    if (isMyTurn && gameState === 'aiming' && !isTutorialActive) { 
        drawGuidelines(); 
    } 
    if ((gameState === 'aiming' || gameState === 'shooting_animation' || (isOnlineGame && !isMyTurnOnline)) && cueStick.visible) { 
        drawCueStick(); 
    } 
}

function toggleMusic() { const isMuted = backgroundPlaylist[0].muted; backgroundPlaylist.forEach(player => { player.muted = !isMuted; }); muteButton.textContent = isMuted ? "ğŸµ" : "ğŸ”‡"; }
        // â–¼â–¼â–¼ PALITAN MO ITONG BUONG FUNCTION â–¼â–¼â–¼
        function resizeCanvas() {
Â  Â  const oldCanvasWidth = canvas.width;
Â  Â  const oldCanvasHeight = canvas.height;
Â  Â  let chipRatios;

Â  Â  if (!isBreakShot && chips.length > 0 && oldCanvasWidth > 0 && oldCanvasHeight > 0) {
Â  Â  Â  Â  // Gumamit ng VIRTUAL_WIDTH/HEIGHT para sa ratio
Â  Â  Â  Â  chipRatios = chips.map(c => ({ x: c.x / VIRTUAL_WIDTH, y: c.y / VIRTUAL_HEIGHT }));
Â  Â  }

Â  Â  const containerWidth = window.innerWidth;
Â  Â  const containerHeight = window.innerHeight;
Â  Â  const screenAspectRatio = containerWidth / containerHeight;
Â  Â  const tableFrame = document.getElementById('table-frame');
Â  Â  let frameWidth, frameHeight;

Â  Â  // â–¼â–¼â–¼ ITO YUNG SOLUSYON SA SHADOW â–¼â–¼â–¼
Â  Â  // Mag-iwan tayo ng espasyo para sa shadow.
Â  Â  // 0.95 = 95% ng screen (mag-iiwan ng 2.5% sa bawat gilid)
Â  Â  const paddingPercentage = 0.95; 

Â  Â  if (screenAspectRatio > TABLE_ASPECT_RATIO) {
Â  Â  Â  Â  frameHeight = containerHeight * paddingPercentage; // <-- NILAGYAN NG PADDING
Â  Â  Â  Â  frameWidth = frameHeight * TABLE_ASPECT_RATIO;
Â  Â  } else {
Â  Â  Â  Â  frameWidth = containerWidth * paddingPercentage; // <-- NILAGYAN NG PADDING
Â  Â  Â  Â  frameHeight = frameWidth / TABLE_ASPECT_RATIO;
Â  Â  }
Â  Â  // â–²â–²â–² HANGGANG DITO ANG SOLUSYON SA SHADOW â–²â–²â–²

Â  Â  // Ito ang nagse-set ng CSS size (para mag-stretch)
Â  Â  tableFrame.style.width = `${frameWidth}px`;
Â  Â  tableFrame.style.height = `${frameHeight}px`;

Â  Â  // Ito ang nagse-set ng ACTUAL resolution ng canvas
Â  Â  // Gagawin nating fixed (ito ang magic)
Â  Â  canvas.width = VIRTUAL_WIDTH;
Â  Â  canvas.height = VIRTUAL_HEIGHT;

Â  Â  // I-set din ang sukat ng ating "tago" na canvas para pareho sila
Â  Â  backgroundCanvas.width = VIRTUAL_WIDTH;
Â  Â  backgroundCanvas.height = VIRTUAL_HEIGHT;

Â  Â  table.width = VIRTUAL_WIDTH;
Â  Â  table.height = VIRTUAL_HEIGHT;
Â  Â Â 
Â  Â  // Ang 'scale' ay HINDI na natin babaguhin. Mananatili itong '1' (galing sa global).

Â  Â  setupHoles(); // Tatawagin nito ang setupHoles na gagamit na ng scale=1

Â  Â  if (isBreakShot || !chipRatios) {
Â  Â  Â  Â  setupChips(); // Gagamit na rin ng scale=1
Â  Â  } else if (chipRatios) {
Â  Â  Â  Â  chips.forEach((chip, i) => {
Â  Â  Â  Â  Â  Â  const radiusConstant = chip.id === 0 ? CUE_BALL_RADIUS : BALL_RADIUS;
Â  Â  Â  Â  Â  Â  if (chipRatios[i]) {
Â  Â  Â  Â  Â  Â  Â  Â  // I-multiply sa VIRTUAL_WIDTH/HEIGHT
Â  Â  Â  Â  Â  Â  Â  Â  chip.x = chipRatios[i].x * VIRTUAL_WIDTH;
Â  Â  Â  Â  Â  Â  Â  Â  chip.y = chipRatios[i].y * VIRTUAL_HEIGHT;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // â–¼â–¼â–¼ ITO YUNG LINYA NA MAY TYPO KANINA, TAMA NA NGAYON â–¼â–¼â–¼
Â  Â  Â  Â  Â  Â  chip.radius = radiusConstant; // HINDI NA KAILANGAN i-multiply sa scale
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // I-drawing ang static na mesa sa "tago" na canvas
Â  Â  // Gawin ito PAGKATAPOS ng setupHoles() at setupChips()
Â  Â  drawBackgroundLayer();
}
        function setupHoles() { const hr = HOLE_RADIUS * scale; holes = [ { x: 0, y: 0, radius: hr }, { x: canvas.width, y: 0, radius: hr }, { x: 0, y: canvas.height, radius: hr }, { x: canvas.width, y: canvas.height, radius: hr } ]; }
        function setupChips() { chips = []; const newCueChip = { id: 0, value: 0, x: canvas.width * 0.25, y: canvas.height / 2, vx: 0, vy: 0, radius: CUE_BALL_RADIUS * scale, inPlay: true, color: '#1a1a1a', type: 'cue', isPocketing: false, pocketingProgress: 0, pocketingHole: null, rotation: 0, rotationSpeed: 0 }; chips.push(newCueChip); const objectChipRadius = BALL_RADIUS * scale; if (gameMode.includes('straight-ball') || gameMode.includes('poker')) { const redChipsSource = []; const blueChipsSource = []; for (let i = 1; i <= 12; i++) { if (i <= 6) { redChipsSource.push({ id: i, color: '#C8102E', type: 'red', value: i }); } else { blueChipsSource.push({ id: i, color: '#0033A0', type: 'blue', value: i }); } } const startX = canvas.width * 0.7; const startY = canvas.height / 2; const colSpacing = objectChipRadius * 2.1; const rowSpacing = objectChipRadius * 1.8; const positions = []; const rows = 4; const cols = 3; const totalHeight = (rows - 1) * rowSpacing; const initialY = startY - totalHeight / 2; for (let row = 0; row < rows; row++) { for (let col = 0; col < cols; col++) { positions.push({ x: startX + col * colSpacing, y: initialY + row * rowSpacing }); } } const chipDataOrder = [ ...redChipsSource, ...blueChipsSource ]; for (let i = 0; i < positions.length; i++) { let chipData = chipDataOrder[i]; if (chipData) { const newObjectChip = { id: chipData.id, value: chipData.value, x: positions[i].x, y: positions[i].y, vx: 0, vy: 0, radius: objectChipRadius, inPlay: true, color: chipData.color, type: chipData.type, isPocketing: false, pocketingProgress: 0, pocketingHole: null, rotation: 0, rotationSpeed: 0 }; chips.push(newObjectChip); } } } else if (gameMode.includes('61-ball')) { const chipColors = [ null, '#FFD700', '#0000FF', '#FF0000', '#800080', '#FFA500', '#008000', '#964B00', '#212121', '#FFC107', '#03A9F4', '#F44336', '#9C27B0', '#FF9800', '#4CAF50', '#795548' ]; let chipIds = Array.from({length: 15}, (_, i) => i + 1); const startX = canvas.width * 0.7; const startY = canvas.height / 2; const rowSpacing = objectChipRadius * 1.8; const rackPositions = []; for (let row = 0; row < 5; row++) { for (let col = 0; col <= row; col++) { rackPositions.push({ x: startX + row * rowSpacing, y: startY + (col * objectChipRadius * 2.1) - (row * objectChipRadius * 1.05) }); } } for (let i = 0; i < 15; i++) { const chipId = chipIds[i]; const newObjectChip = { id: chipId, value: chipId, x: rackPositions[i].x, y: rackPositions[i].y, vx: 0, vy: 0, radius: objectChipRadius, inPlay: true, color: chipColors[chipId], type: 'numbered', isPocketing: false, pocketingProgress: 0, pocketingHole: null, rotation: 0, rotationSpeed: 0 }; chips.push(newObjectChip); } } }
        function drawTable() { ctx.fillStyle = '#1a1a1a'; holes.forEach(hole => { ctx.beginPath(); ctx.arc(hole.x, hole.y, hole.radius, 0, Math.PI * 2); ctx.fill(); }); if (canvas.width > 0) { const fontSize = 60 * scale; ctx.font = `italic bold ${fontSize}px Georgia`; ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'; ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)'; ctx.textBaseline = 'middle'; const spotX = canvas.width * 0.7; // Laging 70% na ang spot const spotY = canvas.height / 2; const spotRadius = BALL_RADIUS * scale; ctx.lineWidth = 3.5 * scale; ctx.beginPath(); ctx.arc(spotX, spotY, spotRadius, 0, Math.PI * 2); ctx.stroke(); const textPart1 = "P"; const textPart2 = "ker"; const spacing = 8 * scale; ctx.textAlign = 'right'; ctx.fillText(textPart1, spotX - spotRadius - spacing, spotY); ctx.textAlign = 'left'; ctx.fillText(textPart2, spotX + spotRadius + spacing, spotY); const pMetrics = ctx.measureText(textPart1); const kerMetrics = ctx.measureText(textPart2); const pokerWidth = pMetrics.width + (spacing * 2) + (spotRadius * 2) + kerMetrics.width; const pokerCenterX = (spotX - spotRadius - spacing - pMetrics.width) + (pokerWidth / 2); ctx.font = `italic bold ${fontSize}px Georgia`; ctx.textAlign = 'center';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText("Pinoy Pool", (canvas.width / 2) - (60 * scale), spotY);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

// â–¼â–¼â–¼ I-COPY AT I-PASTE MO ITONG BUONG FUNCTION â–¼â–¼â–¼

function drawBackgroundLayer() {
Â  Â  // Punan muna ng solid color (fallback kung 'di mag-load ang image)
Â  Â  backgroundCtx.fillStyle = '#C59D5F';
Â  Â  backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);

Â  Â  
Â  Â  // ==========================================
Â  Â  // === START: SPOTLIGHT EFFECT ===
Â  Â  const centerX = backgroundCanvas.width / 2;
Â  Â  const centerY = backgroundCanvas.height / 2;
Â  Â  const innerRadius = backgroundCanvas.height * 0.4; 
Â  Â  const outerRadius = backgroundCanvas.width * 0.6; 
Â  Â  const gradient = backgroundCtx.createRadialGradient(
Â  Â  Â  Â  centerX, centerY, innerRadius, 
Â  Â  Â  Â  centerX, centerY, outerRadius Â 
Â  Â  );
Â  Â  gradient.addColorStop(0, 'rgba(0, 0, 0, 0)'); 
Â  Â  gradient.addColorStop(0.8, 'rgba(0, 0, 0, 0.3)');
Â  Â  gradient.addColorStop(1, 'rgba(0, 0, 0, 0.6)'); 
Â  Â  backgroundCtx.fillStyle = gradient;
Â  Â  backgroundCtx.fillRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
Â  Â  // === END: SPOTLIGHT EFFECT ===
Â  Â  // ==========================================
Â  Â Â 
Â  Â  // ==========================================
Â  Â  // === START: INNER SHADOW (ITO YUNG BAGO) ===
Â  Â  // Ito yung shadow sa gilid ng felt, galing sa railings.
Â  Â  const shadowColor = 'rgba(0, 0, 0, 0.3)'; // Kulay at dilim ng anino
Â  Â  const shadowWidth = 15; // Gaano kalapad ang anino mula sa gilid
Â  Â  const transparent = 'rgba(0, 0, 0, 0)';
Â  Â Â 
Â  Â  // Top Shadow (Mula taas, pa-fade pababa)
Â  Â  const topGradient = backgroundCtx.createLinearGradient(0, 0, 0, shadowWidth);
Â  Â  topGradient.addColorStop(0, shadowColor);
Â  Â  topGradient.addColorStop(1, transparent);
Â  Â  backgroundCtx.fillStyle = topGradient;
Â  Â  backgroundCtx.fillRect(0, 0, backgroundCanvas.width, shadowWidth);

Â  Â  // Bottom Shadow (Mula baba, pa-fade pataas)
Â  Â  const bottomGradient = backgroundCtx.createLinearGradient(0, backgroundCanvas.height - shadowWidth, 0, backgroundCanvas.height);
Â  Â  bottomGradient.addColorStop(0, transparent);
Â  Â  bottomGradient.addColorStop(1, shadowColor);
Â  Â  backgroundCtx.fillStyle = bottomGradient;
Â  Â  backgroundCtx.fillRect(0, backgroundCanvas.height - shadowWidth, backgroundCanvas.width, shadowWidth);

Â  Â  // Left Shadow (Mula kaliwa, pa-fade pakanan)
Â  Â  const leftGradient = backgroundCtx.createLinearGradient(0, 0, shadowWidth, 0);
Â  Â  leftGradient.addColorStop(0, shadowColor);
Â  Â  leftGradient.addColorStop(1, transparent);
Â  Â  backgroundCtx.fillStyle = leftGradient;
Â  Â  backgroundCtx.fillRect(0, 0, shadowWidth, backgroundCanvas.height);

Â  Â  // Right Shadow (Mula kanan, pa-fade pakaliwa)
Â  Â  const rightGradient = backgroundCtx.createLinearGradient(backgroundCanvas.width - shadowWidth, 0, backgroundCanvas.width, 0);
Â  Â  rightGradient.addColorStop(0, transparent);
Â  Â  rightGradient.addColorStop(1, shadowColor);
Â  Â  backgroundCtx.fillStyle = rightGradient;
Â  Â  backgroundCtx.fillRect(backgroundCanvas.width - shadowWidth, 0, shadowWidth, backgroundCanvas.height);
Â  Â  // === END: INNER SHADOW ===
Â  Â  // ==========================================


Â  Â  // Simula dito, ipagpapatuloy na ang pag-drawing ng mga butas at text
Â  Â  backgroundCtx.fillStyle = '#1a1a1a';
Â  Â  holes.forEach(hole => {
Â  Â  Â  Â  backgroundCtx.beginPath();
Â  Â  Â  Â  backgroundCtx.arc(hole.x, hole.y, hole.radius, 0, Math.PI * 2);
Â  Â  Â  Â  backgroundCtx.fill();
Â  Â  });

Â  Â  if (backgroundCanvas.width > 0) {
Â  Â  Â  Â  // ... (yung code mo para sa text at logo ay nandito pa rin, 
Â  Â  Â  Â  // Â  Â  Â hindi ko na isinulat ulit para mas maikli) ...
Â  Â  Â  Â  const fontSize = 60 * scale; 
Â  Â  Â  Â  backgroundCtx.font = `italic bold ${fontSize}px Georgia`;
Â  Â  Â  Â  backgroundCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
Â  Â  Â  Â  backgroundCtx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
Â  Â  Â  Â  backgroundCtx.textBaseline = 'middle';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const spotX = backgroundCanvas.width * 0.7;Â 
Â  Â  Â  Â  const spotY = backgroundCanvas.height / 2;
Â  Â  Â  Â  const spotRadius = BALL_RADIUS * scale;
Â  Â  Â  Â Â 
Â  Â  Â  Â  backgroundCtx.lineWidth = 3.5 * scale;
Â  Â  Â  Â  backgroundCtx.beginPath();
Â  Â  Â  Â  backgroundCtx.arc(spotX, spotY, spotRadius, 0, Math.PI * 2);
Â  Â  Â  Â  backgroundCtx.stroke();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const textPart1 = "P";
Â  Â  Â  Â  const textPart2 = "ker";
Â  Â  Â  Â  const spacing = 8 * scale;
Â  Â  Â  Â Â 
Â  Â  Â  Â  backgroundCtx.textAlign = 'right';
Â  Â  Â  Â  backgroundCtx.fillText(textPart1, spotX - spotRadius - spacing, spotY);
Â  Â  Â  Â  backgroundCtx.textAlign = 'left';
Â  Â  Â  Â  backgroundCtx.fillText(textPart2, spotX + spotRadius + spacing, spotY);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const pMetrics = backgroundCtx.measureText(textPart1);
Â  Â  Â  Â  const kerMetrics = backgroundCtx.measureText(textPart2);
Â  Â  Â  Â  const pokerWidth = pMetrics.width + (spacing * 2) + (spotRadius * 2) + kerMetrics.width;
Â  Â  Â  Â  const pokerCenterX = (spotX - spotRadius - spacing - pMetrics.width) + (pokerWidth / 2);
Â  Â  Â  Â Â 
Â  Â  Â  Â  backgroundCtx.font = `italic bold ${fontSize}px Georgia`;
Â  Â  Â  Â  backgroundCtx.textAlign = 'center';
Â  Â  Â  Â  backgroundCtx.fillText("Pinoy Pool", (backgroundCanvas.width / 2) - (60 * scale), spotY);
Â  Â  }
}
        
 // START: OPTIMIZED drawChips (Gold Acrylic + Big Numbers)
function drawChips() {
    chips.forEach(chip => {
        if (chip.inPlay) {
            let displayRadius = chip.radius;
            
            // Animation kapag nahuhulog sa butas
            if (chip.isPocketing) {
                displayRadius *= (1 - chip.pocketingProgress);
            }

            // SAVE STATE 1: Para sa Translation/Rotation
            ctx.save(); 
            ctx.translate(chip.x, chip.y); 

            // --- STEP A: FAKE SHADOW ---
            if (!chip.isPocketing) { 
                ctx.beginPath();
                ctx.arc(3 * scale, 4 * scale, displayRadius, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)'; 
                ctx.fill();
            }

            // --- STEP B: ROTATION ---
            ctx.rotate(chip.rotation);

            // --- STEP C: DRAWING ---
            if (chip.id === 0) {
                // === CUE CHIP (TIRADOR) ===
                ctx.beginPath();
                ctx.arc(0, 0, displayRadius, 0, Math.PI * 2);
                ctx.fillStyle = '#FFD700'; 
                ctx.fill();

                // Mga guhit ng Tirador
                ctx.strokeStyle = '#424242';
                ctx.lineWidth = 1.5 * scale;
                ctx.beginPath(); ctx.arc(0, 0, displayRadius * 0.8, 0, Math.PI * 2); ctx.stroke();
                ctx.beginPath(); ctx.arc(0, 0, displayRadius * 0.5, 0, Math.PI * 2); ctx.stroke();
                ctx.beginPath(); ctx.arc(0, 0, displayRadius * 0.2, 0, Math.PI * 2); ctx.fillStyle = '#303030'; ctx.fill();

            } else {
                // === OBJECT CHIP (PICHA) ===
                const acrylicThickness = displayRadius * 0.15;
                const coloredRadius = displayRadius - acrylicThickness;

                // 1. Outer Acrylic Edge (Gawing GOLD #FFD700)
                ctx.beginPath(); 
                ctx.arc(0, 0, displayRadius - (acrylicThickness / 3), 0, Math.PI * 2);
                
                // DITO BINAGO: Ginawang Gold ang border
                ctx.strokeStyle = '#FFD700'; 
                
                ctx.lineWidth = acrylicThickness * 0.8; 
                ctx.stroke(); 

                // 2. Inner Colored Area (Red 1-6, Blue 7-12)
                let finalColor = chip.color; 
                if (chip.id >= 1 && chip.id <= 6) finalColor = '#C62828'; 
                else if (chip.id >= 7 && chip.id <= 12) finalColor = '#1565C0'; 

                ctx.beginPath();
                ctx.arc(0, 0, coloredRadius, 0, Math.PI * 2);
                ctx.fillStyle = finalColor;
                ctx.fill();

                // Glossy Inner Stroke
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.lineWidth = 1;
                ctx.stroke();

                // 3. Numero (BIGGER FONTS)
                if (chip.id) {
                    ctx.save(); 

                    // DITO BINAGO: Pinalaki ang multiplier mula 1.1 -> 1.4
                    ctx.font = `900 ${coloredRadius * 1.4}px "Arial Black", "Impact", sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const textOffsetY = coloredRadius * 0.1; 

                    // Outline
                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = coloredRadius * 0.15; 
                    ctx.lineJoin = 'round'; 
                    ctx.strokeText(chip.id, 0, textOffsetY);

                    // Fill
                    ctx.fillStyle = 'white';
                    ctx.fillText(chip.id, 0, textOffsetY);

                    // Special Case: Labels for 6 & 9
                    if (chip.id === 6 || chip.id === 9) {
                        const labelText = chip.id === 6 ? "SIX" : "NINE";
                        ctx.font = `bold ${coloredRadius * 0.25}px Arial, sans-serif`;
                        ctx.lineWidth = coloredRadius * 0.05;
                        // Adjusted position para di tumama sa malaking number
                        ctx.strokeText(labelText, 0, coloredRadius * 0.75); 
                        ctx.fillText(labelText, 0, coloredRadius * 0.75);
                    }
                    
                    ctx.restore(); 
                }
            } 

            ctx.restore(); // RESTORE STATE
        } 

        // === RING LIGHT / HIGHLIGHT ===
        const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;
        if (isMyTurn && (gameState === 'aiming' || (gameState === 'moving' && canMoveCueBall)) && chip.inPlay && legalTargetChipIds.has(chip.id)) {
            const pulse = Math.abs(Math.sin(performance.now() * 0.004));
            const alpha = pulse * 0.7 + 0.3;
            const ringWidth = 2.5 * scale;
            const glowRadius = 7 * scale;
            const ringColor = `rgba(255, 255, 0, ${alpha})`;
            const glowColor = `rgba(255, 255, 0, ${alpha * 0.7})`;

            ctx.save();
            ctx.shadowColor = glowColor;
            ctx.shadowBlur = glowRadius;
            ctx.beginPath();
            ctx.arc(chip.x, chip.y, chip.radius + ringWidth + (2 * scale), 0, Math.PI * 2);
            ctx.strokeStyle = ringColor;
            ctx.lineWidth = ringWidth;
            ctx.stroke();
            ctx.restore();
        }
    });
}
        
function drawCueStick() {
    if (!cueStick.visible || !chips[0] || !chips[0].inPlay || !cueStickElement) return;
    
    const cueChip = chips[0];
    const canvasRect = canvas.getBoundingClientRect(); // Laki ng canvas sa screen
    const wrapperRect = gameWrapper.getBoundingClientRect();
    
    // Kunin ang CSS size ng tako
    const stickWidth = cueStickElement.offsetWidth;
    const stickHeight = cueStickElement.offsetHeight;

    // --- Ito ang bagong "conversion" logic ---
    // 1. Hanapin ang ratio ng virtual sa screen
    const xRatio = canvasRect.width / VIRTUAL_WIDTH;
    const yRatio = canvasRect.height / VIRTUAL_HEIGHT;

    // 2. I-convert ang VIRTUAL pwesto ng bola (cueChip.x) papuntang SCREEN pwesto
    const cueBallScreenX = cueChip.x * xRatio;
    const cueBallScreenY = cueChip.y * yRatio;

    // 3. Hanapin ang pwesto ng canvas sa loob ng wrapper
    const canvasScreenLeft = canvasRect.left - wrapperRect.left;
    const canvasScreenTop = canvasRect.top - wrapperRect.top;
    
    // 4. Idagdag ang pwesto ng canvas sa na-convert na pwesto ng bola
    const cueBallCenterX = canvasScreenLeft + cueBallScreenX;
    const cueBallCenterY = canvasScreenTop + cueBallScreenY;
    // --- End ng conversion logic ---

    cueStickElement.style.left = `${cueBallCenterX - stickWidth}px`;
    cueStickElement.style.top = `${cueBallCenterY - (stickHeight / 2)}px`;
    
    const pullbackPixels = -cueStick.pullback;
    cueStickElement.style.transform = `rotate(${cueStick.angle}rad) translateX(${pullbackPixels - 15}px)`;
}

// â–¼â–¼â–¼ BURAHIN ANG LUMA AT IPALIT ITONG BUONG FUNCTION â–¼â–¼â–¼

function drawGuidelines() {
    // 1. Kunin ang stats ng tako para sa Aim
    const stats = getCurrentCueStats();

    // 2. Siguraduhin na aiming state bago mag-drawing
    if (gameState !== 'aiming' || chipsMoving) return;
    const cueChip = chips[0];
    if (!cueChip || !cueChip.inPlay) return;
    
    const angle = cueStick.angle;
    const shotVector = { x: Math.cos(angle), y: Math.sin(angle) };
    let firstHit = null;
    let minCollisionDist = Infinity;
    
    // Hanapin kung aling picha ang unang tatamaan
    for (const targetChip of chips) {
        if (targetChip.id === 0 || !targetChip.inPlay) continue;
        const cueToTarget = { x: targetChip.x - cueChip.x, y: targetChip.y - cueChip.y };
        const projDist = cueToTarget.x * shotVector.x + cueToTarget.y * shotVector.y;
        if (projDist <= 0) continue;
        const closestPointOnPath = { x: cueChip.x + projDist * shotVector.x, y: cueChip.y + projDist * shotVector.y };
        const perpDistSq = (closestPointOnPath.x - targetChip.x)**2 + (closestPointOnPath.y - targetChip.y)**2;
        const combinedRadiusSq = (cueChip.radius + targetChip.radius)**2;
        if (perpDistSq >= combinedRadiusSq) continue;
        const travelDist = projDist - Math.sqrt(combinedRadiusSq - perpDistSq);
        if (travelDist < minCollisionDist) {
            minCollisionDist = travelDist;
            firstHit = { chip: targetChip, travelDist: travelDist };
        }
    }
    
    ctx.setLineDash([5 * scale, 5 * scale]);
    ctx.lineWidth = 2.0 * scale;
    
    if (firstHit) {
        // --- LINE 1: Cue Ball Path (Laging nakikita) ---
        const impactPoint = { x: cueChip.x + firstHit.travelDist * shotVector.x, y: cueChip.y + firstHit.travelDist * shotVector.y };
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.beginPath();
        ctx.moveTo(cueChip.x, cueChip.y);
        ctx.lineTo(impactPoint.x, impactPoint.y);
        ctx.stroke();
        
        // --- GHOST BALL (Laging nakikita) ---
        ctx.globalAlpha = 0.5;
        ctx.save();
        ctx.translate(impactPoint.x, impactPoint.y);
        const displayRadius = cueChip.radius;
        ctx.beginPath();
        ctx.arc(0, 0, displayRadius, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 255, 0, 1)';
        ctx.fill();
        ctx.strokeStyle = 'rgba(33, 33, 33, 0.4)'; // Inayos para 'di error
        ctx.lineWidth = 1.5 * scale;
        ctx.beginPath();
        ctx.arc(0, 0, displayRadius * 0.8, 0, Math.PI * 2); // Ito 'yung TAMA
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(0, 0, displayRadius * 0.5, 0, Math.PI * 2); // Ito 'yung TAMA
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(0, 0, displayRadius * 0.2, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(66, 66, 66, 0.4)'; // Inayos para 'di error
        ctx.fill();
        ctx.restore();
        ctx.globalAlpha = 1.0;
        
        ctx.setLineDash([]); // I-reset ang dash

        // --- Kalkulahin ang mga susunod na mangyayari ---
        const objectChip = firstHit.chip;
        const collisionNormal = { x: objectChip.x - impactPoint.x, y: objectChip.y - impactPoint.y };
        const normMag = Math.sqrt(collisionNormal.x**2 + collisionNormal.y**2);
        const unitNormal = { x: collisionNormal.x / normMag, y: collisionNormal.y / normMag };
        const tangentVector = { x: -unitNormal.y, y: unitNormal.x };
        if (tangentVector.x * shotVector.x + tangentVector.y * shotVector.y < 0) {
            tangentVector.x *= -1;
            tangentVector.y *= -1;
        }
        const sideSpinAngle = pektusOffset.x * 1.5;
        const followFactor = 1 - (pektusOffset.y * 0.8);
        const deflectedCueVector = { x: tangentVector.x * Math.cos(sideSpinAngle) - tangentVector.y * Math.sin(sideSpinAngle), y: tangentVector.x * Math.sin(sideSpinAngle) + tangentVector.y * Math.cos(sideSpinAngle) };
        const finalCueVector = { x: (deflectedCueVector.x * 0.7 + shotVector.x * 0.3) * followFactor, y: (deflectedCueVector.y * 0.7 + shotVector.y * 0.3) * followFactor };

        
        // === DITO NAGSISIMULA ANG AIM STAT CHECK ===
        
        // --- LINE 2: Yellow Line (Object Ball Path) ---
        // Ipakita lang kung ang Aim stat ay 4 o higit pa
        if (stats.Aim >= 4 || equippedItems.cue === 'default') {
            ctx.strokeStyle = 'rgba(255, 255, 0, 0.9)';
            ctx.setLineDash([5 * scale, 5 * scale]); // Ibalik ang dashed line
            ctx.beginPath();
            ctx.moveTo(objectChip.x, objectChip.y);
            ctx.lineTo(objectChip.x + unitNormal.x * 41, objectChip.y + unitNormal.y * 41);
            ctx.stroke();
        }

        // --- LINE 3: Deflected White Line (Cue Ball Path after impact) ---
        // Ipakita lang kung ang Aim stat ay 8 o higit pa
        if (stats.Aim >= 8) {
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.setLineDash([5 * scale, 5 * scale]); // Siguraduhin na dashed line
            ctx.beginPath();
            ctx.moveTo(impactPoint.x, impactPoint.y);
            ctx.lineTo(impactPoint.x + finalCueVector.x * 2000, impactPoint.y + finalCueVector.y * 2000);
            ctx.stroke();
        }
        
        // --- Foul Indicator ---
        let isWrongTarget = false;
        const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;
        if (isMyTurn) {
            if (gameMode.includes('straight-ball') && colorsAssigned && playerChipsType) {
                if (firstHit.chip.type !== playerChipsType) isWrongTarget = true;
            } else if (gameMode.includes('61-ball') && lowestChipNumber > 0) {
                if (firstHit.chip.id !== lowestChipNumber) isWrongTarget = true;
            }
        }
        if (isWrongTarget) {
            ctx.save();
            ctx.font = `bold ${firstHit.chip.radius * 2}px Arial`;
            ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ğŸš«', firstHit.chip.x, firstHit.chip.y);
            ctx.restore();
        }

    } else {
        // --- LINE 1 (Kapag walang tatamaan) ---
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.setLineDash([5 * scale, 5 * scale]);
        ctx.beginPath();
        ctx.moveTo(cueChip.x, cueChip.y);
        ctx.lineTo(cueChip.x + shotVector.x * 2000, cueChip.y + shotVector.y * 2000);
        ctx.stroke();
    }
    
    ctx.setLineDash([]); // I-reset ang line dash sa dulo
}
        
        // START: SPINNING CHIP UPDATE (Nagdagdag ng spin logic sa physics)
        function updateChipPositions(dt_sec) { // <-- Tumatanggap na ng oras (in seconds)
            
            // Gaano kaliit ang bawat substep
            const subSteps = 8; 
            const dt_sub = dt_sec / subSteps; // Oras bawat substep

            for (let i = 0; i < subSteps; i++) { 
                chips.forEach(chip => { 
                    if (chip.inPlay && !chip.isPocketing) { 
                        
                        // Ito ang bagong pag-galaw (Velocity * Time)
                        chip.x += chip.vx * dt_sub; 
                        chip.y += chip.vy * dt_sub; 
                        
                        // Ito ang bagong pag-ikot (Rotation Speed * Time)
                        chip.rotation += chip.rotationSpeed * dt_sub;
                    }
                }); 
                
                const spinFactor = WALL_SPIN_FACTOR; // Ito 'yung luma mong code, ok na 'to

                for (let j = 0; j < chips.length; j++) { 
                    const chip1 = chips[j]; 
                    if (!chip1.inPlay || chip1.isPocketing) continue; 
                    
                    if (chip1.x + chip1.radius > canvas.width) { 
                        playCushionSound(Math.abs(chip1.vx)); 
                        chip1.vx *= -1; 
                        chip1.x = canvas.width - chip1.radius; 
                        chip1.rotationSpeed -= chip1.vy * spinFactor; 
                    } 
                    if (chip1.x - chip1.radius < 0) { 
                        playCushionSound(Math.abs(chip1.vx)); 
                        chip1.vx *= -1; 
                        chip1.x = chip1.radius; 
                        chip1.rotationSpeed -= chip1.vy * spinFactor; 
                    } 
                    if (chip1.y + chip1.radius > canvas.height) { 
                        playCushionSound(Math.abs(chip1.vy)); 
                        chip1.vy *= -1; 
                        chip1.y = canvas.height - chip1.radius; 
                        chip1.rotationSpeed += chip1.vx * spinFactor; 
                    } 
                    if (chip1.y - chip1.radius < 0) { 
                        playCushionSound(Math.abs(chip1.vy)); 
                        chip1.vy *= -1; 
                        chip1.y = chip1.radius; 
                        chip1.rotationSpeed += chip1.vx * spinFactor; 
                    } 
                    
                    for (let k = j + 1; k < chips.length; k++) { 
                        const chip2 = chips[k]; 
                        if (chip2.inPlay && !chip2.isPocketing) handleChipCollision(chip1, chip2); 
                    } 
                } 
            } 
            
            let stillMoving = false; 
            
            // Ito ang BAGONG paraan ng pag-apply ng FRICTION
            // Ito ay ginagawa *pagkatapos* ng lahat ng sub-steps
            // Gumagamit ito ng Math.pow para maging frame-rate independent
            // Ito ay ginagawa *pagkatapos* ng lahat ng sub-steps
Â  Â  Â  Â  Â  Â  // Gumagamit ito ng Math.pow para maging frame-rate independent
Â  Â  Â  Â  Â  Â  const frictionThisStep = Math.pow(FRICTION_PER_SECOND, dt_sec);
Â  Â  Â  Â  Â  Â  const spinFrictionThisStep = Math.pow(SPIN_FRICTION_PER_SECOND, dt_sec);

            chips.forEach(chip => { 
                if (chip.inPlay) { 
                    if (chip.isPocketing) { 
                        // ... (ang code mo para sa pocketing ay ok na)
                        chip.pocketingProgress += 0.05; // Pwede mong i-adjust 'to
                        chip.rotation += chip.rotationSpeed * dt_sec; 
                        chip.x += (chip.pocketingHole.x - chip.x) * 0.1; 
                        chip.y += (chip.pocketingHole.y - chip.y) * 0.1; 
                        if (chip.pocketingProgress >= 1) { 
                            chip.inPlay = false; 
                            chip.isPocketing = false; 
                        } 
                    } else { 
                        // Ito na ang TAMANG paraan ng pag-apply ng friction
                        // na independent sa frame rate
                        const frictionThisStep = Math.pow(FRICTION_PER_SECOND, dt_sec);
                        const spinFrictionThisStep = Math.pow(SPIN_FRICTION_PER_SECOND, dt_sec);

                        chip.vx *= frictionThisStep; 
                        chip.vy *= frictionThisStep;
                        chip.rotationSpeed *= spinFrictionThisStep;
                        
                        if (Math.abs(chip.vx) < MIN_VELOCITY) chip.vx = 0; 
                        if (Math.abs(chip.vy) < MIN_VELOCITY) chip.vy = 0; 

                        // Bagong check: ihinto ang spin kung sobrang bagal na
                        if (Math.abs(chip.rotationSpeed) < MIN_ROTATION_SPEED) chip.rotationSpeed = 0;
                        holes.forEach(hole => { 
                            if (Math.sqrt((hole.x - chip.x)**2 + (hole.y - chip.y)**2) < hole.radius) { 
                                playPocketSound(); 
                                chip.isPocketing = true; 
                                chip.pocketingHole = hole; 
                                chip.rotationSpeed = (Math.random() - 0.5) * 0.2; 
                                chip.vx = 0; 
                                chip.vy = 0; 
                                if (!chipsPocketedInTurn.find(p => p.id === chip.id)) chipsPocketedInTurn.push(chip); 
                            } 
                        }); 
                    } 
                    
                    if (chip.vx !== 0 || chip.vy !== 0 || chip.isPocketing) stillMoving = true;
                } 
            }); 
            
            chipsMoving = stillMoving; 
            if (!chipsMoving) { 
                if (gameState === 'shooting') { 
                    gameState = 'evaluating'; 
                    if (isTutorialActive) { 
                        setTimeout(nextTutorialStep, 500); 
                    } else if (!isOnlineGame || localPlayerUid === lastTurnControllerUid) { 
                        handleTurnEnd(); // <-- PALITAN MO NITO
                    } 
                } 
            } 
        }
        
       // â–¼â–¼â–¼ IPALIT MO ITONG BUONG handleChipCollision FUNCTION â–¼â–¼â–¼

function handleChipCollision(chip1, chip2) { 
    const dx = chip2.x - chip1.x, dy = chip2.y - chip1.y; 
    const dist = Math.sqrt(dx*dx + dy*dy); 
    const combinedRadius = chip1.radius + chip2.radius; 
    
    if (dist < combinedRadius) { 
        const impactSpeed = Math.sqrt((chip1.vx - chip2.vx)**2 + (chip1.vy - chip2.vy)**2); 
        if (impactSpeed > 0.1) playCollisionSound(impactSpeed); 
        
        if (firstChipHitInTurn === null) { 
            if (chip1.id === 0) firstChipHitInTurn = chip2; 
            else if (chip2.id === 0) firstChipHitInTurn = chip1; 
        } 
        
        // â–¼â–¼â–¼ "HOCKEY" PHYSICS â–¼â–¼â–¼

        // 1. I-rotate ang velocities para ang x-axis ay nasa linya ng banggaan
        const angle = Math.atan2(dy, dx), sin = Math.sin(angle), cos = Math.cos(angle); 
        let vel1 = { x: chip1.vx * cos + chip1.vy * sin, y: chip1.vy * cos - chip1.vx * sin }; 
        let vel2 = { x: chip2.vx * cos + chip2.vy * sin, y: chip2.vy * cos - chip2.vx * sin }; 

        // 2. Kunin ang bigat (mass) ng bawat chip
        const m1 = (chip1.id === 0) ? CUE_CHIP_MASS : OBJECT_CHIP_MASS;
        const m2 = (chip2.id === 0) ? CUE_CHIP_MASS : OBJECT_CHIP_MASS;

        // 3. Itabi ang original velocities bago mag-calculate
        const v1i = vel1.x; // Bilis ng chip1 bago tumama
        const v2i = vel2.x; // Bilis ng chip2 bago tumama

        // 4. Ilapat ang 1D Elastic Collision formula (gamit ang MASS)
        vel1.x = ((m1 - m2) * v1i + 2 * m2 * v2i) / (m1 + m2);
        vel2.x = ((m2 - m1) * v2i + 2 * m1 * v1i) / (m1 + m2);

        // 5. Hanapin kung alin ang cue chip para sa Pektus
        let cueVel, otherVel, shotPektus;
        if (chip1.id === 0) {
            cueVel = vel1;
            otherVel = vel2;
            shotPektus = shotPektusOffset;
        } else if (chip2.id === 0) {
            cueVel = vel2;
            otherVel = vel1;
            // Baliktarin ang pektus dahil baliktad ang impact
            shotPektus = { x: -shotPektusOffset.x, y: -shotPektusOffset.y }; 
        }

        // 6. I-apply ang Pektus (Spin)
    
        // Kunin ang stats at kalkulahin ang lakas ng spin
        const stats = currentShotStats;
        const spinMultiplier = 0.5 + (stats.Spin / 10) * 1.5; // Mula 0.65x hanggang 2.0x

        if (cueVel) {
            const relativeVelX = Math.abs(v1i - v2i); // Gaano kalakas ang tama

            // A. Sidespin (Left/Right) - ginamitan na ng spinMultiplier
            const sideSpin = (shotPektus.x * 0.2) * spinMultiplier;
            cueVel.y += sideSpin * relativeVelX;

            // B. Topspin (Follow) - ginamitan na ng spinMultiplier
            // (Dahil sa handlePektusInput, ang shotPektus.y ay laging negative o zero)
            if (shotPektus.y < 0) { // Pataas ang dot (topspin)
                const followEnergy = Math.abs(shotPektus.y * 0.25) * spinMultiplier * relativeVelX;
                cueVel.x += followEnergy;  // Dagdag na "follow"
            }
        }
        
        // 7. Ayusin ang "overlap"
        const overlap = combinedRadius - dist; 
        chip1.x -= (overlap / 2) * cos; 
        chip1.y -= (overlap / 2) * sin; 
        chip2.x += (overlap / 2) * cos; 
        chip2.y += (overlap / 2) * sin; 

        // 8. I-transform pabalik ang velocities
        chip1.vx = vel1.x * cos - vel1.y * sin; 
        chip1.vy = vel1.y * cos + vel1.x * sin; 
        chip2.vx = vel2.x * cos - vel2.y * sin; 
        chip2.vy = vel2.y * cos + vel2.x * sin; 

        // 9. I-apply ang spin AT friction galing sa banggaan
        const spinFactor = COLLISION_SPIN_FACTOR;
        const tangentialVelDiff = vel1.y - vel2.y; // Gaano kabilis ang "pagkiskis"
        
        // Kalkulahin ang "preno" galing sa pagkiskis
        const frictionImpulse = tangentialVelDiff * (1.0 - COLLISION_FRICTION);

        // I-apply ang spin (galing sa nawalang "dulas")
        chip1.rotationSpeed += (tangentialVelDiff * spinFactor);
        chip2.rotationSpeed -= (tangentialVelDiff * spinFactor);

        // I-apply ang "preno" sa tangential velocity (pag-dulas)
        vel1.y -= frictionImpulse / m1;
        vel2.y += frictionImpulse / m2;
    } 
}

// â–²â–²â–² HANGGANG DITO ANG BUONG FUNCTION â–²â–²â–²
        function showMessage(msg, duration = 2000) { messageBox.textContent = msg; messageBox.style.display = 'block'; setTimeout(() => { if (messageBox.textContent === msg) messageBox.style.display = 'none'; }, duration); }
        function resetChipStateForReturn(chip) { if (!chip) return; chip.inPlay = true; chip.isPocketing = false; chip.pocketingProgress = 0; chip.pocketingHole = null; chip.vx = 0; chip.vy = 0; chip.rotation = 0; chip.rotationSpeed = 0; } // Dinagdag ang reset sa rotation
        async function handleTurnEnd() { if (isOnlineGame && lastTurnControllerUid !== localPlayerUid) { return; } if (isProcessingTurnEnd) return; isProcessingTurnEnd = true; if (gameMode.includes('poker')) await handlePokerTurnEnd(); else if (gameMode.includes('straight-ball')) await handleStraightBallTurnEnd(); else if (gameMode.includes('61-ball')) await handle61BallTurnEnd(); isProcessingTurnEnd = false; }
        async function handle61BallTurnEnd() {
    let foul = false;
    let switchTurn = true;
    const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;
    const pocketedObjectChips = chipsPocketedInTurn.filter(c => c.id !== 0);
    const lowestChipOnTable = lowestChipNumber;
    const wasCueBallPocketed = chipsPocketedInTurn.some(c => c.id === 0);
    const didHitWrongBallFirst = !isBreakShot && firstChipHitInTurn && firstChipHitInTurn.id !== lowestChipOnTable;
    const didNotHitAnyBall = firstChipHitInTurn === null && chips.some(c => c.inPlay && c.id !== 0);
    if (wasCueBallPocketed || didHitWrongBallFirst || didNotHitAnyBall) {
        foul = true;
    }
    if (foul) {
        if (isMyTurn && !isOnlineGame) {
            setTimeout(() => aiDisplayMessage(getAiChatMessage('playerFoul')), 800);
        }
        switchTurn = true;
        canMoveCueBall = true;
        if (wasCueBallPocketed) {
            const cueChip = chips.find(c => c.id === 0);
            if (cueChip) {
                resetChipStateForReturn(cueChip);
                cueChip.x = canvas.width * 0.25;
                cueChip.y = canvas.height / 2;
            }
        }
        if (pocketedObjectChips.length > 0) {
            pocketedObjectChips.forEach(chip => {
                const chipToReturn = chips.find(c => c.id === chip.id);
                if (chipToReturn) {
                    resetChipStateForReturn(chipToReturn);
                    placeChipOnSpot(chipToReturn);
                }
            });
        }
        if (isMyTurn) showMessage("Foul! Chips returned.", 2500);
    } else {
        if (pocketedObjectChips.length > 0) {
            const pointsThisTurn = pocketedObjectChips.reduce((sum, chip) => sum + chip.value, 0);
            if (isMyTurn) player61Score += pointsThisTurn;
            else opponent61Score += pointsThisTurn;

            // --- IDAGDAG ANG CURRENCY REWARD DITO ---
            if (isMyTurn) {
                const reward = pocketedObjectChips.length * REWARD_PER_BALL;
                playerTotalCurrency += reward;
                showRewardPopup(reward);
                updateCurrencyDisplay();
                const xpGained = pocketedObjectChips.length * XP_PER_BALL;
Â  Â  Â  Â  Â  Â  Â  Â  gainXP(xpGained);
            }
            // --- END NG DAGDAG ---

            switchTurn = false;
            if (isMyTurn && !isOnlineGame) {
                setTimeout(() => aiDisplayMessage(getAiChatMessage('playerGoodShot')), 800);
            }
        } else {
            switchTurn = true;
        }
    }
    const newRemainingChips = chips.filter(c => c.inPlay && c.id !== 0);
    lowestChipNumber = newRemainingChips.length > 0 ? Math.min(...newRemainingChips.map(c => c.id)) : 0;
    const winner = checkWinCondition();
    if (winner) {
        const winnerText = (winner === 'player') ? 'You Win!' : (winner === 'opponent' ? 'You Lose!' : "It's a Draw! 60-60");
        await endGame(winnerText);
        return;
    }
    isBreakShot = false;
    if (isOnlineGame) await updateOnlineGameState(switchTurn);
    else updateLocalGameState(switchTurn);
}
// â–¼â–¼â–¼ PALITAN MO ITONG BUONG FUNCTION â–¼â–¼â–¼

async function handlePokerTurnEnd() {
Â  Â  const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;
Â  Â  const currentHand = isMyTurn ? playerHand : opponentHand;
Â  Â  const waitingHand = isMyTurn ? opponentHand : playerHand; // Kamay ng naghihintay
Â  Â  const pocketedObjectChips = chipsPocketedInTurn.filter(c => c.id !== 0);
Â  Â  const wasCueBallPocketed = chipsPocketedInTurn.some(c => c.id === 0);
Â  Â  const didHitNothing = firstChipHitInTurn === null && chips.some(c => c.inPlay && c.id !== 0);
Â  Â  const legallyPocketedOwnChips = pocketedObjectChips.filter(chip => currentHand.some(card => card.value === chip.id));

Â  Â  let switchTurn = true; // Default: Lilipat ang turn
Â  Â  let foul = wasCueBallPocketed || didHitNothing;

Â  Â  // --- Kukunin muna natin ang bilang ng baraha BAGO mag-update ---
Â  Â  const myCardCount_Before = playerHand.length;
Â  Â  const opponentCardCount_Before = opponentHand.length;
Â  Â  const isLastBallScenario = (myCardCount_Before === 1 && opponentCardCount_Before === 1);
Â  Â  const didPlayerShootOwnLastBall = (isMyTurn && myCardCount_Before === 1 && legallyPocketedOwnChips.length > 0);
Â  Â  const didOpponentShootOwnLastBall = (!isMyTurn && opponentCardCount_Before === 1 && legallyPocketedOwnChips.length > 0);
Â  Â  const didCurrentTurnPlayerShootOwnLastBall = isMyTurn ? didPlayerShootOwnLastBall : didOpponentShootOwnLastBall;

Â  Â  // --- BAGONG LOGIC PARA SA TURN SWITCHING ---
Â  Â  // Magpapatuloy lang ang turn kung: Malinis ang tira AT puro bola lang ng tumitira ang nahulog
Â  Â  if (legallyPocketedOwnChips.length > 0 && !foul && pocketedObjectChips.length === legallyPocketedOwnChips.length) {
Â  Â  Â  Â  switchTurn = false; // Hindi lilipat ang turn

Â  Â  Â  Â  // (AI message at reward logic)
Â  Â  Â  Â  if (isMyTurn && !isOnlineGame) {
Â  Â  Â  Â  Â  Â  setTimeout(() => aiDisplayMessage(getAiChatMessage('playerGoodShot')), 800);
Â  Â  Â  Â  }
Â  Â  Â  Â  if (isMyTurn) {
Â  Â  Â  Â  Â  Â  const reward = legallyPocketedOwnChips.length * REWARD_PER_BALL;
Â  Â  Â  Â  Â  Â  playerTotalCurrency += reward;
Â  Â  Â  Â  Â  Â  showRewardPopup(reward);
Â  Â  Â  Â  Â  Â  updateCurrencyDisplay();
            const xpGained = legallyPocketedOwnChips.length * XP_PER_BALL;
Â  Â  Â  Â  Â  Â  gainXP(xpGained);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  // --- END NG BAGONG TURN SWITCHING LOGIC ---

Â  Â  // --- I-UPDATE ANG MGA KAMAY PAGKATAPOS MALAMAN KUNG LILIPAT ANG TURN ---
Â  Â  if (pocketedObjectChips.length > 0) {
Â  Â  Â  Â  const pocketedIds = pocketedObjectChips.map(c => c.id);
Â  Â  Â  Â  playerHand = playerHand.filter(card => !pocketedIds.includes(card.value));
Â  Â  Â  Â  opponentHand = opponentHand.filter(card => !pocketedIds.includes(card.value));
Â  Â  }

Â  Â  // --- FOUL LOGIC (PAGBUNOT NG CARD, ATBP.) ---
Â  Â  if (foul) {
Â  Â  Â  Â  if (isMyTurn && !isOnlineGame) {
Â  Â  Â  Â  Â  Â  setTimeout(() => aiDisplayMessage(getAiChatMessage('playerFoul')), 800);
Â  Â  Â  Â  }
Â  Â  Â  Â  canMoveCueBall = true; // Ball in hand para sa susunod na player
Â  Â  Â  Â  if (wasCueBallPocketed) {
Â  Â  Â  Â  Â  Â  // Ibalik ang cue ball
Â  Â  Â  Â  Â  Â  const cueChip = chips.find(c => c.id === 0);
Â  Â  Â  Â  Â  Â  if (cueChip) {
Â  Â  Â  Â  Â  Â  Â  Â  resetChipStateForReturn(cueChip);
Â  Â  Â  Â  Â  Â  Â  Â  cueChip.x = canvas.width * 0.25;
Â  Â  Â  Â  Â  Â  Â  Â  cueChip.y = canvas.height / 2;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (isMyTurn) showMessage("Foul! You scratched.", 3000);

Â  Â  Â  Â  Â  Â  // Pagbunot ng card dahil sa scratch
Â  Â  Â  Â  Â  Â  let newCard = isMyTurn ? await waitForCardPick() : (deck.length > 0 ? deck.splice(Math.floor(Math.random() * deck.length), 1)[0] : null);
Â  Â  Â  Â  Â  Â  if (newCard) {
Â  Â  Â  Â  Â  Â  Â  Â  const cardName = `${newCard.rank}${newCard.suit}`;
Â  Â  Â  Â  Â  Â  Â  Â  const correspondingChip = chips.find(c => c.id === newCard.value);

Â  Â  Â  Â  Â  Â  Â  Â  // Check kung nahulog na yung katumbas na bola
Â  Â  Â  Â  Â  Â  Â  Â  if (correspondingChip && !correspondingChip.inPlay) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMyTurn) showMessage(`You picked ${cardName}, but it was pocketed. Card discarded.`, 3000);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Idagdag sa kamay
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (isMyTurn ? playerHand : opponentHand).push(newCard);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMyTurn) showMessage(`Foul! You picked ${cardName}.`, 3000);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Check para sa "Lucky Scratch King Win"
Â  Â  Â  Â  Â  Â  Â  Â  // (Ito yung scenario na last ball mo, nashoot mo kaso nagscratch ka, tapos King nabunot mo)
Â  Â  Â  Â  Â  Â  Â  Â  if (didPlayerShootOwnLastBall && isMyTurn && newCard.rank === 'K') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Mananalo ka pa rin dahil King ang nabunot
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await endGame('You Win on a Lucky Scratch!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // Tapos na ang laro
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else if (didHitNothing) {
Â  Â  Â  Â  Â  Â  if (isMyTurn) showMessage("Foul! No ball hit.", 3000);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  // --- END NG FOUL LOGIC ---

Â  Â  // --- PAG-CHECK KUNG MAY PANALO ---
Â  Â  let winner = null; // Sino ang nanalo? 'player' o 'opponent'?
Â  Â  let shouldEndGame = false; // Dapat na bang itigil ang laro?

Â  Â  // Gamitin ang na-update na bilang ng cards
Â  Â  const currentPlayerHandAfterShot = isMyTurn ? playerHand : opponentHand;
Â  Â  const waitingPlayerHandAfterShot = isMyTurn ? opponentHand : playerHand;

Â  Â  // 1. Check muna kung nanalo ang KASALUKUYANG tumitira
Â  Â  if (currentPlayerHandAfterShot.length === 0 || (currentPlayerHandAfterShot.length > 0 && currentPlayerHandAfterShot.every(card => card.rank === 'K'))) {
Â  Â  Â  Â  winner = isMyTurn ? 'player' : 'opponent';
Â  Â  Â  Â  shouldEndGame = true; // Nanalo ang tumira, tapos agad ang laro
Â  Â  Â  Â  // Special case: Last Ball Sudden Death Win (kailangan malinis ang tira)
Â  Â  Â  Â  if (isLastBallScenario && didCurrentTurnPlayerShootOwnLastBall && !switchTurn) {
Â  Â  Â  Â  Â  Â  winner = isMyTurn ? 'player' : 'opponent'; // Confirm winner
Â  Â  Â  Â  Â  Â  shouldEndGame = true;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  // 2. Kung hindi nanalo ang tumitira, check kung nanalo ang NAGHIHINTAY
Â  Â  //Â  Â  (Ito yung "Delayed Win" logic)
Â  Â  else if (waitingPlayerHandAfterShot.length === 0 || (waitingPlayerHandAfterShot.length > 0 && waitingPlayerHandAfterShot.every(card => card.rank === 'K'))) {
Â  Â  Â  Â  // Nanalo ang naghihintay, PERO...
Â  Â  Â  Â  // Mananalo lang siya kung LILIPAT na dapat ang turn (dahil sumablay o nag-foul ang tumira)
Â  Â  Â  Â  if (switchTurn) {
Â  Â  Â  Â  Â  Â  winner = isMyTurn ? 'opponent' : 'player'; // Nanalo ang kalaban
Â  Â  Â  Â  Â  Â  shouldEndGame = true; // Tapos ang laro kasi lilipat na ang turn
Â  Â  Â  Â  }
Â  Â  Â  Â  // Kung HINDI lilipat ang turn (!switchTurn), ibig sabihin malinis pa ang tira ng kasalukuyang player,
Â  Â  Â  Â  // kaya HINDI pa tapos ang laro, kahit naubos na ang bola ng kalaban.
Â  Â  }

Â  Â  // --- PAGTAPOS NG LARO KUNG MAY NANALO NA ---
Â  Â  if (shouldEndGame) {
Â  Â  Â  Â  const winnerText = (winner === 'player') ? 'You Win!' : 'You Lose!';

Â  Â  Â  Â  if (isOnlineGame) {
Â  Â  Â  Â  Â  Â  // (Online game ending logic - kunin ang UID ng nanalo, update Firestore)
Â  Â  Â  Â  Â  Â  const gameDocRef = doc(db, "games", gameId);
Â  Â  Â  Â  Â  Â  let opponentUid = null;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const gameData = (await getDoc(gameDocRef)).data();
Â  Â  Â  Â  Â  Â  Â  Â  const opponentPlayerDbId = localPlayerId === 'player1' ? 'player2' : 'player1';
Â  Â  Â  Â  Â  Â  Â  Â  if (gameData && gameData.players[opponentPlayerDbId]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opponentUid = gameData.players[opponentPlayerDbId].uid;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch(e) { console.error("Could not get opponent UID for end game", e); }

Â  Â  Â  Â  Â  Â  const winnerUid = (winner === 'player') ? localPlayerUid : (opponentUid || 'unknown');
Â  Â  Â  Â  Â  Â  const hands = (localPlayerId === 'player1') ? {
Â  Â  Â  Â  Â  Â  Â  Â  player1Hand: playerHand, player2Hand: opponentHand
Â  Â  Â  Â  Â  Â  } : {
Â  Â  Â  Â  Â  Â  Â  Â  player1Hand: opponentHand, player2Hand: playerHand
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  await updateDoc(gameDocRef, {
Â  Â  Â  Â  Â  Â  Â  Â  gameState: 'finished',
Â  Â  Â  Â  Â  Â  Â  Â  winner: winnerUid,
Â  Â  Â  Â  Â  Â  Â  Â  ...hands
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // (AI game ending logic)
Â  Â  Â  Â  Â  Â  await endGame(winnerText);
Â  Â  Â  Â  }
Â  Â  Â  Â  return; // Mahalaga ito para hindi na magpatuloy sa baba
Â  Â  }
Â  Â  // --- END NG PAGTAPOS NG LARO ---

Â  Â  // --- KUNG WALANG NANALO, IPASA ANG TURN KUNG KAILANGAN ---
Â  Â  isBreakShot = false; // Siguraduhing hindi na break shot
Â  Â  if (isOnlineGame) {
Â  Â  Â  Â  await updateOnlineGameState(switchTurn); // I-update ang Firestore
Â  Â  } else {
Â  Â  Â  Â  updateLocalGameState(switchTurn); // I-update ang local game state (para sa AI)
Â  Â  }
}

// â–²â–²â–² HANGGANG DITO ANG PALIT â–²â–²â–²
async function handleStraightBallTurnEnd() {
    let foul = false,
        switchTurn = true,
        foulReason = "";
    const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;
    const pocketedObjectChips = chipsPocketedInTurn.filter(c => c.id !== 0);
    const currentPlayerColor = isMyTurn ? playerChipsType : opponentChipsType;
    const wasCueBallPocketed = chipsPocketedInTurn.some(c => c.id === 0);
    const didHitWrongBallFirst = !isBreakShot && colorsAssigned && firstChipHitInTurn && firstChipHitInTurn.type !== currentPlayerColor;
    const didNotHitAnyBall = firstChipHitInTurn === null && chips.some(c => c.inPlay && c.id !== 0);
    if (wasCueBallPocketed || didHitWrongBallFirst || didNotHitAnyBall) {
        foul = true;
    }
    if (pocketedObjectChips.length > 0) {
        // ... (sa loob ng handleStraightBallTurnEnd)
Â  Â  Â  Â  if (!colorsAssigned && !foul) {
Â  Â  Â  Â  Â  Â  const firstPocketed = pocketedObjectChips[0];
Â  Â  Â  Â  Â  Â  if (isMyTurn) {
Â  Â  Â  Â  Â  Â  Â  Â  playerChipsType = firstPocketed.type;
Â  Â  Â  Â  Â  Â  Â  Â  opponentChipsType = firstPocketed.type === 'red' ? 'blue' : 'red';
Â  Â  Â  Â  Â  Â  } else {
Â    Â  Â  Â  Â  Â  Â  Â  opponentChipsType = firstPocketed.type;
Â  Â  Â  Â  Â  Â  Â  Â  playerChipsType = firstPocketed.type === 'red' ? 'blue' : 'red';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  colorsAssigned = true;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // â–¼â–¼â–¼ ITO ANG BAGONG CODE â–¼â–¼â–¼
Â  Â  Â  Â  Â  Â  if (isMyTurn) {
Â  Â  Â  Â  Â  Â  Â  Â  const colorName = playerChipsType.toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  showColorAssignmentPopup(`You got ${colorName}!`, colorName);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Para makita mo rin kung anong kulay nakuha ng kalaban
Â  Â  Â  Â  Â  Â  Â  Â  const colorName = opponentChipsType.toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  showColorAssignmentPopup(`Opponent got ${colorName}!`, colorName);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // â–²â–²â–² HANGGANG DITO â–²â–²â–²
Â  Â  Â }
        const myPocketedCount = pocketedObjectChips.filter(c => c.type === (isMyTurn ? playerChipsType : opponentChipsType)).length;
        const opponentPocketedCount = pocketedObjectChips.filter(c => c.type === (isMyTurn ? opponentChipsType : playerChipsType)).length;
        if (!foul && myPocketedCount > 0 && opponentPocketedCount === 0) {
            switchTurn = false;
            if (isMyTurn && !isOnlineGame) {
                setTimeout(() => aiDisplayMessage(getAiChatMessage('playerGoodShot')), 800);
            }

            // --- BAGONG DAGDAG (REWARD) ---
            if (isMyTurn) { // Check kung turn mo
                const reward = myPocketedCount * REWARD_PER_BALL;
                playerTotalCurrency += reward;
                showRewardPopup(reward);
                updateCurrencyDisplay();
                const xpGained = myPocketedCount * XP_PER_BALL;
Â  Â  Â  Â  Â  Â  Â  Â  gainXP(xpGained);
            }
            // --- END NG DAGDAG ---
        }
    }
    if (foul) {
        if (isMyTurn && !isOnlineGame) {
            setTimeout(() => aiDisplayMessage(getAiChatMessage('playerFoul')), 800);
        }
        switchTurn = true;
        canMoveCueBall = true;
        if (wasCueBallPocketed) {
            foulReason += "Cue ball pocketed! ";
            const cueChip = chips.find(c => c.id === 0);
            if (cueChip) {
                resetChipStateForReturn(cueChip);
                cueChip.x = canvas.width * 0.25;
                cueChip.y = canvas.height / 2;
            }
            const foulingPlayerColor = isMyTurn ? playerChipsType : opponentChipsType;
            if (foulingPlayerColor) {
                const chipToReturn = chips.find(c => c.type === foulingPlayerColor && !c.inPlay && !chipsPocketedInTurn.some(p => p.id === c.id));
                if (chipToReturn) {
                    resetChipStateForReturn(chipToReturn);
                    placeChipOnSpot(chipToReturn);
                    foulReason += "One of your balls was returned.";
                }
            }
        }
        if (didHitWrongBallFirst) {
            foulReason += "Hit opponent's ball first. ";
            const myPocketedInFoul = pocketedObjectChips.filter(c => c.type === currentPlayerColor);
            if (myPocketedInFoul.length > 0) {
                foulReason += "Your pocketed balls are returned.";
                myPocketedInFoul.forEach(pc => {
                    const foundChip = chips.find(c => c.id === pc.id);
                    if (foundChip) {
                        resetChipStateForReturn(foundChip);
                        placeChipOnSpot(foundChip);
                    }
                });
            }
        }
        if (didNotHitAnyBall) foulReason += "No object ball was hit. ";
    }
    if (foulReason && isMyTurn) showMessage("Foul! " + foulReason.trim(), 4000);
    const winner = checkWinCondition();
    if (winner) {
        await endGame((winner === 'player') ? 'You Win!' : 'You Lose!');
        return;
    }
    isBreakShot = false;
    if (isOnlineGame) await updateOnlineGameState(switchTurn);
    else updateLocalGameState(switchTurn);
}

        async function updateOnlineGameState(switchTurn) { try { const gameDocRef = doc(db, "games", gameId); const docSnap = await getDoc(gameDocRef); if (!docSnap.exists() || docSnap.data().gameState === 'finished') return; let nextTurnUid = docSnap.data().currentTurnUid; if (switchTurn) { nextTurnUid = (nextTurnUid === docSnap.data().players.player1.uid) ? docSnap.data().players.player2.uid : docSnap.data().players.player1.uid; } const chipsToSend = chips.map(c => ({...c, x: c.x / canvas.width, y: c.y / canvas.height })); const newTurnId = (docSnap.data().turnId || 0) + 1; const updatedData = { chips: chipsToSend, currentTurnUid: nextTurnUid, canMoveCueBall, isBreakShot: false, turnInProgress: false, turnId: newTurnId, liveAimData: null }; if (gameMode.includes('poker')) { const hands = (localPlayerId === 'player1') ? { player1Hand: playerHand, player2Hand: opponentHand } : { player1Hand: opponentHand, player2Hand: playerHand }; Object.assign(updatedData, { deck }, hands); } else if (gameMode.includes('straight-ball')) { const types = (localPlayerId === 'player1') ? { player1ChipsType: playerChipsType, player2ChipsType: opponentChipsType } : { player1ChipsType: opponentChipsType, player2ChipsType: playerChipsType }; Object.assign(updatedData, { colorsAssigned }, types); } else if (gameMode.includes('61-ball')) { const scores = (localPlayerId === 'player1') ? { player1_61Score: player61Score, player2_61Score: opponent61Score } : { player1_61Score: opponent61Score, player2_61Score: player61Score }; Object.assign(updatedData, { lowestChipNumber }, scores); } await updateDoc(gameDocRef, updatedData); } catch (error) { console.error("Error updating game state:", error); showMessage("Connection error.", 3000); } }
        function updateLocalGameState(switchTurn) {
            if (switchTurn) {
                if (!playerTurn && chipsPocketedInTurn.length > 0) { setTimeout(() => { aiDisplayMessage(getAiChatMessage('playerGoodShot')); }, 700); }
                playerTurn = !playerTurn;
                setCueForCurrentTurn();
                if (playerTurn) { aiConsecutivePots = 0; }
                showMessage(`${playerTurn ? 'Your' : 'Opponent'}'s turn`, 1500);
            } else {
                if (playerTurn) { showMessage("You shoot again!", 1500); } else {
                    aiConsecutivePots++;
                    showMessage("AI shoots again!", 1500);
                    setTimeout(() => { aiDisplayMessage(getAiChatMessage('goodShot')); }, 700);
                }
            }
            chipsPocketedInTurn = [];
            firstChipHitInTurn = null;
            resetPektus();
            updateCardDisplay();
            updateInfoBox(); // Tatawagin nito ang updateLegalTargetChips()
            if (gameState !== 'gameover') {
                if (canMoveCueBall) {
                    gameState = 'moving';
                    if (gameMode.includes('ai') && !playerTurn) {
                        placeCueChipForAI();
                    } else if (playerTurn) {
                        dragGuideText.style.display = 'block';
                    }
                } else {
                    gameState = 'aiming';
                    dragGuideText.style.display = 'none';
                    cueStick.visible = true;
                    if (cueStickElement) cueStickElement.style.display = 'block';
                    if (gameMode.includes('ai') && !playerTurn) {
                        setTimeout(aiTurn, 1000);
                    }
                }
            }
        }
        // â–¼â–¼â–¼ PALITAN MO ITONG BUONG FUNCTION â–¼â–¼â–¼

function checkWinCondition() { 
    if (gameState === 'gameover') return null; 
    let winner = null; 

    if (gameMode.includes('poker')) { 
        
        // --- BAGONG LOGIC DITO ---
        // Titingnan natin kung sino ang kasalukuyang tumitira
        const isCurrentTurnPlayer = isOnlineGame ? isMyTurnOnline : playerTurn;
        
        // Ito 'yung mga baraha ng tumitira at naghihintay
        const currentTurnHand = isCurrentTurnPlayer ? playerHand : opponentHand;
        const waitingPlayerHand = isCurrentTurnPlayer ? opponentHand : playerHand;
        
        // Ito 'yung "identity" nila
        const currentTurnWinner = isCurrentTurnPlayer ? 'player' : 'opponent';
        const waitingPlayerWinner = isCurrentTurnPlayer ? 'opponent' : 'player';

        // 1. Unang i-check: Nanalo ba ang KASALUKUYANG TUMITIRA?
        if (currentTurnHand.length === 0 || (currentTurnHand.length > 0 && currentTurnHand.every(card => card.rank === 'K'))) {
            winner = currentTurnWinner;
        } 
        // 2. Kung hindi, i-check: Nanalo ba ang NAGHIHINTAY na player?
        else if (waitingPlayerHand.length === 0 || (waitingPlayerHand.length > 0 && waitingPlayerHand.every(card => card.rank === 'K'))) {
            winner = waitingPlayerWinner;
        }
        // --- END NG BAGONG LOGIC ---

    } else if (gameMode.includes('straight-ball') && colorsAssigned) { 
        if (!chips.some(c => c.inPlay && c.type === playerChipsType) && playerChipsType) winner = 'player'; 
        else if (!chips.some(c => c.inPlay && c.type === opponentChipsType) && opponentChipsType) winner = 'opponent'; 
    } else if (gameMode.includes('61-ball')) { 
        if (player61Score >= 61) winner = 'player'; 
        else if (opponent61Score >= 61) winner = 'opponent'; 
        else if (!chips.some(c => c.inPlay && c.id !== 0) && player61Score === 60 && opponent61Score === 60) winner = 'draw'; 
    } 
    return winner; 
}

/**
 * Tumatanggap ng "raw power" (2-42) at ipinapasa ito sa animation at applyShot.
 */
async function shoot(shotPowerValue) { // Renamed parameter to avoid conflict
    if (gameState !== 'aiming' || chipsMoving) return;
    const powerNormalized = (shotPowerValue - 2) / 40; // Normalize power (0 to ~1)
    playCueHitSound(powerNormalized); // Pass normalized power
    chipsPocketedInTurn = [];
    firstChipHitInTurn = null;
    shotPektusOffset = { ...pektusOffset };

    // === SIMULA NG PAGBABAGO ===
    // Kunin ang stats ng tako mo BAGO tumira
    const stats = getCurrentCueStats();
    
    // Isama ang 'cueStats' sa ipapadalang data
    const shotData = {
        uid: localPlayerUid,
        angle: cueStick.angle,
        power: shotPowerValue,
        pektus: shotPektusOffset,
        timestamp: Date.now(),
        cueStats: stats // <-- ITO ANG BAGONG DAGDAG!
    };
    // === TAPOS NG PAGBABAGO ===

    cueStick.power = 0;
    powerBar.style.height = '0%';
    gameState = 'shooting_animation';
    let startTime = null;
    const animationDuration = 100;
    const startPullback = cueStick.pullback;
    const endPullback = -30 * scale;

    function animateLocalShot(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / animationDuration, 1);
        cueStick.pullback = startPullback + (endPullback - startPullback) * progress;
        if (progress < 1) {
            requestAnimationFrame(animateLocalShot);
        } else {
            cueStick.pullback = 0;
            cueStick.visible = false;
            if(cueStickElement) cueStickElement.style.display = 'none';
            if (isOnlineGame) {
                try {
                    lastTurnControllerUid = localPlayerUid;
                    // Ipadala ang shotData na may kasama nang stats
                    updateDoc(doc(db, "games", gameId), { lastShot: shotData, turnInProgress: true, lastTurnController: localPlayerUid });
                } catch (error) {
                    console.error("Error sending shot data:", error);
                    gameState = 'aiming'; // Revert state if sending fails
                    cueStick.visible = true;
                }
            } else {
                applyShot(shotData);
            }
        }
    }
    requestAnimationFrame(animateLocalShot);
}


/**
 * Ina-apply ang shot sa cue ball. (MAY TIMESTEP FIX V2)
 */
function applyShot(shotData) {
    if (chipsMoving) return;
    const cueChip = chips[0];
    if (!cueChip || !cueChip.inPlay) return;

    // --- SIMULA NG PAGBABAGO ---

    // 1. Kunin ang stats mula sa 'shotData'
    //    Kung walang cueStats (galing sa AI o lumang shot), gamitin ang stats ng naka-equip
    const stats = shotData.cueStats || getCurrentCueStats();

    // 2. I-save ang stats na ito sa global variable para magamit ng handleChipCollision
    currentShotStats = stats;
    
    // --- TAPOS NG PAGBABAGO ---

    // 3. Kalkulahin ang epekto ng Power stat
    const powerBonus = (stats.Power - 2) * 0.05; // 5% bonus per stat point above 2
    const finalPowerMultiplier = VELOCITY_MULTIPLIER * (1 + powerBonus);

    shotPektusOffset = shotData.pektus || { x: 0, y: 0 };
    
    // 4. Gamitin ang 'finalPowerMultiplier'
    cueChip.vx = Math.cos(shotData.angle) * shotData.power * finalPowerMultiplier;
    cueChip.vy = Math.sin(shotData.angle) * shotData.power * finalPowerMultiplier;
    
    chipsMoving = true;
    gameState = 'shooting';
    if (isOnlineGame) {
        lastTurnControllerUid = shotData.uid;
    }
}
// â–²â–²â–² HANGGANG DITO ANG IPAPALIT â–²â–²â–²
        async function handleRematchRequest() { if (!isOnlineGame || !gameId) return; const rematchButton = document.getElementById('rematch-button'); rematchButton.disabled = true; rematchButton.textContent = 'Waiting for Opponent...'; const gameDocRef = doc(db, "games", gameId); try { await updateDoc(gameDocRef, { [`rematchRequest.${localPlayerUid}`]: true }); } catch (error) { console.error("Error sending rematch request:", error); rematchButton.textContent = 'Error! Try Again'; rematchButton.disabled = false; } }
        
        async function updatePlayerData(uid, didWin = false) {
    if (!uid || !didWin) return;
    const playerDocRef = doc(db, "players", uid);
    try {
        const playerDoc = await getDoc(playerDocRef);
        const displayName = localStorage.getItem('pinoyPoolPlayerName') || "Anonymous";
        
        // Ito 'yung bagong data na ise-save natin
        const dataToSave = {
            displayName: displayName,
            searchableName: displayName.toLowerCase(), // <-- â–¼â–¼â–¼ IDAGDAG MO ITO â–¼â–¼â–¼
            wins: increment(1),
            lastPlayed: serverTimestamp()
        };
        
        // I-save ang 'dataToSave'
        if (!playerDoc.exists() || playerDoc.data().displayName !== displayName) {
            await setDoc(playerDocRef, dataToSave, { merge: true });
        } else {
            // Burahin ang displayName at searchableName kung hindi naman nagbago
            // para 'increment' lang ang mangyari
            delete dataToSave.displayName;
            delete dataToSave.searchableName;
            await updateDoc(playerDocRef, dataToSave);
        }
    } catch (error) {
        console.error("Error updating player data:", error);
    }
}

        async function cleanupMatchmakingEntry() { if (unsubscribeFromQueue) { unsubscribeFromQueue(); unsubscribeFromQueue = null; } const queueCollection = collection(db, "matchmakingQueue"); const q = query(queueCollection, where("uid", "==", localPlayerUid)); const snapshot = await getDocs(q); if (!snapshot.empty) { const myDocRef = snapshot.docs[0].ref; await deleteDoc(myDocRef); } }
        async function cancelMatchmaking() { if (matchmakingTimeoutId) { clearTimeout(matchmakingTimeoutId); matchmakingTimeoutId = null; } await cleanupMatchmakingEntry(); matchmakingWaitModal.classList.remove('show'); onlineMenu.classList.add('show'); history.back(); showMessage("Matchmaking cancelled."); }
        
      // â–¼â–¼â–¼ PALITAN MO ITONG BUONG FUNCTION (Step 4A) â–¼â–¼â–¼
async function findMatch() {
Â  Â  const displayName = localPlayerName || "Guest" + Math.floor(Math.random() * 1000);
Â  Â  if (!isAuthReady || !localPlayerUid) { showMessage("Connecting... Please wait."); return; }
Â  Â  onlineMenu.classList.remove('show');
Â  Â  matchmakingWaitModal.classList.add('show');
Â  Â  history.pushState({ modal: 'matchmaking' }, 'Matchmaking', '#matchmaking');

Â  Â  // --- SIMULA NG RANKED LOGIC ---
Â  Â  // 1. Kunin ang rank mo (e.g., index 0 para sa Beginner)
Â  Â  const myRank = getPlayerRank(playerLevel);
Â  Â  const myRankIndex = myRank.index;
Â  Â  
Â  Â  // 2. Ito 'yung "Mobile Legends" rule!
Â  Â  // Hahanap ka lang ng kalaro na 1 level sa taas mo, 1 level sa baba, o ka-level mo.
Â  Â  // Halimbawa: Kung Master (index 2) ka, hahanap ka ng Hustler (1), Master (2), at Grand Master (3).
Â  Â  const validRankIndices = [myRankIndex - 1, myRankIndex, myRankIndex + 1];
Â  Â  // --- DULO NG RANKED LOGIC ---
Â  Â  
Â  Â  matchmakingTimeoutId = setTimeout(async () => {
Â  Â  Â  Â  if (gameId) { clearTimeout(matchmakingTimeoutId); return; }
Â  Â  Â  Â  console.log("Matchmaking timed out. Falling back to AI.");
Â  Â  Â  Â  await cleanupMatchmakingEntry();
Â  Â  Â  Â  matchmakingWaitModal.classList.remove('show');
Â  Â  Â  Â  showMessage("No opponents found. Starting game vs AI...", 2500);
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  const fallbackGameMode = `ai-${selectedOnlineGameType}`;
Â  Â  Â  Â  Â  Â  startGame(fallbackGameMode, 'pro');
Â  Â  Â  Â  }, 1000);
Â  Â  }, 15000); // 15 segundos na paghihintay

Â  Â  const queueCollection = collection(db, "matchmakingQueue");
Â  Â Â 
Â  Â  // 3. I-query ang database para sa kalaban na PASOK SA RANK
Â  Â  const q = query(
Â  Â  Â  Â  queueCollection, 
Â  Â  Â  Â  where("status", "==", "waiting"), 
Â  Â  Â  Â  where("gameType", "==", selectedOnlineGameType), 
Â  Â  Â  Â  where("uid", "!=", localPlayerUid),
Â  Â  Â  Â  // ITO ANG MAGIC: Hahanap lang sa ranks na [Beginner-1, Beginner, Beginner+1]
Â  Â  Â  Â  where("rankIndex", "in", validRankIndices), 
Â  Â  Â  Â  orderBy("timestamp"), // Kunin 'yung pinakamatagal nang naghihintay
Â  Â  Â  Â  limit(1)
Â  Â  );
Â  Â  const availableOpponents = await getDocs(q);

Â  Â  if (!availableOpponents.empty) {
Â  Â  Â  Â  // --- MAY NAKITANG KALABAN! ---
Â  Â  Â  Â  clearTimeout(matchmakingTimeoutId);
Â  Â  Â  Â  const opponentDoc = availableOpponents.docs[0];
Â  Â  Â  Â  const opponentDocRef = opponentDoc.ref;
Â  Â  Â  Â  const opponentUid = opponentDoc.data().uid;
Â  Â  Â  Â  const opponentDisplayName = opponentDoc.data().displayName || "Opponent";
Â  Â  Â  Â  const opponentEquippedCue = opponentDoc.data().equippedCueId || 'default';

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await runTransaction(db, async (transaction) => {
Â  Â  Â  Â  Â  Â  Â  Â  const freshOpponentDoc = await transaction.get(opponentDocRef);
Â  Â  Â  Â  Â  Â  Â  Â  if (!freshOpponentDoc.exists() || freshOpponentDoc.data().status !== 'waiting') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw "Opponent is no longer available.";
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  gameId = Math.random().toString(36).substring(2, 7).toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  localPlayerId = 'player1'; 
Â  Â  Â  Â  Â  Â  Â  Â  gameMode = `online-${selectedOnlineGameType}`;
Â  Â  Â  Â  Â  Â  Â  Â  resizeCanvas();
Â  Â  Â  Â  Â  Â  Â  Â  setupChips();
Â  Â  Â  Â  Â  Â  Â  Â  const initialChipsToSend = chips.map(c => ({...c, x: c.x/canvas.width, y: c.y/canvas.height }));
Â  Â  Â  Â  Â  Â  Â  Â  const startingPlayerUid = Math.random() < 0.5 ? localPlayerUid : opponentUid;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let gameData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameType: selectedOnlineGameType,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameState: 'playing',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  turnId: 1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Idagdag ang rankIndex mo (P1)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  player1: { uid: localPlayerUid, status: 'online', displayName: displayName, equippedCueId: equippedItems.cue, rankIndex: myRankIndex },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Idagdag ang rankIndex ng kalaban (P2)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  player2: { uid: opponentUid, status: 'online', displayName: opponentDisplayName, equippedCueId: opponentEquippedCue, rankIndex: opponentDoc.data().rankIndex }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chips: initialChipsToSend,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentTurnUid: startingPlayerUid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastShot: null, liveAimData: null, turnInProgress: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canMoveCueBall: true, isBreakShot: true, winner: null
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (selectedOnlineGameType === 'poker') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createDeck(); dealCards();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.assign(gameData, { deck, player1Hand: playerHand, player2Hand: opponentHand, originalPlayer1Hand: originalPlayerHand, originalPlayer2Hand: originalOpponentHand });
Â  Â  Â  Â  Â  Â  Â  Â  } else if (selectedOnlineGameType === 'straight-ball') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.assign(gameData, { colorsAssigned: false, player1ChipsType: null, player2ChipsType: null });
Â  Â  Â  Â  Â  Â  Â  Â  } else if (selectedOnlineGameType === '61-ball') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.assign(gameData, { player1_61Score: 0, player2_61Score: 0, lowestChipNumber: 1 });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const gameDocRef = doc(db, "games", gameId);
Â  Â  Â  Â  Â  Â  Â  Â  transaction.set(gameDocRef, gameData);
Â  Â  Â  Â  Â  Â  Â  Â  transaction.update(opponentDocRef, { status: 'matched', gameId: gameId });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (unsubscribeFromQueue) unsubscribeFromQueue();
Â  Â  Â  Â  Â  Â  matchmakingWaitModal.classList.remove('show');
Â  Â  Â  Â  Â  Â  showMessage("Opponent found! Starting game...");
Â  Â  Â  Â  Â  Â  listenToGameUpdates(gameId);

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Matchmaking failed: ", e);
Â  Â  Â  Â  Â  Â  showMessage("Matchmaking failed. Trying again...");
Â  Â  Â  Â  Â  Â  if (matchmakingTimeoutId) clearTimeout(matchmakingTimeoutId);
Â  Â  Â  Â  Â  Â  await cleanupMatchmakingEntry(); 
Â  Â  Â  Â  Â  Â  matchmakingWaitModal.classList.remove('show');
Â  Â  Â  Â  Â  Â  onlineMenu.classList.add('show');
Â  Â  Â  Â  Â  Â  history.back();
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  // --- WALA PANG KALABAN, PUMILA KA ---
Â  Â  Â  Â  console.log("Waiting for opponent...");
Â  Â  Â  Â  // Idagdag ang rankIndex mo sa queue
Â  Â  Â  Â  const myQueueDocRef = await addDoc(queueCollection, { 
Â  Â  Â  Â  Â  Â  uid: localPlayerUid, 
Â  Â  Â  Â  Â  Â  gameType: selectedOnlineGameType, 
Â  Â  Â  Â  Â  Â  status: 'waiting', 
Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp(), 
Â  Â  Â  Â  Â  Â  displayName: displayName,
Â  Â  Â  Â  Â  Â  rankIndex: myRankIndex, // <-- ITO ANG BAGONG DAGDAG
Â  Â  Â  Â  Â  Â  equippedCueId: equippedItems.cue // <-- Bagong dagdag
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Mag-listen ka sa sarili mong document
Â  Â  Â  Â  unsubscribeFromQueue = onSnapshot(myQueueDocRef, (doc) => {
Â  Â  Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  Â  Â  if (data && data.status === 'matched' && data.gameId) {
Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(matchmakingTimeoutId);
Â  Â  Â  Â  Â  Â  Â  Â  if (unsubscribeFromQueue) unsubscribeFromQueue();
Â  Â  Â  Â  Â  Â  Â  Â  matchmakingWaitModal.classList.remove('show');
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Opponent found! Joining game...");
Â  Â  Â  Â  Â  Â  Â  Â  gameId = data.gameId;
Â  Â  Â  Â  Â  Â  Â  Â  localPlayerId = 'player2'; // Ikaw (P2) ang na-match
Â  Â  Â  Â  Â  Â  Â  Â  listenToGameUpdates(gameId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }
}
// â–²â–²â–² HANGGANG DITO ANG PALIT (Step 4A) â–²â–²â–²

        function animateAndApplyShot(shotData) { cueStick.angle = shotData.angle; cueStick.visible = true; if (cueStickElement) cueStickElement.style.display = 'block'; gameState = 'shooting_animation'; let startTime = null; const animationDuration = 100; const shotPowerNormalized = (shotData.power - 5) / 40; const startPullback = shotPowerNormalized * (150 * scale); const endPullback = -30 * scale; function animate(timestamp) { if (!startTime) startTime = timestamp; const progress = Math.min((timestamp - startTime) / animationDuration, 1); cueStick.pullback = startPullback + (endPullback - startPullback) * progress; if (progress < 1) { requestAnimationFrame(animate); } else { cueStick.visible = false; cueStick.pullback = 0; if (cueStickElement) cueStickElement.style.display = 'none'; applyShot(shotData); } } requestAnimationFrame(animate); }
        
       // === START PLAYER NAME UPDATE & RING LIGHT (Step 3B - May Ranks na!) ===
Â  Â  Â  Â  // In-update ang function para kunin ang 'displayName' ng kalaban
Â  Â  Â  Â  function syncGameState(data) {
Â  Â  Â  Â  Â  Â  if (isSyncing || !data) return;
Â  Â  Â  Â  Â  Â  isSyncing = true;
Â  Â  Â  Â  Â  Â  let opponentId = null;
Â  Â  Â  Â  Â  Â  let opponentStatus = null;
Â  Â  Â  Â  Â  Â  if (localPlayerId && data.players) {
Â  Â  Â  Â  Â  Â  Â  Â  opponentId = localPlayerId === 'player1' ? 'player2' : 'player1';
Â  Â  Â  Â  Â  Â  Â  Â  if (data.players[opponentId]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opponentStatus = data.players[opponentId].status;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Kunin ang pangalan ng kalaban mula sa game data
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opponentPlayerName = data.players[opponentId].displayName || "Opponent";Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (localPlayerId && data.players && data.players[opponentId]) {
Â  Â  Â  Â  Â  Â  Â  Â  // Kunin ang pangalan AT equipped cue ng kalaban
Â  Â  Â  Â  Â  Â  Â  Â  opponentPlayerName = data.players[opponentId].displayName || "Opponent";
Â  Â  Â  Â  Â  Â  Â  Â  opponentEquippedCueId = data.players[opponentId].equippedCueId || 'default';
Â  Â  Â  Â  Â  Â  Â  Â  opponentRankIndex = data.players[opponentId].rankIndex || 0; // <-- Ito yung dinagdag natin
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback kung wala pang data
Â  Â  Â  Â  Â  Â  Â  Â  opponentPlayerName = "Opponent";
Â  Â  Â  Â  Â  Â  Â  Â  opponentEquippedCueId = 'default';
Â  Â  Â  Â  Â  Â  Â  Â  opponentRankIndex = 0; // <-- Ito yung dinagdag natin
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (data.gameState === 'playing' && gameState !== 'playing') {
Â  Â  Â  Â  Â  Â  Â  Â  gameState = 'playing';
Â  Â  Â  Â  Â  Â  Â  Â  isOnlineGame = true;
Â  Â  Â  Â  Â  Â  Â  Â  showGameUI();
Â  Â  Â  Â  Â  Â  Â  Â  gameMode = `online-${data.gameType}`;
Â  Â  Â  Â  Â  Â  Â  Â  lastProcessedTurnId = -1;
Â  Â  Â  Â  Â  Â  Â  Â  winnerModal.classList.remove('show');
Â  Â  Â  Â  Â  Â  Â  Â  waitingRoom.classList.remove('show');
Â  Â  Â  Â  Â  Â  Â  Â  onlineMenu.classList.remove('show');
Â  Â  Â  Â  Â  Â  Â  Â  gameModeSelect.classList.remove('show');
Â  Â  Â  Â  Â  Â  Â  Â  history.pushState({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modal: 'game'
Â  Â  Â  Â  Â  Â  Â  Â  }, 'Game', '#game');
Â  Â  Â  Â  Â  Â  Â  Â  if (canvas.width === 0) resizeCanvas();
Â  Â  Â  Â  Â  Â  Â  Â  if (data.chips) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chips = data.chips.map(remoteChip => ({ ...remoteChip,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: remoteChip.x * canvas.width,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: remoteChip.y * canvas.height,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radius: (remoteChip.id === 0 ? CUE_BALL_RADIUS : BALL_RADIUS) * scale
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (data.gameType === 'poker') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deck = data.deck || [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerHand = (localPlayerId === 'player1') ? data.player1Hand : data.player2Hand;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opponentHand = (localPlayerId === 'player1') ? data.player2Hand : data.player1Hand;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  originalPlayerHand = (localPlayerId === 'player1') ? data.originalPlayer1Hand : data.originalPlayer2Hand;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  originalOpponentHand = (localPlayerId === 'player1') ? data.originalPlayer2Hand : data.originalPlayer1Hand;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (data.gameType === '61-ball') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  player61Score = (localPlayerId === 'player1') ? data.player1_61Score : data.player2_61Score;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opponent61Score = (localPlayerId === 'player1') ? data.player2_61Score : data.player1_61Score;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lowestChipNumber = data.lowestChipNumber;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (data.gameType === 'straight-ball') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colorsAssigned = data.colorsAssigned;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerChipsType = (localPlayerId === 'player1') ? data.player1ChipsType : data.player2ChipsType;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opponentChipsType = (localPlayerId === 'player1') ? data.player2ChipsType : data.player1ChipsType;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  updateInfoBox(); // I-update ang UI para ipakita ang mga pangalan

Â  Â  Â  Â  Â  Â  Â  Â  // --- â— SIMULA NG VS SCREEN TRIGGER â— ---
Â  Â  Â  Â  Â  Â  Â  Â  if (!vsScreenShownThisGame) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  vsScreenShownThisGame = true; // Markahan na naipakita na
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Kunin ang rank data
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const myRankInfo = getPlayerRank(playerLevel);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const opponentRankInfo = RANKS[opponentRankIndex] || RANKS[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ayusin kung sino si P1 at P2 sa display
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let player1Data, player2Data;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (localPlayerId === 'player1') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  player1Data = { name: localPlayerName, rankInfo: myRankInfo };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  player2Data = { name: opponentPlayerName, rankInfo: opponentRankInfo };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Kung ikaw si P2, dapat 'yung kalaban (P1) ang nasa kaliwa
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  player1Data = { name: opponentPlayerName, rankInfo: opponentRankInfo };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  player2Data = { name: localPlayerName, rankInfo: myRankInfo };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Tawagin ang function!
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showVsScreen(player1Data, player2Data, data.gameType);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // --- â— DULO NG VS SCREEN TRIGGER â— ---
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (data.gameState === 'finished' && gameState !== 'gameover') {
Â  Â  Â  Â  Â  Â  Â  Â  endGame(data.winner === localPlayerUid ? 'You Win!' : 'You Lose!', data);
Â  Â  Â  Â  Â  Â  Â  Â  isSyncing = false;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (gameState === 'playing') {
 Â  Â  Â  Â  Â  Â  Â  Â  if (opponentStatus === 'disconnected' && !isAiTakeoverActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isAiTakeoverActive = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Opponent disconnected. AI will take over.", 4000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opponentPlayerName = "AI Opponent"; // Palitan ang pangalan sa UI
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateInfoBox();
Â  Â  Â  Â  Â  Â  Â  Â  } else if (opponentStatus === 'online' && isAiTakeoverActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isAiTakeoverActive = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opponentPlayerName = data.players[opponentId]?.displayName || "Opponent"; // Ibalik ang pangalan
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateInfoBox();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Opponent has reconnected!", 4000);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  isMyTurnOnline = (data.currentTurnUid === localPlayerUid);
Â  Â  Â  Â  Â  Â  Â  Â  setCueForCurrentTurn();
Â  Â  Â  Â  Â  Â  Â  Â  if (!isMyTurnOnline && data.liveAimData && data.liveAimData.sender !== localPlayerUid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cueStick.visible = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cueStickElement) cueStickElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const liveAim = data.liveAimData;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cueChip = chips.find(c => c.id === 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.canMoveCueBall && cueChip) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cueChip.x = liveAim.cueBallX * canvas.width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cueChip.y = liveAim.cueBallY * canvas.height;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cueStick.angle = liveAim.angle;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cueStick.pullback = liveAim.pullback || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pektusOffset.x = liveAim.pektusX || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pektusOffset.y = liveAim.pektusY || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatePektusUI();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (data.turnId > lastProcessedTurnId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastProcessedTurnId = data.turnId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chipsMoving = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.chips && canvas.width > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chips = data.chips.map(remoteChip => ({ ...remoteChip,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: remoteChip.x * canvas.width,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: remoteChip.y * canvas.height,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radius: (remoteChip.id === 0 ? CUE_BALL_RADIUS : BALL_RADIUS) * scale
Â  Â  Â  Â  Â  Â   Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.gameType === 'poker') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerHand = (localPlayerId === 'player1') ? data.player1Hand : data.player2Hand;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opponentHand = (localPlayerId === 'player1') ? data.player2Hand : data.player1Hand;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  originalPlayerHand = (localPlayerId === 'player1') ? data.originalPlayer1Hand : data.originalPlayer2Hand;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  originalOpponentHand = (localPlayerId === 'player1') ? data.originalPlayer2Hand : data.originalPlayer1Hand;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (data.gameType === '61-ball') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  player61Score = (localPlayerId === 'player1') ? data.player1_61Score : data.player2_61Score;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opponent61Score = (localPlayerId === 'player1') ? data.player2_61Score : data.player1_61Score;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lowestChipNumber = data.lowestChipNumber;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (data.gameType === 'straight-ball') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colorsAssigned = data.colorsAssigned;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerChipsType = (localPlayerId === 'player1') ? data.player1ChipsType : data.player2ChipsType;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opponentChipsType = (localPlayerId === 'player1') ? data.player2ChipsType : data.player1ChipsType;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canMoveCueBall = data.canMoveCueBall;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isBreakShot = data.isBreakShot;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateCardDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateInfoBox(); // Tatawagin nito ang updateLegalTargetChips()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const message = data.isBreakShot ? (isMyTurnOnline ? "You break!" : `${opponentPlayerName}'s break!`) : (isMyTurnOnline ? "Your turn" : `${opponentPlayerName}'s turn`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMyTurnOnline && canMoveCueBall) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage(message, 3000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dragGuideText.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (!canMoveCueBall) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage(message, 2000);
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMyTurnOnline && !canMoveCueBall && gameState !== 'aiming') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // I-reset lang ang pektus kung:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. Turn KO na.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. HINDI ko ililipat ang cue ball (ibig sabihin, aiming na).
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. Hindi pa "aiming" ang state (para 'di ma-reset habang umaasinta).
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetPektus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (isMyTurnOnline) {
Â  Â  Â  Â   Â  Â  Â  Â  Â  Â  Â  gameState = canMoveCueBall ? 'moving' : 'aiming';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (gameState === 'aiming') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dragGuideText.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cueStick.visible = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cueStickElement) cueStickElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameState = 'aiming';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dragGuideText.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (isAiTakeoverActive && !isMyTurnOnline && !chipsMoving && !data.turnInProgress) {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("AI is playing for your opponent...", 2000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isAiTakeoverActive && !isMyTurnOnline && !chipsMoving) aiTurn();
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1500);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  isSyncing = false;
Â  Â  Â  Â  }
        function getAiChatMessage(event, lang = 'tl') { const messages = aiChatter[lang]?.[event]; if (!messages || messages.length === 0) { return ""; } return messages[Math.floor(Math.random() * messages.length)]; }
        function aiDisplayMessage(message) { if (message === "") return; const aiMessageBox = document.createElement('div'); aiMessageBox.style.position = 'absolute'; aiMessageBox.style.bottom = '80px'; aiMessageBox.style.right = '20px'; aiMessageBox.style.backgroundColor = 'rgba(0, 0, 0, 0.8)'; aiMessageBox.style.color = '#00FF00'; aiMessageBox.style.padding = '8px 15px'; aiMessageBox.style.borderRadius = '15px'; aiMessageBox.style.border = '1px solid rgba(0, 255, 0, 0.5)'; aiMessageBox.style.fontSize = '0.9em'; aiMessageBox.style.maxWidth = '200px'; aiMessageBox.style.textAlign = 'center'; aiMessageBox.style.zIndex = '250'; aiMessageBox.style.fontFamily = 'monospace'; aiMessageBox.style.boxShadow = '0 0 10px rgba(0, 255, 0, 0.3)'; aiMessageBox.textContent = `AI: "${message}"`; document.getElementById('game-wrapper').appendChild(aiMessageBox); setTimeout(() => { if (aiMessageBox) { aiMessageBox.remove(); } }, 4000); if (isAiVoiceEnabled) { if ('speechSynthesis' in window) { try { const utterance = new SpeechSynthesisUtterance(message); setTimeout(() => { window.speechSynthesis.cancel(); const voices = window.speechSynthesis.getVoices(); const filipinoVoice = voices.find(voice => voice.lang === 'fil-PH'); if (filipinoVoice) { utterance.voice = filipinoVoice; } utterance.pitch = 0.8; utterance.rate = 1.1; window.speechSynthesis.speak(utterance); }, 100); } catch (error) { console.error("AI Voice Error:", error); } } } }
        function toggleAiVoice() { isAiVoiceEnabled = !isAiVoiceEnabled; localStorage.setItem('pinoyPoolAiVoice', isAiVoiceEnabled); if (!isAiVoiceEnabled) { window.speechSynthesis.cancel(); } updateVoiceButtonIcon(); }
        function updateVoiceButtonIcon() { const voiceOnIcon = document.getElementById('voice-on-icon'); const voiceOffIcon = document.getElementById('voice-off-icon'); if (isAiVoiceEnabled) { voiceOnIcon.style.display = 'block'; voiceOffIcon.style.display = 'none'; } else { voiceOnIcon.style.display = 'none'; voiceOffIcon.style.display = 'block'; } }
        function playBackgroundMusic() { if (musicHasStarted) return; const playNextTrack = () => { currentTrackIndex = (currentTrackIndex + 1) % backgroundPlaylist.length; const nextPlayer = backgroundPlaylist[currentTrackIndex]; nextPlayer.currentTime = 0; nextPlayer.play(); }; backgroundPlaylist.forEach(player => { player.volume = 0.25; player.onended = playNextTrack; }); const initialPlayer = backgroundPlaylist[currentTrackIndex]; initialPlayer.play().catch(error => { console.log("Music play was prevented by the browser."); }); musicHasStarted = true; }
        /**
 * Binubuksan ang shop at ipinapakita ang mga items.
 * (ITO YUNG NAWAWALA MONG FUNCTION)
 */
function openShop() {
    playButtonSound();
    gameModeSelect.classList.remove('show');
    document.getElementById('shop-modal').classList.add('show');
    history.pushState({ modal: 'shopModal' }, 'Shop', '#shop');
    renderShopItems(); // Ito 'yung function na nag-lo-load ng items
}

/**
 * Naglo-load ng leaderboard.
 * (ITO YUNG MAY AYOS NA PARA SA ERROR KANINA)
 */
async function showLeaderboard() {
    leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Loading...</td></tr>';
    gameModeSelect.classList.remove('show');
    leaderboardModal.classList.add('show');
    history.pushState({ modal: 'leaderboardModal' }, 'Leaderboard', '#leaderboard');

    // â–¼â–¼â–¼ ITO YUNG AYOS: Iche-check muna kung ready na ang 'db' â–¼â–¼â–¼
    if (!firebaseInitialized || !db) {
        console.error("Firebase is not ready yet. (showLeaderboard)");
        leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Connecting to server... Please wait.</td></tr>';
        // Mag-try ulit after 1 segundo
        setTimeout(showLeaderboard, 1000);
        return; 
    }
    // â–²â–²â–² DULO NG AYOS â–²â–²â–²

    try {
        const playersRef = collection(db, "players");
        const q = query(playersRef, orderBy("wins", "desc"), limit(100));
        const querySnapshot = await getDocs(q);
        leaderboardBody.innerHTML = '';
        if (querySnapshot.empty) {
            leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">No players yet. Be the first!</td></tr>';
            return;
        }
        let rank = 1;
        querySnapshot.forEach((doc) => {
            const playerData = doc.data();
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="padding: 8px;">#${rank}</td>
                <td style="padding: 8px;">${playerData.displayName}</td>
                <td style="padding: 8px;">${playerData.wins}</td>
            `;
            leaderboardBody.appendChild(row);
            rank++;
        });
    } catch (error) {
        console.error("Error fetching leaderboard: ", error);
        leaderboardBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Could not load leaderboard. Check console for errors.</td></tr>';
        
        if (error.code === 'failed-precondition') {
             showMessage("Error: Database needs an index. Check the console (F12) for a link!", 5000);
        }
    }
}

/**
Â * Ito ang function na kukuha ng data at ipapakita ang VS Screen.
Â * player1 at player2 ay objects na may { name, rankInfo: { name, color } }
Â */
function showVsScreen(player1, player2, gameType) {
Â  Â  const modal = document.getElementById('vs-screen-modal');
Â  Â  if (!modal) return; // Safety check

Â  Â  // I-populate ang data para kay Player 1 (Ikaw)
Â  Â  document.getElementById('vs-player-1-name').textContent = player1.name;
Â  Â  document.getElementById('vs-player-1-rank').textContent = `[${player1.rankInfo.name}]`;
Â  Â  document.getElementById('vs-player-1-rank').style.color = player1.rankInfo.color;

Â  Â  // I-populate ang data para kay Player 2 (Kalaban)
Â  Â  document.getElementById('vs-player-2-name').textContent = player2.name;
Â  Â  document.getElementById('vs-player-2-rank').textContent = `[${player2.rankInfo.name}]`;
Â  Â  document.getElementById('vs-player-2-rank').style.color = player2.rankInfo.color;

Â  Â  // I-populate ang game mode
Â  Â  let gameModeText = "UNKNOWN GAME";
Â  Â  if (gameType === 'poker') gameModeText = "POKER POOL";
Â  Â  else if (gameType === 'straight-ball') gameModeText = "STRAIGHT BALL";
Â  Â  else if (gameType === '61-ball') gameModeText = "61 BALL";
Â  Â  document.getElementById('vs-game-mode').textContent = gameModeText;

Â  Â  // Ipakita ang modal!
Â  Â  modal.classList.add('show');

Â  Â  // Awtomatikong itatago ang modal pagkatapos ng 4 na segundo
Â  Â  // (3.5s delay + 0.5s fade-out animation = 4s total time)
Â  Â  setTimeout(() => {
Â  Â  Â  Â  modal.classList.remove('show');
Â  Â  }, 4000); 
}

// â–¼â–¼â–¼ IDAGDAG MO ITONG 5 FUNCTIONS PARA SA XP â–¼â–¼â–¼

/**
Â * Kinukuha ang Level at XP mula sa localStorage.
Â */
function loadPlayerStats() {
Â  Â  const savedLevel = localStorage.getItem('pinoyPoolPlayerLevel');
Â  Â  const savedXP = localStorage.getItem('pinoyPoolPlayerXP');
Â  Â Â 
Â  Â  playerLevel = savedLevel ? parseInt(savedLevel, 10) : 1;
Â  Â  playerXP = savedXP ? parseInt(savedXP, 10) : 0;
Â  Â Â 
Â  Â  // Kalkulahin kung magkano ang kailangan para sa next level
Â  Â  xpToNextLevel = calculateXPForLevel(playerLevel);Â 
Â  Â  updateXPDisplay(); // I-update agad ang UI
}

/**
Â * Sine-save ang Level at XP sa localStorage.
Â */
function savePlayerStats() {
Â  Â  localStorage.setItem('pinoyPoolPlayerLevel', playerLevel.toString());
Â  Â  localStorage.setItem('pinoyPoolPlayerXP', playerXP.toString());
}

/**
Â * Kino-compute kung gaano karaming XP ang kailangan para sa next level.
Â */
function calculateXPForLevel(level) {
Â  Â  // Formula: 100, 151, 218, 296... (mas tumatagal mag-level up)
Â  Â  return Math.floor(100 * Math.pow(level, 1.2));
}

/**
 * Nagpapakita ng "LEVEL UP!" popup.
 */
function showLevelUpPopup(newLevel, coinReward) {
    const popup = document.createElement('div');
    popup.innerHTML = `LEVEL UP!<br>You are now Level ${newLevel}<br>+${coinReward} ${CURRENCY_NAME}!`;
    
    // Kinopya ko ang style ng 'showColorAssignmentPopup' at ginawang GOLD
    popup.style.cssText = `
        position: absolute;
        left: 50%;
        top: 70px;
        transform: translateX(-50%) translateY(0);
        color: var(--gold-accent); /* GOLD! */
        font-size: 1.5em; /* Mas malaki pa! */
        font-weight: bold;
        font-family: 'Luckiest Guy', cursive;
        text-shadow: 2px 2px 5px rgba(0,0,0,0.9);
        z-index: 210;
        opacity: 1;
        transition: opacity 2.0s ease-out, transform 2.0s ease-out;
        pointer-events: none;
        text-align: center;
        padding: 10px 15px;
        background: rgba(0,0,0,0.7);
        border-radius: 10px;
        border: 2px solid var(--gold-accent);
    `;
    document.getElementById('non-interactive-overlay').appendChild(popup);
    
    // Animation logic
    setTimeout(() => {
        popup.style.opacity = '0';
        popup.style.transform = 'translateX(-50%) translateY(-30px)';
    }, 2500); // Mananatili ng 2.5 segundo bago mag-fade
    
    setTimeout(() => {
        popup.remove();
    }, 4500); // 2.5s + 2s fade = 4.5s
}

/**
Â * Ang function na tumatanggap ng XP at nagti-trigger ng Level Up.
Â */
function gainXP(amount) {
Â  Â  if (amount <= 0 || gameState === 'gameover') return;Â 

Â  Â  playerXP += amount;
Â  Â Â 
Â  Â  while (playerXP >= xpToNextLevel) {
Â  Â  Â  Â  playerLevel++;
Â  Â  Â  Â  playerXP -= xpToNextLevel;Â 
Â  Â  Â  Â  xpToNextLevel = calculateXPForLevel(playerLevel);Â 

Â  Â  Â  Â  playerTotalCurrency += LEVEL_UP_COIN_REWARD;
Â  Â  Â  Â  saveCurrency();Â 
Â  Â  Â  Â  updateCurrencyDisplay();Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Ito ang TAMA at BAGONG popup na nasa GITNA
Â  Â  Â  Â  showLevelUpPopup(playerLevel, LEVEL_UP_COIN_REWARD);
Â  Â  }

Â  Â  savePlayerStats();
Â  Â  updateXPDisplay();
}

/**
Â * Kinukuha ang Rank Name, Color, at Index base sa level ng player.
Â */
function getPlayerRank(level) {
Â  Â  let currentRank = RANKS[0]; // Default sa "Beginner"
Â  Â  let rankIndex = 0;

Â  Â  for (let i = 0; i < RANKS.length; i++) {
Â  Â  Â  Â  if (level >= RANKS[i].level) {
Â  Â  Â  Â  Â  Â  currentRank = RANKS[i];
Â  Â  Â  Â  Â  Â  rankIndex = i; // Sine-save natin 'yung index (0, 1, 2, 3, 4)
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  break; // Huminto na kapag hindi na umabot ang level
Â  Â  Â  Â  }
Â  Â  }
Â  Â  return { ...currentRank, index: rankIndex }; // Ibalik ang Rank (name, level, color) at 'yung index
}
// â–²â–²â–² HANGGANG DITO (Step 2) â–²â–²â–²
/**
/**
* Ina-update ang itsura ng XP bar sa UI. (Step 3A - May Ranks na!)
*/
function updateXPDisplay() {
Â  Â  const levelDisplay = document.getElementById('player-level-display');
Â  Â  const xpBarFill = document.getElementById('xp-bar-fill-new');Â 
Â  Â  const xpText = document.getElementById('xp-text-display-new');Â 

Â  Â  // Kunin ang rank ng player!
Â  Â  const rankInfo = getPlayerRank(playerLevel);Â 

Â  Â  if (levelDisplay) {
Â  Â  Â  Â  // Ilagay ang pangalan ng rank at kulayan ito
Â  Â  Â  Â  // levelDisplay.innerHTML = `<span style="color: ${rankInfo.color};">${rankInfo.name}</span>`; // <--- NILAGYAN KO NG '//' PARA ITAGO

Â  Â  Â  Â  // (Kung gusto mong ibalik 'yung level number, pwede mong gawin 'to:)
Â  Â  Â  Â  // (Kung gusto mong ibalik 'yung level number, pwede mong gawin 'to:)
Â  Â  Â  Â  levelDisplay.innerHTML = `<span style="color: ${rankInfo.color};">[${rankInfo.name}]</span> Lv. ${playerLevel}`; // <--- May "Lv." dito
Â  Â  }
Â  Â  if (xpBarFill) {
Â  Â  Â  Â  const percentage = (playerXP / xpToNextLevel) * 100;
Â  Â  Â  Â  xpBarFill.style.width = `${Math.max(0, Math.min(100, percentage))}%`;
Â  Â  }
Â  Â  if (xpText) {
Â  Â  Â  Â  xpText.textContent = `${Math.floor(playerXP)}/${xpToNextLevel}`;
Â  Â  }
}
        function initializeFirebase() { try { onlineButton.textContent = "Connecting..."; onlineButton.disabled = true; const firebaseConfig = { apiKey: "AIzaSyD0gZfJxpA_4fO-SEOjX9JNs0v7IzQ0iSc", authDomain: "pinoy-pool-master.firebaseapp.com", projectId: "pinoy-pool-master", storageBucket: "pinoy-pool-master.appspot.com", messagingSenderId: "1003592334290", appId: "1:1003592334290:web:2982cdc8691e8ef7c6260b" }; const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
                rtdb = getDatabase(app); // <-- Idagdag ito
 signInPlayer(); firebaseInitialized = true; } catch (error) { console.warn("Firebase failed.", error); firebaseInitialized = false; onlineButton.textContent = "Offline"; onlineButton.disabled = true; } }
// Idagdag itong 3 bagong functions
function loadCurrency() {
    // Kinukuha ang na-save na currency sa browser
    const savedCurrency = localStorage.getItem('pinoyPoolCurrency');
    playerTotalCurrency = savedCurrency ? parseInt(savedCurrency, 10) : 0;
    updateCurrencyDisplay();
}

function loadPlayerName() {
Â  Â  const savedPlayerName = localStorage.getItem('pinoyPoolPlayerName');
Â  Â  if (savedPlayerName) {
Â  Â  Â  Â  localPlayerName = savedPlayerName;
Â  Â  Â  Â  return true; // May pangalan na (Returning Player)
Â  Â  } else {
Â  Â  Â  Â  localPlayerName = "Guest"; // Pansamantalang pangalan
Â  Â  Â  Â  return false; // Walang pangalan (New Player)
Â  Â  }
}

// â–¼ IDAGDAG MO ITONG MGA BAGONG FUNCTIONS â–¼

/**
 * Naglo-load ng inventory at equipped items galing sa localStorage.
 */
function loadInventory() {
    const savedInventory = localStorage.getItem('pinoyPoolInventory');
    const savedEquipped = localStorage.getItem('pinoyPoolEquipped');

    if (savedInventory) {
        playerInventory = JSON.parse(savedInventory);
    } else {
        // Siguraduhin na laging may 'default'
        playerInventory = { cues: ['default'] };
    }

    if (savedEquipped) {
        equippedItems = JSON.parse(savedEquipped);
    } else {
        equippedItems = { cue: 'default' };
    }

    // Tiyakin na ang equipped item ay kasama sa inventory
    if (!playerInventory.cues.includes(equippedItems.cue)) {
        equippedItems.cue = 'default';
    }
    
    saveInventory(); // I-save para sure
}

/**
 * Sine-save ang inventory at equipped items sa localStorage.
 */
function saveInventory() {
    localStorage.setItem('pinoyPoolInventory', JSON.stringify(playerInventory));
    localStorage.setItem('pinoyPoolEquipped', JSON.stringify(equippedItems));
}

/**
 * Binubuksan ang Friends modal at sinisimulan ang pag-load ng TOTOONG lists.
 */
function openFriendsModal() {
    playButtonSound();
    
    // Kunin ang modal
    const modal = document.getElementById('friends-modal');
    
    // I-clear muna ang mga lumang laman
    document.getElementById('friends-list-pending').innerHTML = '<div class="friend-item-empty">Loading...</div>';
    document.getElementById('friends-list-accepted').innerHTML = '<div class="friend-item-empty">Loading...</div>';
    document.getElementById('friend-search-results').innerHTML = '';
    document.getElementById('friend-search-input').value = '';

    // Ipakita ang modal
    modal.classList.add('show');
    history.pushState({ modal: 'friendsModal' }, 'Friends', '#friends');

    // Simulan ang pag-load ng TOTOONG data
    loadFriendsList(); 
}

/**
 * Async function na kumukuha ng TOTOONG data mula sa Firestore at tinatawag ang render functions.
 */
async function loadFriendsList() {
    // Siguraduhin na may user at database
    if (!localPlayerUid || !db) {
        document.getElementById('friends-list-pending').innerHTML = '<div class="friend-item-empty">Error: Not connected.</div>';
        document.getElementById('friends-list-accepted').innerHTML = '<div class="friend-item-empty">Error: Not connected.</div>';
        return;
    }

    const pendingListUI = document.getElementById('friends-list-pending');
    const acceptedListUI = document.getElementById('friends-list-accepted');

    // I-clear muna
    pendingListUI.innerHTML = '';
    acceptedListUI.innerHTML = '';

    let hasPending = false;
    let hasAccepted = false;
    
    // --- Query 1: Kunin ang Pending Requests (na IKAW ang in-invite) ---
    try {
        const qPending = query(collection(db, "friendships"), 
            where("requestedTo", "==", localPlayerUid), 
            where("status", "==", "pending")
        );
        const pendingSnapshot = await getDocs(qPending);
        
        pendingSnapshot.forEach((doc) => {
            hasPending = true;
            // Gagamitin na natin ang renderFriendItem para ipakita
            renderFriendItem(pendingListUI, doc.id, doc.data(), "pending");
        });
    } catch (e) { console.error("Error loading pending friends:", e); }

    // --- Query 2: Kunin ang Accepted Friends ---
    try {
        const qAccepted = query(collection(db, "friendships"), 
            where("uids", "array-contains", localPlayerUid), 
            where("status", "==", "accepted")
        );
        const acceptedSnapshot = await getDocs(qAccepted);

        acceptedSnapshot.forEach((doc) => {
            hasAccepted = true;
            // Gagamitin na natin ang renderFriendItem para ipakita
            renderFriendItem(acceptedListUI, doc.id, doc.data(), "accepted");
        });
    } catch (e) { console.error("Error loading accepted friends:", e); }

    // Maglagay ng "empty" message kung walang laman
    if (!hasPending) {
        pendingListUI.innerHTML = '<div class="friend-item-empty">No pending requests.</div>';
    }
    if (!hasAccepted) {
        acceptedListUI.innerHTML = '<div class="friend-item-empty">You have no friends yet.</div>';
    }
}

/**
 * Gumagawa ng HTML para sa isang friend item at nilalagay ito sa listahan.
 * (Ito ay galing pa sa Step 3.B, pero kailangan pa rin ito)
 */
function renderFriendItem(listElement, docId, data, type) {
    // Alamin kung sino ang kaibigan (hindi ikaw)
    const friendUid = data.uids.find(uid => uid !== localPlayerUid);
    if (!friendUid) return; // Error case

    // Kunin ang info ng kaibigan
    const friendName = data.names[friendUid] || "Unknown";
    const friendLevel = data.levels[friendUid] || 1;
    
    // Gamitin ang existing function mo para kunin ang rank!
    const rankInfo = getPlayerRank(friendLevel);

    // Gumawa ng bagong <div> para sa item
    const itemDiv = document.createElement('div');
    itemDiv.className = 'friend-item';
    itemDiv.id = `friend-item-${docId}`; // Para madaling tanggalin sa UI

    let buttonsHtml = '';
    if (type === "pending") {
        // Nag-request sa'yo: Accept | Decline
        buttonsHtml = `
            <button class="menu-button lobby-button accept-btn" data-doc-id="${docId}">Accept</button>
            <button class="menu-button lobby-button decline-btn" data-doc-id="${docId}">Decline</button>
        `;
    } else if (type === "accepted") {
        // Kaibigan mo na: Invite | Unfriend
        buttonsHtml = `
            <button class="menu-button lobby-button invite-btn" data-friend-uid="${friendUid}" data-friend-name="${friendName}">Invite</button>
            <button class="menu-button lobby-button decline-btn" data-doc-id="${docId}">Unfriend</button>
        `;
    }

    itemDiv.innerHTML = `
        <div class="friend-info">
            <span class="friend-name">${friendName}</span>
            <span class="friend-rank" style="color: ${rankInfo.color};">[${rankInfo.name}]</span>
        </div>
        <div class="friend-actions">
            ${buttonsHtml}
        </div>
    `;

    // Idagdag ang item sa tamang listahan sa UI
    listElement.appendChild(itemDiv);

    // --- MAGDAGDAG NG EVENT LISTENERS SA MGA BAGONG BUTTON ---
    
    const acceptBtn = itemDiv.querySelector('.accept-btn');
    if (acceptBtn) {
        acceptBtn.addEventListener('click', () => {
            playButtonSound();
            acceptFriendRequest(acceptBtn.dataset.docId);
        });
    }

    const declineBtn = itemDiv.querySelector('.decline-btn');
    if (declineBtn) {
        declineBtn.addEventListener('click', () => {
            playButtonSound();
            declineOrUnfriend(declineBtn.dataset.docId);
        });
    }
    
    const inviteBtn = itemDiv.querySelector('.invite-btn');
    if (inviteBtn) {
        inviteBtn.addEventListener('click', () => {
            playButtonSound();
            inviteFriend(inviteBtn.dataset.friendUid, inviteBtn.dataset.friendName);
        });
    }
}


/**
 * Nagse-search ng players sa Firebase at ipinapakita ang results. (VERSION 2 - Fixed)
 */
async function searchAndAddFriend() {
    playButtonSound();
    const searchInput = document.getElementById('friend-search-input');
    const searchResultsUI = document.getElementById('friend-search-results');
    const searchTerm = searchInput.value.trim();
    
    // 1. GAGAWIN NATING LOWERCASE ANG SEARCH TERM
    const searchTermLower = searchTerm.toLowerCase(); 

    if (searchTerm.length < 3) {
        showMessage("Please enter at least 3 letters to search.", 2000);
        return;
    }
    
    if (searchTermLower === localPlayerName.toLowerCase()) {
         searchResultsUI.innerHTML = '<div class="friend-item-empty">You cannot add yourself.</div>';
        return;
    }

    searchResultsUI.innerHTML = `<div class="friend-item-empty">Searching for "${searchTermLower}"...</div>`;

    try {
        const playersRef = collection(db, "players");
        
        // 2. HAHANAPIN NA NATIN YUNG BAGONG FIELD NA "searchableName"
        const q = query(playersRef, 
            where("searchableName", ">=", searchTermLower),
            where("searchableName", "<=", searchTermLower + '\uf8ff') 
        );

        const querySnapshot = await getDocs(q);
        
        searchResultsUI.innerHTML = ''; // Linisin ang "Searching..."

        if (querySnapshot.empty) {
            searchResultsUI.innerHTML = `<div class="friend-item-empty">No players found.</div>`;
            return;
        }

        const allMyRelations = await getDocs(query(collection(db, "friendships"), where("uids", "array-contains", localPlayerUid)));
        const existingRelations = new Map();
        allMyRelations.forEach(doc => {
            const data = doc.data();
            const friendUid = data.uids.find(uid => uid !== localPlayerUid);
            existingRelations.set(friendUid, {status: data.status, docId: doc.id}); // I-save din ang Doc ID
        });

        let resultsFound = 0;
        querySnapshot.forEach((doc) => {
            const playerData = doc.data();
            const playerUid = doc.id;

            if (playerUid === localPlayerUid) return;
            resultsFound++;
            
            const rankInfo = getPlayerRank(playerData.level || 1);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'friend-item';

            let buttonHtml = '';
            const relation = existingRelations.get(playerUid);

            if (relation && relation.status === "accepted") {
                buttonHtml = `<button class="shop-buy-button equipped" disabled>Already Friends</button>`;
            } else if (relation && relation.status === "pending") {
                // I-check kung sino ang nag-request
                const requestDoc = allMyRelations.docs.find(d => d.id === relation.docId);
                const requestData = requestDoc?.data();

                if (requestData && requestData.requestedBy === localPlayerUid) {
                    buttonHtml = `<button class="shop-buy-button equipped" disabled>Request Sent</button>`;
                } else {
                    // Siya ang nag-request sa'yo, kaya pwede mong i-accept
                    buttonHtml = `<button class="menu-button lobby-button accept-btn" data-doc-id="${relation.docId}">Accept Request</button>`;
                }
            } else {
                // Wala pang relasyon
                buttonHtml = `<button class="menu-button lobby-button accept-btn" data-player-uid="${playerUid}" data-player-name="${playerData.displayName}" data-player-level="${playerData.level || 1}">Send Request</button>`;
            }

            itemDiv.innerHTML = `
                <div class="friend-info">
                    <span class="friend-name">${playerData.displayName}</span>
                    <span class="friend-rank" style="color: ${rankInfo.color};">[${rankInfo.name}]</span>
                </div>
                <div class="friend-actions">
                    ${buttonHtml}
                </div>
            `;
            searchResultsUI.appendChild(itemDiv);

            // Listener para sa "Send Request"
            const sendBtn = itemDiv.querySelector('.accept-btn[data-player-uid]');
            if (sendBtn) {
                sendBtn.addEventListener('click', (e) => {
                    const target = e.currentTarget;
                    sendFriendRequest(target.dataset.playerUid, target.dataset.playerName, target.dataset.playerLevel);
                    target.textContent = "Sent!";
                    target.disabled = true;
                });
            }
            
            // Listener para sa "Accept Request"
             const acceptBtn = itemDiv.querySelector('.accept-btn[data-doc-id]');
            if (acceptBtn) {
                acceptBtn.addEventListener('click', (e) => {
                    acceptFriendRequest(e.currentTarget.dataset.docId);
                    e.currentTarget.textContent = "Accepted!";
                    e.currentTarget.disabled = true;
                });
            }
        });

        if (resultsFound === 0) {
             searchResultsUI.innerHTML = `<div class="friend-item-empty">No players found.</div>`;
        }

    } catch (error) {
        console.error("Error searching friends:", error);
        searchResultsUI.innerHTML = `<div class="friend-item-empty">Error loading results. Check console (F12).</div>`;
        
        // IPAPAKITA KO ANG INDEXING ERROR DITO
        if (error.code === 'failed-precondition') {
             showMessage("Error: Database needs an index. Check the console (F12) for a link!", 5000);
        }
    }
}
/**
 * Gagawa ng bagong 'friendships' document na may status na "pending".
 * (Ito 'yung galing sa Step 5.B)
 */
async function sendFriendRequest(targetUid, targetName, targetLevel) {
    playButtonSound();
    
    // Tiyakin na may data bago i-send
    if (!localPlayerUid || !targetUid || !targetName) {
        showMessage("Error: Cannot send request.", 2000);
        return;
    }
    
    // I-convert ang targetLevel sa numero
    const friendLevel = parseInt(targetLevel, 10) || 1;

    try {
        // Gawa ng bagong document
        await addDoc(collection(db, "friendships"), {
            uids: [localPlayerUid, targetUid],
            requestedBy: localPlayerUid,
            requestedTo: targetUid,
            status: "pending",
            // Isama ang info ng parehong player
            names: {
                [localPlayerUid]: localPlayerName,
                [targetUid]: targetName
            },
            levels: {
                [localPlayerUid]: playerLevel,
                [targetUid]: friendLevel
            },
            createdAt: serverTimestamp()
        });

        showMessage(`Friend request sent to ${targetName}!`, 2000);
        
        // I-update ang search results UI para ipakita ang "Sent!"
        // (Handled na ito ng event listener sa searchAndAddFriend)

    } catch (error) {
        console.error("Error sending friend request:", error);
        showMessage("Error: Could not send request.", 2000);
    }
}

/**
 * Ina-update ang status ng request sa "accepted".
 * (Ito 'yung galing sa Step 6.D)
 */
async function acceptFriendRequest(docId) {
    if (!docId) return;
    playButtonSound();
    
    try {
        // Ito ang Firebase code para i-update ang status
        const friendshipDocRef = doc(db, "friendships", docId);
        await updateDoc(friendshipDocRef, { 
            status: "accepted" 
        });
        
        // Tanggalin sa "Pending" UI at i-refresh ang lists
        document.getElementById(`friend-item-${docId}`)?.remove();
        loadFriendsList(); // I-reload lahat para lumipat sa "My Friends"
        showMessage("Friend request accepted!", 2000);

    } catch (error) {
        console.error("Error accepting request:", error);
        showMessage("Error: Could not accept request.", 2000);
    }
}

/**
 * Binubura ang 'friendships' document (para sa decline o unfriend).
 * (Ito 'yung galing sa Step 6.E)
 */
async function declineOrUnfriend(docId) {
    if (!docId) return;
    playButtonSound();

    // Kumpirmahin muna
    const confirmed = confirm("Are you sure you want to remove this player?");
    if (!confirmed) {
        return; // Huwag ituloy kung na-cancel
    }

    try {
        // Ito ang Firebase code para burahin ang document
        const friendshipDocRef = doc(db, "friendships", docId);
        await deleteDoc(friendshipDocRef);
        
        // Tanggalin agad sa UI
        document.getElementById(`friend-item-${docId}`)?.remove();
        showMessage("Friend removed.", 2000);
        
        // I-check ulit kung naging empty ang lists
        loadFriendsList(); 

    } catch (error) {
        console.error("Error removing friend:", error);
        showMessage("Error: Could not remove friend.", 2000);
    }
}

/**
 * Dito magsisimula ang pag-imbita.
 * Ipinapakita nito ang "Select Game Type" modal.
 * @param {string} friendUid - Ang UID ng iimbitahin.
 * @param {string} friendName - Ang pangalan ng iimbitahin.
 */
async function inviteFriend(friendUid, friendName) {
    playButtonSound();

    // 1. I-save muna natin ang info ng friend sa global variables
    tempInviteFriendUid = friendUid;
    tempInviteFriendName = friendName;

    // 2. Ipakita ang "Select Game" modal
    document.getElementById('invite-friend-name-display').textContent = friendName;
    document.getElementById('invite-game-select').classList.add('show');
    history.pushState({ modal: 'inviteGameSelect' }, 'Select Game', '#invite-game');
}

/**
 * Tinatawag ito ng mga game mode button.
 * Ito ang gumagawa ng invite document sa Firebase.
 * @param {string} selectedGameType - Ang larong pinili ("poker", "straight-ball", "61-ball")
 */
async function sendInvite(selectedGameType) {
    // Kunin ang na-save na info
    const friendUid = tempInviteFriendUid;
    const friendName = tempInviteFriendName;

    if (!friendUid || !friendName) {
        showMessage("Error: Friend info lost.", 2000);
        return;
    }

    // Itago ang "Select Game" modal
    document.getElementById('invite-game-select').classList.remove('show');
    if (history.state && history.state.modal === 'inviteGameSelect') {
        history.back();
    }
    
    // Ipakita ang "Waiting..." modal
    const modal = document.getElementById('invite-wait-modal');
    document.getElementById('invite-wait-text').textContent = `Waiting for ${friendName} to accept...`;
    modal.classList.add('show');

    let inviteId = null;
    let unsubscribe = null;

    try {
        // 1. Gumawa ng "invite" document gamit ang napiling game type
        const newInviteRef = await addDoc(collection(db, "game_invites"), {
            fromUid: localPlayerUid,
            fromName: localPlayerName,
            toUid: friendUid,
            gameType: selectedGameType, // <-- GAGAMITIN NA ANG NAPILI
            status: "pending",
            gameId: null,
            createdAt: serverTimestamp()
        });

        inviteId = newInviteRef.id;

        // 2. Mag-listen sa 'invite' document
        unsubscribe = onSnapshot(doc(db, "game_invites", inviteId), (docSnap) => {
            if (!docSnap.exists()) {
                if(unsubscribe) unsubscribe();
                modal.classList.remove('show');
                return;
            }
            const inviteData = docSnap.data();
            if (inviteData.status === "accepted") {
                if(unsubscribe) unsubscribe();
                createPrivateGame(inviteData, inviteId);
            } else if (inviteData.status === "declined") {
                if(unsubscribe) unsubscribe();
                modal.classList.remove('show');
                showMessage(`${friendName} declined the invite.`, 2000);
            }
        });

        // 3. I-handle ang "Cancel" button
        const closeBtn = document.getElementById('invite-wait-close-btn');
        const newCloseBtn = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
        
        newCloseBtn.addEventListener('click', () => {
            if(unsubscribe) unsubscribe();
            deleteDoc(doc(db, "game_invites", inviteId));
            modal.classList.remove('show');
        }, { once: true });

    } catch (error) {
        console.error("Error sending invite:", error);
        modal.classList.remove('show');
        showMessage("Error: Could not send invite. Check rules.", 3000);
        if (inviteId && !unsubscribe) {
             deleteDoc(doc(db, "game_invites", inviteId));
        }
    }
}
/**
 * Tatawagin kapag tinanggap ng player (Player B) ang imbitasyon.
 * @param {string} inviteId - Ang ID ng invite document.
 */
async function handleInviteAccept(inviteId) {
    if (!inviteId) return;

    // Magpakita ng "Joining..." modal
    const modal = document.getElementById('invite-wait-modal');
    document.getElementById('invite-wait-text').textContent = "Joining game...";
    document.getElementById('invite-wait-close-btn').style.display = 'none'; // Bawal i-cancel
    modal.classList.add('show');

    let unsubscribe = null; // Listener para sa pag-join

    try {
        // 1. I-update ang status ng invite sa "accepted"
        const inviteDocRef = doc(db, "game_invites", inviteId);
        await updateDoc(inviteDocRef, { status: "accepted" });

        // 2. Ngayon, mag-listen ka sa document na 'yan hanggang sa
        //    maglagay si Player A (ang nag-imbita) ng gameId
        unsubscribe = onSnapshot(inviteDocRef, (docSnap) => {
            if (!docSnap.exists() || docSnap.data().status === "declined") {
                // Na-cancel o binura
                if(unsubscribe) unsubscribe();
                modal.classList.remove('show');
                showMessage("Invite was cancelled.", 2000);
                return;
            }

            const inviteData = docSnap.data();
            
            // 3. MAY GAME ID NA! JOIN NA!
            if (inviteData.gameId) {
                if(unsubscribe) unsubscribe(); // Itigil na ang pakikinig
                modal.classList.remove('show');
                
                // Gamitin ang existing function mo para sumali!
                localPlayerId = 'player2'; // Ikaw ang Player 2
                gameId = inviteData.gameId; // Itakda ang global game ID
                listenToGameUpdates(gameId); // Sumali sa laro
            }
            // (Kung wala pang gameId, maghihintay lang)
        });

    } catch (error) {
        console.error("Error accepting invite:", error);
        if(unsubscribe) unsubscribe();
        modal.classList.remove('show');
        showMessage("Error: Could not accept invite.", 3000);
    }
}

/**
 * Tatawagin kapag ni-decline ng player (Player B) ang imbitasyon.
 * @param {string} inviteId - Ang ID ng invite document.
 */
async function handleInviteDecline(inviteId) {
    if (!inviteId) return;
    try {
        // I-update lang ang status sa "declined"
        // (Pwede ring i-delete, pero mas maganda 'to para malaman ni Player A)
        const inviteDocRef = doc(db, "game_invites", inviteId);
        await updateDoc(inviteDocRef, { status: "declined" });
    } catch (error) {
        console.error("Error declining invite:", error);
    }
}

/**
 * Gagawa ng private game (Player A) pagkatapos i-accept ni Player B.
 * @param {object} inviteData - Ang data mula sa invite document.
 * @param {string} inviteId - Ang ID ng invite document.
 */
async function createPrivateGame(inviteData, inviteId) {
    
    // Kunin ang info ng kalaban
    const friendUid = inviteData.toUid;
    // Kunin ang pangalan ng friend mula sa invite data
    const friendName = inviteData.fromName === localPlayerName ? inviteData.toName : inviteData.fromName;

    // 1. Gawa ng bagong Game ID
    const newGameId = Math.random().toString(36).substring(2, 7).toUpperCase();
    
    // 2. I-setup ang laro (gaya ng ginawa mo sa createOnlineGame)
    resizeCanvas();
    gameMode = `online-${inviteData.gameType}`;
    setupChips();
    const initialChipsToSend = chips.map(c => ({...c, x: c.x/canvas.width, y: c.y/canvas.height }));
    const startingPlayerUid = Math.random() < 0.5 ? localPlayerUid : friendUid;

    // Kunin ang info ng players (level, cue, atbp.)
    const myPlayerInfo = {
        uid: localPlayerUid,
        status: 'online',
        displayName: localPlayerName,
        equippedCueId: equippedItems.cue,
        rankIndex: getPlayerRank(playerLevel).index
    };

    // Kunin natin ang info ng friend mo sa database
    let friendPlayerInfo;
    try {
        const friendDoc = await getDoc(doc(db, "players", friendUid));
        if (friendDoc.exists()) {
            const friendData = friendDoc.data();
            friendPlayerInfo = {
                uid: friendUid,
                status: 'online', // Assume na online kasi naka-accept
                displayName: friendData.displayName,
                equippedCueId: friendData.equippedCueId || 'default',
                rankIndex: getPlayerRank(friendData.level || 1).index
            };
        }
    } catch (e) { /* Error */ }

    // Fallback kung hindi makuha info ni friend
    if (!friendPlayerInfo) {
        friendPlayerInfo = {
            uid: friendUid, status: 'online', displayName: (friendName || "Friend"),
            equippedCueId: 'default', rankIndex: 0
        };
    }

    // 3. Ihanda ang buong game data
    let gameData = {
        gameId: newGameId,
        gameType: inviteData.gameType,
        gameState: 'playing',
        turnId: 1,
        players: {
            player1: myPlayerInfo,
            player2: friendPlayerInfo
        },
        chips: initialChipsToSend,
        currentTurnUid: startingPlayerUid,
        lastShot: null, liveAimData: null, turnInProgress: false,
        canMoveCueBall: true, isBreakShot: true, winner: null
    };

    // 4. Idagdag ang game-specific data
    if (inviteData.gameType === 'poker') {
        createDeck();
        dealCards(); // Gagawa 'to ng playerHand at opponentHand
        Object.assign(gameData, { 
            deck, 
            player1Hand: playerHand, // Player A's hand
            player2Hand: opponentHand, // Player B's hand
            originalPlayer1Hand: originalPlayerHand, 
            originalPlayer2Hand: originalOpponentHand 
        });
    } else if (inviteData.gameType === 'straight-ball') {
        Object.assign(gameData, { colorsAssigned: false, player1ChipsType: null, player2ChipsType: null });
    } else if (inviteData.gameType === '61-ball') {
        Object.assign(gameData, { player1_61Score: 0, player2_61Score: 0, lowestChipNumber: 1 });
    }

    try {
        // 5. Gawaing ang laro sa database
        const gameDocRef = doc(db, "games", newGameId);
        await setDoc(gameDocRef, gameData);

        // 6. I-update ang invite document ng GID para makasali si Player B
        await updateDoc(doc(db, "game_invites", inviteId), {
            gameId: newGameId
        });
        
        // 7. Itago ang "Waiting" modal
        document.getElementById('invite-wait-modal').classList.remove('show');
        
        // 8. Ikaw (Player A) ay sumali na sa laro
        localPlayerId = 'player1';
        gameId = newGameId; // Itakda ang global game ID
        listenToGameUpdates(gameId); // Sumali sa laro

    } catch (error) {
        console.error("Error creating private game:", error);
        document.getElementById('invite-wait-modal').classList.remove('show');
        showMessage("Error: Could not create game.", 3000);
    }
}

/**
 * Gumuguhit ng mga items sa loob ng shop modal.
 */
function renderShopItems() {
    const container = document.getElementById('shop-items-container');
    
    // ITO ANG MAHALAGA: Tinitiyak nito na binubura muna
    // ang anumang lumang HTML bago mag-load ng bago.
    container.innerHTML = ''; // Linisin muna

    SHOP_ITEMS.cues.forEach(item => {
        const isOwned = playerInventory.cues.includes(item.id);
        const isEquipped = (equippedItems.cue === item.id);

        const itemDiv = document.createElement('div');
        itemDiv.className = 'shop-item';

        // --- SIMULA NG STATS HTML ---
        let statsHtml = '';
        if (item.stats) {
            statsHtml = '<div class="shop-item-stats">';
            const maxStat = 10; 

            if (item.stats.Power) {
                const powerPercent = (item.stats.Power / maxStat) * 100;
                statsHtml += `
                    <div class="stat-entry">
                        <span class="stat-label">Power</span>
                        <div class="stat-bar-background">
                            <div class="stat-bar-fill power" style="width: ${powerPercent}%;"></div>
                        </div>
                    </div>`;
            }
            if (item.stats.Aim) {
                const aimPercent = (item.stats.Aim / maxStat) * 100;
                statsHtml += `
                    <div class="stat-entry">
                        <span class="stat-label">Aim</span>
                        <div class="stat-bar-background">
                            <div class="stat-bar-fill aim" style="width: ${aimPercent}%;"></div>
                        </div>
                    </div>`;
            }
            if (item.stats.Spin) {
                const spinPercent = (item.stats.Spin / maxStat) * 100;
                statsHtml += `
                    <div class="stat-entry">
                        <span class="stat-label">Spin</span>
                        <div class="stat-bar-background">
                            <div class="stat-bar-fill spin" style="width: ${spinPercent}%;"></div>
                        </div>
                    </div>`;
            }
            statsHtml += '</div>';
        }
        // --- TAPOS NG STATS HTML ---

        let buttonHtml = '';
        if (isEquipped) {
            buttonHtml = `<button class="shop-buy-button equipped" disabled>Equipped</button>`;
        } else if (isOwned) {
            buttonHtml = `<button class="shop-buy-button equip" data-item-id="${item.id}">Equip</button>`;
        } else {
            if (playerTotalCurrency >= item.price) {
                buttonHtml = `<button class="shop-buy-button buy" data-item-id="${item.id}">Buy (${item.price} ${CURRENCY_NAME})</button>`;
            } else {
                buttonHtml = `<button class="shop-buy-button disabled" data-item-id="${item.id}" disabled>Buy (${item.price} ${CURRENCY_NAME})</button>`;
            }
        }

        itemDiv.innerHTML = `
            <div class="shop-item-preview" style="background-image: url('${item.imageSrc}');"></div>
            <div class="shop-item-name">${item.name}</div>
            ${statsHtml}
            ${buttonHtml}
        `;
        
        container.appendChild(itemDiv);
    });

    // Idagdag ang event listeners sa mga bagong gawang buttons
    container.querySelectorAll('.shop-buy-button').forEach(button => {
        if (!button.disabled) {
            button.addEventListener('click', () => {
                playButtonSound();
                handleShopAction(button.dataset.itemId);
            });
        }
    });
}

// â–²â–²â–² HANGGANG DITO ANG IPAPALIT â–²â–²â–²

/**
 * Ang logic kapag pinindot ang "Buy" o "Equip" button.
 */
function handleShopAction(itemId) {
    const item = SHOP_ITEMS.cues.find(i => i.id === itemId);
    if (!item) return;

    const isOwned = playerInventory.cues.includes(item.id);

    if (isOwned) {
        // --- EQUIP LOGIC ---
        equippedItems.cue = item.id;
        saveInventory();
        applyEquippedItems(); // Palitan agad ang itsura ng tako
        renderShopItems(); // I-refresh ang shop UI
        showMessage(`Equipped: ${item.name}!`, 2000);

if (localPlayerUid && db) { // Siguraduhing may user ID at database connection
            const playerDocRef = doc(db, "players", localPlayerUid);
            setDoc(playerDocRef, { equippedCueId: item.id }, { merge: true })
                .then(() => {
                    console.log("Equipped cue saved to Firestore.");
                })
                .catch((error) => {
                    console.error("Error saving equipped cue to Firestore:", error);
                    // Opsyonal: Magpakita ng message sa user kung hindi na-save
                    // showMessage("Error: Could not save cue preference online.", 3000);
                });
        }

    } else {
        // --- BUY LOGIC ---
        if (playerTotalCurrency >= item.price) {
            // Bawasan ang pera
            playerTotalCurrency -= item.price;
            localStorage.setItem('pinoyPoolCurrency', playerTotalCurrency.toString());
            updateCurrencyDisplay();
            
            // Idagdag sa inventory
            playerInventory.cues.push(item.id);
            saveInventory();
            
            // I-refresh ang shop UI
            renderShopItems();
            showMessage(`Purchased: ${item.name}!`, 2000);

        } else {
            // Kulang ang pera
            showMessage("Not enough coins!", 2000);
        }
    }
}

// â–¼ PALITAN MO ITONG BUONG FUNCTION â–¼
/**
 * Ina-apply lang ang equipped item sa game state, 
 * tapos tinatawag ang setCueForCurrentTurn para i-update ang display.
 */
function applyEquippedItems() {
    // Hindi na ito direktang magse-set ng src at style.
    // Tinatawag na lang natin 'yung function na gagawa nun.
    setCueForCurrentTurn(); 
}
// â–² END NG PAGPALIT â–²

// â–¼ IDAGDAG MO ITONG BAGONG FUNCTION â–¼

/**
 * Sine-set ang itsura at sukat ng tako na ipapakita,
 * depende kung player ba o AI ang titira.
 */
function setCueForCurrentTurn() {
    let isPlayerShooting = false;
    // Titingnan natin kung nasa laro ba tayo at kung turn ng player
    if (gameState !== 'menu' && gameState !== 'gameover') {
         // Sa online game, isMyTurnOnline ang basehan. Sa AI game, playerTurn.
        isPlayerShooting = isOnlineGame ? isMyTurnOnline : playerTurn; 
    } else {
        // Kung nasa menu (like shop), assume na player ang context
        isPlayerShooting = true; 
    }

    let cueIdToUse;
    if (isPlayerShooting) {
        // Kung player ang titira, gamitin ang naka-equip
        cueIdToUse = equippedItems.cue;
    } else {
        // Kung AI ang titira (sa AI game), laging gamitin ang default
        cueIdToUse = isOnlineGame ? (opponentEquippedCueId || 'default') : 'default';  
    }

    // Hanapin ang data ng cue na gagamitin
    const cueToDisplay = SHOP_ITEMS.cues.find(i => i.id === cueIdToUse);
    // Hanapin din ang default cue para sa fallback/default sizes
    const defaultCueData = SHOP_ITEMS.cues.find(i => i.id === 'default');
    
    // Default sizes kung sakaling walang naka-define
    const fallbackWidth = defaultCueData?.displayWidth || 500;
    const fallbackHeight = defaultCueData?.displayHeight || 14;

    if (cueToDisplay && cueToDisplay.imageSrc) {
        // Set ang image source
        cueStickElement.src = cueToDisplay.imageSrc;
        // Set ang sukat (width/height)
        cueStickElement.style.width = `${cueToDisplay.displayWidth || fallbackWidth}px`;
        cueStickElement.style.height = `${cueToDisplay.displayHeight || fallbackHeight}px`;
    } else if (defaultCueData && defaultCueData.imageSrc) {
        // Fallback: Kung hindi mahanap yung cue ID, gamitin ang default
        cueStickElement.src = defaultCueData.imageSrc;
        cueStickElement.style.width = `${fallbackWidth}px`;
        cueStickElement.style.height = `${fallbackHeight}px`;
    } else {
        // Worst case: Kung pati default ay walang src, itago na lang
        cueStickElement.src = '';
        cueStickElement.style.width = '0px';
        cueStickElement.style.height = '0px';
    }
}

// â–¼â–¼â–¼ PALITAN MO ITONG BUONG FUNCTION â–¼â–¼â–¼

function updateCurrencyDisplay() {
    // Hanapin ang LAHAT ng elements na may class na 'coin-balance-display'
    const displays = document.querySelectorAll('.coin-balance-display');

    // I-format natin 'yung numero (gamit 'yung function na ginawa natin dati)
    const formattedCurrency = formatCurrencyShort(playerTotalCurrency);

    // I-update ang bawat isa sa kanila
    displays.forEach(display => {
        if (display) {
            display.textContent = formattedCurrency;
        }
    });
}

// (Siguraduhin mo na mayroon ka pa ring formatCurrencyShort function sa ibaba nito)
function formatCurrencyShort(num) {
Â  Â  if (num < 1000) {
Â  Â  Â  Â  return num.toString();
Â  Â  } else if (num < 1000000) {
Â  Â  Â  Â  // Mula 1,000 hanggang 999.9K
Â  Â  Â  Â  return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
Â  Â  } else if (num < 1000000000) {
Â  Â  Â  Â  // Mula 1M hanggang 999.9M
Â  Â  Â  Â  return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
Â  Â  } else {
Â  Â  Â  Â  // Mula 1B pataas
Â  Â  Â  Â  return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
Â  Â  }
}
function showRewardPopup(amount, reason = "") {
    // Ito 'yung maliit na popup na "+10 Coins!"
    const popup = document.createElement('div');
    let text = `+${amount} ${CURRENCY_NAME}!`;
    if (reason) {
        text = `${reason}<br>+${amount} ${CURRENCY_NAME}!`;
    }
    popup.innerHTML = text; // Gumamit ng .innerHTML para sa <br>
    
    popup.style.cssText = `
        position: absolute;
        left: 10px;
        top: 40px; /* Sa ilalim ng main currency display */
        color: #00FF00; /* Bright green */
        font-size: 1.2em;
        font-weight: bold;
        font-family: 'Luckiest Guy', cursive;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        z-index: 210;
        opacity: 1;
        transition: opacity 1.5s ease-out, transform 1.5s ease-out;
        transform: translateY(0);
        pointer-events: none;
        text-align: center;
        padding: 5px 10px;
        background: rgba(0,0,0,0.5);
        border-radius: 5px;
    `;
    document.getElementById('non-interactive-overlay').appendChild(popup);
    
    setTimeout(() => {
        popup.style.opacity = '0';
        popup.style.transform = 'translateY(-30px)';
    }, 100); // Simulan ang animation
    
    setTimeout(() => {
        popup.remove();
    }, 1600); // Alisin sa DOM
}

// â–¼â–¼â–¼ IDAGDAG MO ITONG BUONG BAGONG FUNCTION â–¼â–¼â–¼

/**
 * Nagpapakita ng animated popup para sa color assignment (gaya ng coin reward).
 * @param {string} message - Ang text na ipapakita (e.g., "You got RED!")
 * @param {string} color - Ang kulay ('red' o 'blue') para sa text.
 */
function showColorAssignmentPopup(message, color) {
    const popup = document.createElement('div');
    popup.innerHTML = message;
    
    // Itatakda natin ang kulay ng text base sa kulay ng bola
    let popupColor = '#FFFFFF'; // Default
    if (color.toLowerCase() === 'red') {
        popupColor = '#ff6b6b'; // Vibrant Red (gaya ng sa info box)
    } else if (color.toLowerCase() === 'blue') {
        popupColor = '#54a0ff'; // Vibrant Blue (gaya ng sa info box)
    }

    // Kinopya natin ang style ng coin popup pero in-adjust ang pwesto at kulay
    popup.style.cssText = `
        position: absolute;
        left: 50%; /* Igigitna natin */
        top: 70px;  /* Sa ilalim ng main message box */
        transform: translateX(-50%) translateY(0); /* Simula sa pwesto */
        color: ${popupColor}; /* Gagamitin ang kulay (red/blue) */
        font-size: 1.4em; /* Medyo mas malaki */
        font-weight: bold;
        font-family: 'Luckiest Guy', cursive;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        z-index: 210;
        opacity: 1;
        transition: opacity 1.5s ease-out, transform 1.5s ease-out; /* Parehong transition */
        pointer-events: none;
        text-align: center;
        padding: 5px 10px;
        background: rgba(0,0,0,0.5);
        border-radius: 5px;
        border: 1px solid ${popupColor}; /* Lagyan natin ng border na may kulay */
    `;
    // Ilalagay natin sa #non-interactive-overlay para laging nasa ibabaw
    document.getElementById('non-interactive-overlay').appendChild(popup);
    
    // Ito 'yung animation logic na ginaya sa coin popup (pa-fade pataas)
    setTimeout(() => {
        popup.style.opacity = '0';
        popup.style.transform = 'translateX(-50%) translateY(-30px)'; // Aakyat habang nawawala
    }, 2500); // Simulan ang animation
    
    setTimeout(() => {
        popup.remove();
    }, 4000); // Mananatili ng 2.5 segundo
}
// â–²â–²â–² HANGGANG DITO ANG BAGONG FUNCTION â–²â–²â–²
        function signInPlayer() { onAuthStateChanged(auth, (user) => { if (user) { localPlayerUid = user.uid; isAuthReady = true; onlineButton.disabled = false; onlineButton.textContent = "Online Multiplayer"; createPlayerDocument(); startInviteListener(); } else { signInAnonymously(auth).catch((error) => { console.error("Sign-in failed:", error); isAuthReady = false; onlineButton.textContent = "Auth Failed"; onlineButton.disabled = true; }); } }); }

// Dito ise-save ang "unsubscribe" function para sa invite listener
let unsubscribeFromInvites = null;

/**
 * Nagsisimulang makinig sa 'game_invites' collection para sa mga
 * imbitasyon na para sa kasalukuyang player (localPlayerUid).
 */
function startInviteListener() {
    // Tiyakin na may UID at database
    if (!localPlayerUid || !db) return;

    // Itigil ang lumang listener kung meron man
    if (unsubscribeFromInvites) {
        unsubscribeFromInvites();
    }

    // Gumawa ng query: Hanapin ang lahat ng 'game_invites' na:
    // 1. Para sa akin (toUid == localPlayerUid)
    // 2. "pending" pa ang status
    const invitesQuery = query(collection(db, "game_invites"),
        where("toUid", "==", localPlayerUid),
        where("status", "==", "pending")
    );

    // Ito ang real-time listener
    unsubscribeFromInvites = onSnapshot(invitesQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            // Interesado lang tayo sa mga BAGONG invite
            if (change.type === "added") {
                const inviteData = change.doc.data();
                const inviteId = change.doc.id;
                
                // Kunin ang game type (e.g., "poker") at gawing maganda (e.g., "Poker")
                const gameType = (inviteData.gameType || "pool").charAt(0).toUpperCase() + (inviteData.gameType || "pool").slice(1);
                
                // Ipakita ang pop-up!
                showInvitePopup(inviteData.fromName, gameType, inviteId);
            }
        });
    });
}

/**
 * Ipinapakita ang "Incoming Invite" modal.
 * @param {string} fromName - Pangalan ng nag-imbita.
 * @param {string} gameType - Uri ng laro (e.g., "Poker").
 * @param {string} inviteId - Ang Document ID ng imbitasyon.
 */
function showInvitePopup(fromName, gameType, inviteId) {
    // Huwag magpakita ng invite kung may laro na o may ibang modal na bukas
    if (gameState !== 'lobby') return; 

    const modal = document.getElementById('invite-popup-modal');
    const title = document.getElementById('invite-popup-title');
    const text = document.getElementById('invite-popup-text');
    const acceptBtn = document.getElementById('invite-accept-btn');
    const declineBtn = document.getElementById('invite-decline-btn');

    // I-update ang text
    title.textContent = `${gameType} Invite!`;
    text.innerHTML = `<strong style="color:var(--gold-accent)">${fromName}</strong> is inviting you to a game!`;

    // --- Ito ay CRITICAL ---
    // Kailangan nating gumawa ng BAGONG buttons para maiwasan ang "multiple click" bugs
    
    // 1. Palitan ang lumang accept button ng bago
    const newAcceptBtn = acceptBtn.cloneNode(true); // Kopyahin ang button
    acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn); // Palitan ang luma
    newAcceptBtn.textContent = "Accept";
    newAcceptBtn.disabled = false;
    
    // 2. Palitan ang lumang decline button ng bago
    const newDeclineBtn = declineBtn.cloneNode(true);
    declineBtn.parentNode.replaceChild(newDeclineBtn, declineBtn);
    newDeclineBtn.textContent = "Decline";
    newDeclineBtn.disabled = false;

    // 3. Idagdag ang click listener sa BAGONG Accept button
    newAcceptBtn.addEventListener('click', () => {
        playButtonSound();
        modal.classList.remove('show'); // Itago agad ang modal
        handleInviteAccept(inviteId); // Tawagin ang logic
    }, { once: true }); // Siguraduhin na isang beses lang mapipindot

    // 4. Idagdag ang click listener sa BAGONG Decline button
    newDeclineBtn.addEventListener('click', () => {
        playButtonSound();
        modal.classList.remove('show');
        handleInviteDecline(inviteId); // Tawagin ang logic
    }, { once: true });

    // 5. Ipakita ang modal
    modal.classList.add('show');
    // (Hindi na natin kailangan i-push state, kasi baka mawala)
}

/**
 * Tinitingnan kung may player document na, kung wala, gagawa ng bago.
 * Ito ang titiyak na lahat ng player ay may 'searchableName' agad.
 */
async function createPlayerDocument() {
    // Siguraduhin na may UID, database, AT pangalan na bago sumubok magsulat
    if (!localPlayerUid || !db || !localPlayerName || localPlayerName === "Guest") {
        // Kung wala pa ang isa sa mga 'to, huwag munang ituloy.
        // Tatawagin ulit 'to mamaya kapag kumpleto na.
        console.log("Waiting for UID and Name before creating player document...");
        return; 
    }

    const playerDocRef = doc(db, "players", localPlayerUid);

    try {
        const playerDoc = await getDoc(playerDocRef);

        if (!playerDoc.exists()) {
            // --- BAGO PA LANG ANG PLAYER ---
            // Gagawa tayo ng bagong document para sa kanila
            console.log("Creating new player document for:", localPlayerName);
            await setDoc(playerDocRef, {
                displayName: localPlayerName,
                searchableName: localPlayerName.toLowerCase(), // ETO NA YUN!
                wins: 0,
                level: 1, // Kunin natin sa global variable
                xp: 0,    // Kunin natin sa global variable
                equippedCueId: 'default',
                lastPlayed: serverTimestamp()
            });
        } else {
            // --- BUMALIK NA PLAYER ---
            // I-update lang natin ang pangalan at searchableName
            // para kung nag-iba man, updated pa rin.
            console.log("Player document exists. Updating name...");
            await updateDoc(playerDocRef, {
                displayName: localPlayerName,
                searchableName: localPlayerName.toLowerCase() // ETO NA YUN!
            });
        }
    } catch (error) {
        console.error("Error creating or updating player document:", error);
    }
}
        
    async function createOnlineGame() {
Â  Â  Â  Â  Â  Â  const displayName = localPlayerName || "Guest" + Math.floor(Math.random() * 1000); // Gamitin ang na-load na pangalan
Â  Â  Â  Â  Â  Â  if (!isAuthReady || !localPlayerUid) { showMessage("Authenticating... Please wait."); return; }

Â  Â  Â  Â  Â  Â  // Kunin ang equipped cue ID direkta sa local variable, HINDI na sa Firestore.
Â  Â  Â  Â  Â  Â  // Dinagdagan ng '|| default' para sigurado.
Â  Â  Â  Â  Â  Â  let myEquippedCueId = equippedItems.cue || 'default';

Â  Â  Â  Â  Â  Â  onlineMenu.classList.remove('show');
Â  Â  Â  Â  Â  Â  resizeCanvas();
Â  Â  Â  Â  Â  Â  gameMode = `online-${selectedOnlineGameType}`;
Â  Â  Â  Â  Â  Â  setupChips();
Â  Â  Â  Â  Â  Â  gameId = Math.random().toString(36).substring(2, 7).toUpperCase();
Â  Â  Â  Â  Â  Â  localPlayerId = 'player1';
Â  Â  Â  Â  Â  Â  lastProcessedTurnId = -1;
Â  Â  Â  Â  Â  Â  const initialChipsToSend = chips.map(c => ({...c, x: c.x/canvas.width, y: c.y/canvas.height }));
Â  Â  Â  Â  Â  Â  // Idagdag ang displayName at myEquippedCueId sa player1 object
Â  Â  Â  Â  Â  Â  const gameData = { 
                gameId, 
                gameType: selectedOnlineGameType, 
                gameState: 'waiting', 
                turnId: 0, 
                players: { 
                    player1: { 
                        uid: localPlayerUid, 
                        status: 'online', 
                        displayName: displayName, 
                        equippedCueId: myEquippedCueId, 
                        rankIndex: getPlayerRank(playerLevel).index // <-- â— IDAGDAG MO ITO
Â  Â  Â                }, 
                    player2: null 
                }, 
                chips: initialChipsToSend, 
                currentTurnUid: null, 
                lastShot: null, 
                liveAimData: null, 
                turnInProgress: false, 
                canMoveCueBall: true, 
                isBreakShot: true, 
                winner: null 
            };
Â  Â  Â  Â  Â  Â  if (selectedOnlineGameType === 'poker') {
Â  Â  Â  Â  Â  Â  Â  Â  createDeck();
Â  Â  Â  Â  Â  Â  Â  Â  dealCards();
Â  Â  Â  Â  Â  Â  Â  Â  Object.assign(gameData, { deck, player1Hand: playerHand, player2Hand: opponentHand, originalPlayer1Hand: originalPlayerHand, originalPlayer2Hand: originalOpponentHand });
Â  Â  Â  Â  Â  Â  } else if (selectedOnlineGameType === 'straight-ball') {
Â  Â  Â  Â  Â  Â  Â  Â  Object.assign(gameData, { colorsAssigned: false, player1ChipsType: null, player2ChipsType: null });
Â  Â  Â  Â  Â  Â  } else if (selectedOnlineGameType === '61-ball') {
Â  Â  Â  Â  Â  Â  Â  Â  Object.assign(gameData, { player1_61Score: 0, player2_61Score: 0, lowestChipNumber: 1 });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(doc(db, "games", gameId), gameData);
Â  Â  Â  Â  Â  Â  Â  Â  gameIdDisplay.textContent = gameId;
Â  Â  Â  Â  Â  Â  Â  Â  waitingRoom.classList.add('show');
Â  Â  Â  Â  Â  Â  Â  Â  history.pushState({ modal: 'waitingRoom' }, 'Waiting Room', '#wait');
Â  Â  Â  Â  Â  Â  Â  Â  listenToGameUpdates(gameId);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Failed to create game.", 3000);
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firebase setDoc error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  onlineMenu.classList.add('show');
Â  Â  Â  Â  Â  Â  Â  Â  history.back();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

async function joinOnlineGame() {
Â  Â  Â  Â  Â  Â  const displayName = localPlayerName || "Guest" + Math.floor(Math.random() * 1000); // Gamitin ang na-load na pangalan
Â  Â  Â  Â  Â  Â  if (!isAuthReady || !localPlayerUid) { showMessage("Authenticating... Please wait."); return; }
Â  Â  Â  Â  Â  Â  const inputId = gameIdInput.value.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  if (!inputId) { showMessage("Please enter a Game ID."); return; }
Â  Â  Â  Â  Â  Â  const gameDocRef = doc(db, "games", inputId);
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const docSnap = await getDoc(gameDocRef);
Â  Â  Â  Â  Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (docSnap.data().gameState !== 'waiting') { showMessage("Game is full."); return; }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onlineMenu.classList.remove('show');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Joining game...");

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Kunin ang equipped cue ID direkta sa local variable, HINDI na sa Firestore.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Dinagdagan ng '|| default' para sigurado.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let myEquippedCueId = equippedItems.cue || 'default';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // === START NG BONUS FIX ===
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ito yung "toss coin" para malaman kung sino ang unang titira
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const startingPlayerUid = Math.random() < 0.5 ? docSnap.data().players.player1.uid : localPlayerUid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // === END NG BONUS FIX ===

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Gagamitin na ang myEquippedCueId at startingPlayerUid dito
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameDocRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'players.player2': { // <-- Simula ng object para sa player 2
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: localPlayerUid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'online',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayName: displayName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  equippedCueId: myEquippedCueId, 
                            rankIndex: getPlayerRank(playerLevel).index // <-- â— IDAGDAG MO ITO
                        },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'gameState': 'playing',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'currentTurnUid': startingPlayerUid, // <-- Galing sa bonus fix
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'turnId': 1
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameId = inputId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localPlayerId = 'player2';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listenToGameUpdates(inputId);

Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Game not found.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Failed to join game.", 3000);
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Join game error:", error); // Idinagdag ko 'to para makita mo 'yung error kung meron
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        async function cancelOnlineGame() { if (gameId) { try { await deleteDoc(doc(db, "games", gameId)); gameId = null; } catch (e) { console.error("Error cancelling", e); } } resetToMenu(); }
        async function resetOnlineGameForRematch(gameData) { if (unsubscribeGameListener) unsubscribeGameListener(); gameMode = `online-${gameData.gameType}`; resizeCanvas(); setupChips(); const newChipsState = chips.map(c => ({...c, x: c.x / canvas.width, y: c.y / canvas.height })); const startingPlayerUid = Math.random() < 0.5 ? gameData.players.player1.uid : gameData.players.player2.uid; const resetData = { gameState: 'playing', chips: newChipsState, currentTurnUid: startingPlayerUid, canMoveCueBall: true, isBreakShot: true, winner: null, rematchRequest: null, turnId: (gameData.turnId || 0) + 10, lastShot: null }; if (gameData.gameType === 'poker') { createDeck(); dealCards(); Object.assign(resetData, { deck, player1Hand: localPlayerId === 'player1' ? playerHand : opponentHand, player2Hand: localPlayerId === 'player1' ? opponentHand : playerHand, originalPlayer1Hand: localPlayerId === 'player1' ? originalPlayerHand : originalOpponentHand, originalPlayer2Hand: localPlayerId === 'player1' ? originalOpponentHand : originalPlayerHand, }); } else if (gameData.gameType === '61-ball') { Object.assign(resetData, { player1_61Score: 0, player2_61Score: 0, lowestChipNumber: 1 }); } else if (gameData.gameType === 'straight-ball') { Object.assign(resetData, { colorsAssigned: false, player1ChipsType: null, player2ChipsType: null }); } try { await updateDoc(doc(db, "games", gameId), resetData); } catch (error) { console.error("Failed to reset game for rematch:", error); } finally { listenToGameUpdates(gameId); } }
        function sendLiveAimData() { if (!isOnlineGame || !isMyTurnOnline || !gameId || table.width === 0) return; const now = Date.now(); if (now - lastAimUpdateTime < AIM_UPDATE_INTERVAL) return; lastAimUpdateTime = now; const cueChip = chips.find(c => c.id === 0); if (!cueChip) return; const dataToSend = { angle: cueStick.angle, cueBallX: cueChip.x/canvas.width, cueBallY: cueChip.y/canvas.height, pektusX: pektusOffset.x, pektusY: pektusOffset.y, sender: localPlayerUid }; updateDoc(doc(db, "games", gameId), { liveAimData: dataToSend }).catch(() => {}); }
        function listenToGameUpdates(gameId) { let lastShotTimestamp = 0; setupChatListener(gameId);
            // â–¼â–¼â–¼ SIMULA NG DAGDAG NA "PRESENCE" CODE â–¼â–¼â–¼
            
            // Ito ang "Presence" system para sa mabilisang pag-detect ng disconnection
            // Gagamit tayo ng Realtime Database (rtdb) para dito
            if (rtdb && localPlayerUid) {
                
                // 1. Reference sa connection status mismo ng Firebase
                const connectionRef = ref(rtdb, '.info/connected');
                
                // 2. Reference kung saan natin isusulat ang status ng player sa RTDB
                const playerStatusRef = ref(rtdb, `gameStatus/${gameId}/${localPlayerUid}`);
                
                // 3. Reference sa game document sa FIRESTORE
                const firestoreGameDocRef = doc(db, "games", gameId);

                // 4. Makikinig tayo sa .info/connected
                onValue(connectionRef, (snap) => {
                    if (snap.val() === true) {
                        // Kung connected tayo...

                        // A. Isulat sa RTDB na "online" tayo
                        set(playerStatusRef, { 
                            online: true, 
                            lastSeen: Date.now() 
                        });
                        
                        // B. Ito na ang "Huling Habilin" (Last Will) para sa RTDB
                        //    Kapag bigla tayong nawala, i-set sa 'false' (offline) ang status
                        onDisconnect(playerStatusRef).set({ 
                            online: false, 
                            lastSeen: Date.now() 
                        });

                        // C. I-update din natin ang status sa FIRESTORE
                        //    para makita ng 'onSnapshot' listener ng kalaban
                        updateDoc(firestoreGameDocRef, {
                            [`players.${localPlayerId}.status`]: 'online'
                        }).catch(e => console.warn("Could not update online status in Firestore.", e));
                        
                        // D. Ito ang "Huling Habilin" (Last Will) para sa FIRESTORE
                        //    (Mas mabagal ito kaysa sa RTDB, pero nagsisilbing fallback)
                        onDisconnect(firestoreGameDocRef).update({
                            [`players.${localPlayerId}.status`]: 'disconnected'
                        }).catch(e => console.warn("Could not set Firestore onDisconnect.", e));
                    }
                }, { onlyOnce: true }); // Gawin lang ito isang beses per game listen
            }
            // â–²â–²â–² TAPOS NG DAGDAG NA "PRESENCE" CODE â–²â–²â–²
           
 unsubscribeGameListener = onSnapshot(doc(db, "games", gameId), (doc) => { if (!doc.exists()) { if (gameState !== 'menu' && gameState !== 'gameover') { showMessage("Game ended by host.", 3000); resetToMenu(); } return; } const gameData = doc.data(); if (!gameData) return; if (gameData.lastShot && gameData.lastShot.timestamp > lastShotTimestamp && !chipsMoving) { lastShotTimestamp = gameData.lastShot.timestamp; animateAndApplyShot(gameData.lastShot); } if (gameData.gameState === 'finished' && gameData.rematchRequest) { const players = Object.keys(gameData.players).filter(p => gameData.players[p] !== null); if (players.length === 2) { const playerUIDs = players.map(p => gameData.players[p].uid); const player1_uid = playerUIDs[0]; const player2_uid = playerUIDs[1]; const iWantRematch = gameData.rematchRequest[localPlayerUid]; const opponentUid = localPlayerUid === player1_uid ? player2_uid : player1_uid; const opponentWantsRematch = gameData.rematchRequest[opponentUid]; const rematchButton = document.getElementById('rematch-button'); if (iWantRematch && opponentWantsRematch) { if (localPlayerId === 'player1') { resetOnlineGameForRematch(gameData); } } else if (opponentWantsRematch && !iWantRematch) { rematchButton.textContent = 'Accept Rematch'; } } } syncGameState(gameData); }); }
        async function leaveOnlineGame(isForfeit) { if (!isOnlineGame || !gameId || !localPlayerId) return; const gameDocRef = doc(db, "games", gameId); try { const docSnap = await getDoc(gameDocRef); if (docSnap.exists() && docSnap.data().gameState !== 'finished') { const opponentId = localPlayerId === 'player1' ? 'player2' : 'player1'; const winnerUid = docSnap.data().players[opponentId]?.uid; if (isForfeit && winnerUid) { await updateDoc(gameDocRef, { gameState: 'finished', winner: winnerUid, [`players.${localPlayerId}.status`]: 'disconnected' }); } else { await updateDoc(gameDocRef, { [`players.${localPlayerId}.status`]: 'disconnected' }); } } } catch (error) { console.error("Error leaving/forfeiting game:", error); } }
        function isPathObstructed(startObj, endObj, ignoreChipIds = []) { const allObstacles = chips.filter(c => c.inPlay && !ignoreChipIds.includes(c.id)); for (const obstacle of allObstacles) { const dist = Math.abs((endObj.y - startObj.y) * obstacle.x - (endObj.x - startObj.x) * obstacle.y + endObj.x * startObj.y - endObj.y * startObj.x) / Math.hypot(endObj.y - startObj.y, endObj.x - startObj.x); const safetyMargin = 4 * scale; const effectiveRadius = obstacle.radius + (startObj.radius || 0) + safetyMargin; if (dist < effectiveRadius) { const dotProduct = (obstacle.x - startObj.x) * (endObj.x - startObj.x) + (obstacle.y - startObj.y) * (endObj.y - startObj.y); const squaredLength = Math.pow(Math.hypot(endObj.x - startObj.x, endObj.y - startObj.y), 2); if (dotProduct > 0 && dotProduct < squaredLength) { return true; } } } return false; }
        function isAnyDirectPathClear(cueChip, legalTargets) { if (!legalTargets || legalTargets.length === 0) return false; for (const target of legalTargets) { if (!isPathObstructed(cueChip, target, [])) return true; } return false; }
        function evaluateShot(cueChip, targetChip, hole, allLegalTargets, difficulty, isCombination = false) { let firstContactTarget = isCombination ? allLegalTargets[0] : targetChip; if (!firstContactTarget) return null; const aiTargetHole = { x: hole.x, y: hole.y }; let shotAngle; if (isCombination) { const impactAngle1 = Math.atan2(aiTargetHole.y - targetChip.y, aiTargetHole.x - targetChip.x); const pfm = { x: targetChip.x - Math.cos(impactAngle1) * (firstContactTarget.radius + targetChip.radius), y: targetChip.y - Math.sin(impactAngle1) * (firstContactTarget.radius + targetChip.radius) }; const impactAngle2 = Math.atan2(pfm.y - firstContactTarget.y, pfm.x - firstContactTarget.x); const gbfc = { x: firstContactTarget.x - Math.cos(impactAngle2) * (cueChip.radius + firstContactTarget.radius), y: firstContactTarget.y - Math.sin(impactAngle2) * (cueChip.radius + firstContactTarget.radius) }; shotAngle = Math.atan2(gbfc.y - cueChip.y, gbfc.x - cueChip.y); } else { const targetToHoleAngle = Math.atan2(aiTargetHole.y - targetChip.y, aiTargetHole.x - targetChip.x); const ghostBall = { x: targetChip.x - Math.cos(targetToHoleAngle) * (cueChip.radius + targetChip.radius), y: targetChip.y - Math.sin(targetToHoleAngle) * (cueChip.radius + targetChip.radius) }; shotAngle = Math.atan2(ghostBall.y - cueChip.y, ghostBall.x - cueChip.x); } const path1Clear = !isPathObstructed(cueChip, firstContactTarget, [targetChip.id]); const path2Clear = !isPathObstructed(targetChip, hole, [cueChip.id, firstContactTarget.id]); let path3Clear = !isCombination || !isPathObstructed(firstContactTarget, targetChip, [cueChip.id]); if (!path1Clear || !path2Clear || !path3Clear) return null; const distance = Math.hypot(firstContactTarget.x - cueChip.x, firstContactTarget.y - cueChip.y); const lineToTargetCenterAngle = Math.atan2(firstContactTarget.y - cueChip.y, firstContactTarget.x - cueChip.x); const cutAngle = shotAngle - lineToTargetCenterAngle; const anglePenalty = (Math.abs(cutAngle) / (Math.PI / 2)) * 0.7; const distancePenalty = (distance / canvas.width) * 0.5; let probability = 1.0 - distancePenalty - anglePenalty; if (isCombination) probability *= 0.6; let pocketingScore = 1000; if (gameMode.includes('61-ball')) { pocketingScore += targetChip.value * 20; } const power = Math.min(1.2, (distance / (canvas.width * 0.5)) + 0.3); const predictedCuePos = predictSimpleCuePos(cueChip, firstContactTarget, shotAngle, power); let positionalScore = calculatePositionalScore(predictedCuePos, targetChip.id, allLegalTargets);
        let positionalMultiplier = 1.0;
        if (difficulty === 'easy') positionalMultiplier = 0.2;
        else if (difficulty === 'hard') positionalMultiplier = 0.6;
        const totalScore = (pocketingScore + (positionalScore * positionalMultiplier)) * Math.max(0, probability);
        return { angle: shotAngle, power, score: totalScore, probability: Math.max(0, probability), target: targetChip, hole: hole, firstContactTarget: firstContactTarget, isCombination };
    }
        

// â–¼â–¼â–¼ PALITAN MO ITONG BUONG FUNCTION â–¼â–¼â–¼

function aiTurn() {
    if (gameState !== 'aiming' || chipsMoving || !chips[0]?.inPlay) return;
    const cueChip = chips[0];

    // 1. BREAK SHOT LOGIC (Mula sa "Terminator" AI)
    if (isBreakShot) {
        showMessage("AI is breaking...", 2000);
        
        let apexBall; // Ito 'yung bola sa pinaka-unahan ng rack
        
        if (gameMode.includes('61-ball')) {
            apexBall = chips.find(c => c.inPlay && c.id === 1);
        } else {
            let frontMostX = canvas.width; 
            chips.forEach(c => {
                if (c.inPlay && c.id !== 0) {
                    if (c.x < frontMostX) {
                        frontMostX = c.x;
                        apexBall = c; 
                    }
                }
            });
        }

        if (!apexBall) {
            const rackX = gameMode.includes('61-ball') ? canvas.width * 0.75 : canvas.width * 0.7;
            apexBall = { x: rackX, y: canvas.height / 2 };
        }

        const breakAngle = Math.atan2(apexBall.y - cueChip.y, apexBall.x - cueChip.x);
        const breakPower = 1.1 + (Math.random() * 0.1); // Normalized power (1.1 hanggang 1.2)
        
        const breakShot = {
            angle: breakAngle,
            power: breakPower,
            probability: 1.0,
            pektus: { x: 0, y: -0.2 } // Kaunting topspin para sa "break"
        };

        const breakPacing = { DURATION_ALIGN: 100, DURATION_FEATHER: 2500, DURATION_PAUSE: 100 };
        
        animateAiAiming(breakShot.angle, breakShot.power, breakPacing, breakShot.pektus);
        return; 
    }

    // 2. REGULAR SHOT LOGIC (Paghanap ng Tira)
    let allLegalTargets = [], allPocketableChips = [];

    if (gameMode.includes('poker')) {
        allLegalTargets = chips.filter(c => c.inPlay && opponentHand.some(card => card.value === c.id));
        allPocketableChips = allLegalTargets;
    } else if (gameMode.includes('61-ball')) {
        const lowestChip = chips.find(c => c.id === lowestChipNumber);
        if (!lowestChip) {
            setTimeout(handleTurnEnd, 500);
            return;
        }
        allLegalTargets = [lowestChip];
        allPocketableChips = chips.filter(c => c.inPlay && c.id !== 0);
    } else {
        if (colorsAssigned && opponentChipsType) allLegalTargets = chips.filter(c => c.inPlay && c.type === opponentChipsType);
        else allLegalTargets = chips.filter(c => c.inPlay && (c.type === 'red' || c.type === 'blue'));
        allPocketableChips = allLegalTargets;
    }

    let simplePots = [];
    let complexShots = [];

    // Titingnan lahat ng posibleng tira
    for (const target of allLegalTargets) {
        for (const hole of holes) {
            const evaluation = evaluateShot(cueChip, target, hole, allLegalTargets, difficulty, false);
            if (evaluation) simplePots.push(evaluation);
        }
    }
    if (gameMode.includes('61-ball')) {
        for (const target of allPocketableChips.filter(c => c.id !== allLegalTargets[0].id)) {
            for (const hole of holes) {
                const evaluation = evaluateShot(cueChip, target, hole, allLegalTargets, difficulty, true);
                if (evaluation) complexShots.push(evaluation);
            }
        }
    }

    const allPossibleShots = [...simplePots, ...complexShots];
    let bestShot;

    if (allPossibleShots.length > 0) {
        // --- "TERMINATOR" LOGIC ---
        // Laging pipiliin ang pinaka-the best shot (highest score)
        allPossibleShots.sort((a, b) => b.score - a.score);
        bestShot = allPossibleShots[0]; 

    } else {
        // --- NO SHOT FOUND LOGIC (Kick or Defensive) ---
        showMessage("AI is calculating a kick shot...", 2000);
        bestShot = findBestKickShot(cueChip, allLegalTargets);

        if (!bestShot) {
            bestShot = findBestDefensiveShot(cueChip, allLegalTargets);
        }
        if (!bestShot) {
            const finalTarget = allLegalTargets[0] || allPocketableChips[0];
            if (finalTarget) {
                bestShot = { angle: Math.atan2(finalTarget.y - cueChip.y, finalTarget.x - cueChip.x), power: 0.4, probability: 0.5, pektus: {x:0, y:0} };
            } else {
                setTimeout(handleTurnEnd, 500);
                return;
            }
        }
    }

    // --- BAGONG "PRO PLAYER" PACING (Ito 'yung binago natin) ---
    let pacing = {};
    const shotProbability = bestShot.probability || 1.0; 
    let isDefensiveShot = bestShot.isDefensive || false;
    let isKickShot = !bestShot.hole && !isDefensiveShot; 

    if (isKickShot || isDefensiveShot) {
        // Mas matagal mag-isip para sa complex shots
        pacing = { DURATION_ALIGN: 1000, DURATION_FEATHER: 2500, DURATION_PAUSE: 100 };
    } else if (shotProbability < 0.75) {
        // Medyo matagal para sa mahihirap na tira (para "parang tao")
        pacing = { DURATION_ALIGN: 1000, DURATION_FEATHER: 2500, DURATION_PAUSE: 100 };
    } else {
        // Mabilis at confident para sa madali o standard na tira
        pacing = { DURATION_ALIGN: 1000, DURATION_FEATHER: 2500, DURATION_PAUSE: 100 };
    }
    
    animateAiAiming(bestShot.angle, bestShot.power, pacing, bestShot.pektus || { x: 0, y: 0 });
    // --- END NG BAGONG PACING ---
}
// â–²â–²â–² HANGGANG DITO ANG PALIT â–²â–²â–²
        
        function findBestKickShot(cueChip, legalTargets) { let bestKickShot = { score: -Infinity }; const cushions = [ { type: 'y', val: 0 }, { type: 'y', val: canvas.height }, { type: 'x', val: 0 }, { type: 'x', val: canvas.width } ]; for (const target of legalTargets) { for (const cushion of cushions) { let virtualCue = (cushion.type === 'y') ? { x: cueChip.x, y: cushion.val * 2 - cueChip.y } : { x: cushion.val * 2 - cueChip.x, y: cueChip.y }; const angleToVirtual = Math.atan2(target.y - virtualCue.y, target.x - virtualCue.x); const impactPoint = (cushion.type === 'y') ? { y: cushion.val, x: cueChip.x + (cushion.val - cueChip.y) / Math.tan(angleToVirtual) } : { x: cushion.val, y: cueChip.y + (cushion.val - cueChip.x) * Math.tan(angleToVirtual) }; const pathToCushionClear = !isPathObstructed(cueChip, impactPoint, [target.id]); const pathFromCushionClear = !isPathObstructed(impactPoint, target, [cueChip.id]); if (pathToCushionClear && pathFromCushionClear) { const finalShotAngle = Math.atan2(impactPoint.y - cueChip.y, impactPoint.x - cueChip.x); const distance = Math.hypot(impactPoint.x - cueChip.x, impactPoint.y - cueChip.y) + Math.hypot(target.x - impactPoint.x, target.y - impactPoint.y); const power = Math.min(1.0, (distance / canvas.width) * 1.5) + 0.3; const score = 500 - distance; if (score > bestKickShot.score) { bestKickShot = { score, angle: finalShotAngle, power, probability: 0.7 }; } } } } return bestKickShot.score > -Infinity ? bestKickShot : null; }
        function predictSimpleCuePos(cueChip,targetChip,shotAngle,power){const distance=Math.hypot(targetChip.x-cueChip.x,targetChip.y-cueChip.y);const followDistance=(power*power)*(distance*0.4);return{id:0,x:targetChip.x+Math.cos(shotAngle)*followDistance,y:targetChip.y+Math.sin(shotAngle)*followDistance,radius:cueChip.radius};}
        // â–¼â–¼â–¼ PALITAN MO ITONG BUONG FUNCTION â–¼â–¼â–¼

    // â–¼â–¼â–¼ IPALIT MO ITONG BUONG FUNCTION (Version 3: May Topspin at Sidespin) â–¼â–¼â–¼

        function calculatePositionalScore(predictedCuePos, pocketedChip, allLegalTargets) {
            
            // --- 1. Hanapin ang susunod na target ---
            let nextTargets = [];
            if (gameMode.includes('poker')) {
                nextTargets = allLegalTargets.filter(t => t.id !== pocketedChip.id); // Pinalitan ang 'justPocketedId'
            } else if (gameMode.includes('61-ball')) {
                const remaining = chips.filter(c => c.inPlay && c.id !== 0 && c.id !== pocketedChip.id); // Pinalitan ang 'justPocketedId'
                if (remaining.length > 0) nextTargets = [remaining.sort((a, b) => a.id - b.id)[0]];
            } else nextTargets = allLegalTargets.filter(t => t.id !== pocketedChip.id); // Pinalitan ang 'justPocketedId'

            // Default pektus: "Stun" shot (gitna)
            let bestPektus = { x: 0, y: 0 };
            
            if (nextTargets.length === 0) {
                // Kung wala nang susunod na target, 'wag na mag-spin.
                return { score: 800, pektus: bestPektus }; 
            }

            const nextBestTarget = nextTargets.sort((a, b) => Math.hypot(a.x - predictedCuePos.x, a.y - predictedCuePos.y) - Math.hypot(b.x - predictedCuePos.x, b.y - predictedCuePos.y))[0];
            
            // --- 2. Logic para sa TOPSPIN (Follow) ---
            const distanceToNext = Math.hypot(nextBestTarget.x - predictedCuePos.x, nextBestTarget.y - predictedCuePos.y);
            if (distanceToNext > canvas.width / 3.5) {
                // Kung MALAYO ang next target, gumamit ng TOPSPIN
                bestPektus.y = -0.5; // -Y ay topspin (pataas ang dot)
            }
            // (Tandaan: Bawal ang backspin, kaya walang 'else if' dito)


            // --- 3. Logic para sa SIDESPIN (Left/Right) ---

            // Ito ay isang "helper" function na magko-compute ng score ng anggulo
            const getAngleScore = (cuePos, target) => {
                let bestScore = -200; // Simula sa negatibong score
                for (const hole of holes) {
                    if (!isPathObstructed(target, hole, [cuePos.id])) {
                        const angleToHole = Math.atan2(hole.y - target.y, hole.x - target.x);
                        const shotLine = Math.atan2(target.y - cuePos.y, target.x - cuePos.x);
                        const cutAngle = Math.abs(angleToHole - shotLine); // 0 = diretso, 1.57 = 90 degrees
                        // Mas mataas ang bonus kung mas diretso ang anggulo
                        const angleBonus = 200 * (1 - cutAngle / (Math.PI / 2)); 
                        if (angleBonus > bestScore) bestScore = angleBonus;
                    }
                }
                return bestScore;
            };

            // A. Kunin ang score ng STUN shot (natural na pwesto)
            let stunScore = getAngleScore(predictedCuePos, nextBestTarget);
            let finalScore = stunScore; // Ito ang default score

            // B. Kalkulahin ang "tangent" vector (ang direksyon na i-a-adjust ng side spin)
            const tangentX = -(predictedCuePos.y - pocketedChip.y);
            const tangentY = (predictedCuePos.x - pocketedChip.x);
            const mag = Math.hypot(tangentX, tangentY);

            if (mag > 0.1) { // Siguraduhin na hindi zero (para maiwasan ang divide by zero)
                const normTangentX = tangentX / mag;
                const normTangentY = tangentY / mag;
                // Gaano kalayo ang "estimate" natin na epekto ng spin
                const SPIN_ADJUST_DISTANCE = 30 * scale; 

                // C. Estimate ang position para sa LEFT SPIN
                const leftSpinPos = { 
                    id: 0, 
                    x: predictedCuePos.x - normTangentX * SPIN_ADJUST_DISTANCE, 
                    y: predictedCuePos.y - normTangentY * SPIN_ADJUST_DISTANCE 
                };
                let leftSpinScore = getAngleScore(leftSpinPos, nextBestTarget) - 20; // May -20 penalty kasi mas mahirap

                // D. Estimate ang position para sa RIGHT SPIN
                const rightSpinPos = { 
                    id: 0, 
                    x: predictedCuePos.x + normTangentX * SPIN_ADJUST_DISTANCE, 
                    y: predictedCuePos.y + normTangentY * SPIN_ADJUST_DISTANCE 
                };
                let rightSpinScore = getAngleScore(rightSpinPos, nextBestTarget) - 20; // May -20 penalty

                // E. Pag-desisyunan kung aling spin ang pinakamaganda
                if (leftSpinScore > stunScore && leftSpinScore > rightSpinScore) {
                    bestPektus.x = -0.6; // Gagamit ng Left Spin
                    finalScore = leftSpinScore; // Ito na ang bagong score
                } else if (rightSpinScore > stunScore && rightSpinScore > leftSpinScore) {
                    bestPektus.x = 0.6; // Gagamit ng Right Spin
                    finalScore = rightSpinScore; // Ito na ang bagong score
                }
                // Kung stunScore ang pinakamataas, mananatili ang bestPektus.x = 0
            }

            // 4. Ibalik ang pinakamagandang score AT ang pektus na gagamitin
            return { score: finalScore, pektus: bestPektus };
        }
        
        // â–²â–²â–² HANGGANG DITO ANG PALIT â–²â–²â–²
        function findBestDefensiveShot(cueChip,legalTargets){if(!legalTargets||legalTargets.length===0)return null;let bestSafety={score:-Infinity,angle:0,power:0};const primaryTarget=legalTargets[0];const opponentNextTarget=primaryTarget;for(let i=0;i < 32;i++){const angleOffset=(Math.random()-0.5)*(Math.PI/4);const shotAngle=Math.atan2(primaryTarget.y-cueChip.y,primaryTarget.x-cueChip.x)+angleOffset;const power=0.25+Math.random()*0.2;const predictedCuePos=predictSimpleCuePos(cueChip,primaryTarget,shotAngle,power);if(holes.some(h=>Math.hypot(h.x-predictedCuePos.x,h.y-predictedCuePos.y)<h.radius*1.2))continue;let safetyScore=0;safetyScore+=Math.hypot(predictedCuePos.x-opponentNextTarget.x,predictedCuePos.y-opponentNextTarget.y);const distToCushion=Math.min(predictedCuePos.x,canvas.width-predictedCuePos.x,predictedCuePos.y,canvas.height-predictedCuePos.y);if(distToCushion<cueChip.radius*3)safetyScore+=300;let blockingBallsCount=0;for(const chip of chips){if(chip.inPlay&&chip.id!==cueChip.id&&chip.id!==opponentNextTarget.id){const distToLine=Math.abs((opponentNextTarget.y-predictedCuePos.y)*chip.x-(opponentNextTarget.x-predictedCuePos.x)*chip.y+opponentNextTarget.x*predictedCuePos.y-opponentNextTarget.y*predictedCuePos.x)/Math.hypot(opponentNextTarget.y-predictedCuePos.y,opponentNextTarget.x-predictedCuePos.x);if(distToLine<chip.radius*2)blockingBallsCount++;}}safetyScore+=blockingBallsCount*400;if(safetyScore>bestSafety.score)bestSafety={score:safetyScore,angle:shotAngle,power:power,probability:0.9};}return bestSafety.score>-Infinity?bestSafety:null;}
        function placeCueChipForAI() { cueBallGuide.style.display = 'none'; dragGuideText.style.display = 'none'; const cueChip = chips[0]; gameState = 'ai_placing'; if (isBreakShot) { const breakLineX = canvas.width * 0.25; const offsetFromCenter = canvas.height * 0.1; const headsOrTails = Math.random(); cueChip.x = breakLineX; cueChip.y = (headsOrTails < 0.5) ? (canvas.height / 2) + offsetFromCenter : (canvas.height / 2) - offsetFromCenter; } else { const breakLineX = canvas.width * 0.25; let bestPlacement = { score: -Infinity, x: 0, y: 0 }; for (let i = 0; i < 40; i++) { const safeMargin = cueChip.radius + (5 * scale); const placementWidth = canvas.width - (safeMargin * 2); const proposedX = (Math.random() * placementWidth) + safeMargin; const proposedY = (Math.random() * (canvas.height - safeMargin * 2)) + safeMargin; if (isPositionOccupied(proposedX, proposedY, cueChip)) continue; const tempCueChip = { ...cueChip, x: proposedX, y: proposedY }; let legalTargets = chips.filter(c => c.inPlay && c.id !== 0); let bestScoreFromPos = -Infinity; for (const target of legalTargets) { for (const hole of holes) { const evalShot = evaluateShot(tempCueChip, target, hole, legalTargets, 'hard'); if (evalShot && evalShot.score > bestScoreFromPos) bestScoreFromPos = evalShot.score; } } if (bestScoreFromPos > bestPlacement.score) { bestPlacement = { score: bestScoreFromPos, x: proposedX, y: proposedY }; } } if (bestPlacement.score > -Infinity) { cueChip.x = bestPlacement.x; cueChip.y = bestPlacement.y; } else { cueChip.x = canvas.width * 0.25; cueChip.y = canvas.height / 2; } } setTimeout(() => { canMoveCueBall = false; gameState = 'aiming'; cueStick.visible = true; if (cueStickElement) cueStickElement.style.display = 'block'; setTimeout(aiTurn, 500); }, 700); }
        
// â–¼â–¼â–¼ PALITAN MO ITONG BUONG FUNCTION â–¼â–¼â–¼

// Binago para tumanggap ng 'pektus' object
function animateAiAiming(targetAngle, finalPower, pacingOptions = {}, pektus = { x: 0, y: 0 }) {
    const startTime = performance.now();
    const startAngle = cueStick.angle;

    // Default values
    const defaults = {
        DURATION_ALIGN: 800,
        DURATION_FEATHER: 2500,
        DURATION_PAUSE: 0
    };

    // I-merge ang defaults sa pinasang pacingOptions
    const basePacing = { ...defaults, ...pacingOptions };

    // --- BAGONG DAGDAG (New Addition): Randomization ---
    // Gawing random ang timing para magmukhang tao
    const DURATION_ALIGN = basePacing.DURATION_ALIGN * (0.8 + Math.random() * 0.4); // 80% to 120%
    const DURATION_FEATHER = basePacing.DURATION_FEATHER * (0.8 + Math.random() * 0.4); // 80% to 120%
    const DURATION_PAUSE = basePacing.DURATION_PAUSE; // Ang pause ay mananatiling fixed
    // --- END NG DAGDAG ---
    
    const FEATHER_COUNT = 1.5;
    const FEATHER_DISTANCE = 60 * scale;
    const TOTAL_DURATION = DURATION_ALIGN + DURATION_FEATHER + DURATION_PAUSE;

    function animate(currentTime) {
        const elapsedTime = currentTime - startTime;
        if (elapsedTime < DURATION_ALIGN) {
            // Stage 1: Pag-align ng tako
            const alignProgress = elapsedTime / DURATION_ALIGN;
            const easeOut = 1 - Math.pow(1 - alignProgress, 4);
            cueStick.angle = startAngle + (targetAngle - startAngle) * easeOut;
            cueStick.pullback = 0;
            
            // Habang nag-a-align, i-set na rin ang pektus
            // Gagawa tayo ng "easing" para 'yung dot ay dahan-dahang pumupunta sa pwesto
            pektusOffset.x = pektus.x * easeOut;
            pektusOffset.y = pektus.y * easeOut;
            updatePektusUI(); // I-update ang itsura ng pektus dot

        } else if (elapsedTime < DURATION_ALIGN + DURATION_FEATHER) {
            // Stage 2: Pag-"Feather" (yung umatras-abante)
            cueStick.angle = targetAngle;
            
            // Siguraduhin na 100% nang nasa tamang pwesto ang pektus
            pektusOffset = { ...pektus };
            updatePektusUI();
            
            const featherTime = elapsedTime - DURATION_ALIGN;
            const featherProgress = featherTime / DURATION_FEATHER;
            cueStick.pullback = Math.abs(Math.sin(featherProgress * Math.PI * (FEATHER_COUNT * 2))) * FEATHER_DISTANCE;

        } else if (elapsedTime < TOTAL_DURATION) {
            // Stage 3: Sandaling pag-pause bago tumira
            cueStick.angle = targetAngle;
            pektusOffset = { ...pektus }; // Siguraduhin ulit
            updatePektusUI();
            cueStick.pullback = 0;

        } else {
            // Stage 4: Tumira!
            cueStick.angle = targetAngle;
            
            // Ito na 'yung final pektus na ipapasa sa 'shoot' function
            pektusOffset = { ...pektus };
            updatePektusUI(); 
            
            shoot(finalPower * 40 + 2);
            return;
        }
        requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
}
// â–²â–²â–² HANGGANG DITO ANG PALIT â–²â–²â–²
        
        
        // â–¼â–¼â–¼ BURAHIN MO YUNG LUMA MONG "placeChipOnSpot" AT IPALIT MO ITO â–¼â–¼â–¼

function placeChipOnSpot(chipToPlace) {
    // Siguraduhin na ang pwesto ay LAGING 0.7 (70%)
    const spotX = canvas.width * 0.7; 
    const spotY = canvas.height / 2;
    
    let finalX = spotX, finalY = spotY, attempts = 0;
    
    // Habang may nakaharang na ibang bola sa spot...
    while (attempts < 100) {
        // Check kung 'yung pwesto (finalX, finalY) ay bakante
        if (!chips.some(c => c.inPlay && c.id !== chipToPlace.id && (finalX - c.x)**2 + (finalY - c.y)**2 < (c.radius + chipToPlace.radius)**2)) {
            break; // Bakante! Dito na ilalagay.
        }
        
        // Kung hindi bakante, mag-spiral out para humanap ng pwesto
        const angle = attempts * 0.5;
        const radius = chipToPlace.radius * 1.2 * Math.sqrt(attempts + 1);
        finalX = spotX + Math.cos(angle) * radius;
        finalY = spotY + Math.sin(angle) * radius;
        attempts++;
    }
    
    // Ilagay ang picha sa nahanap na pwesto
    chipToPlace.x = finalX;
    chipToPlace.y = finalY;
}
// â–²â–²â–² HANGGANG DITO â–²â–²â–²
        function createDeck() { deck = []; const suits = ['â™¥', 'â™¦', 'â™£', 'â™ '], ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K']; for (const suit of suits) for (const rank of ranks) { let value = parseInt(rank); if(rank==='A') value=1; else if(rank==='J') value=11; else if(rank==='Q') value=12; else if(rank==='K') value=13; deck.push({ suit, rank, value }); }}
        function dealCards() { playerHand = []; opponentHand = []; for (let i = deck.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [deck[i], deck[j]]=[deck[j], deck[i]]; } for (let i = 0; i < 7; i++) { if(deck.length > 0) playerHand.push(deck.pop()); if(deck.length > 0) opponentHand.push(deck.pop()); } originalPlayerHand = [...playerHand]; originalOpponentHand = [...opponentHand]; }
        function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => showMessage(`Could not activate full-screen mode.`, 2000)); else if (document.exitFullscreen) document.exitFullscreen(); }
        
        function handlePointerDown(e) { 
            e.preventDefault(); 

            if (isTutorialActive) {
                const currentStep = tutorialSteps[tutorialStep];
                if (currentStep && currentStep.trigger === 'drag') {
                    // This is handled in pointerMove to detect the start of the drag
                }
            }

            const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn; 
            if (!isMyTurn || (isOnlineGame && isSyncing)) return; 
            const targetId = e.currentTarget.id; 
            if (gameState === 'moving' && canMoveCueBall && targetId === 'game-canvas') { 
                isDraggingCueBall = true; 
                cueStick.visible = false; 
                ghostHand.style.display = 'block'; 
                dragGuideText.style.display = 'none'; 
                updateCueBallPosition(e); 
            } else if (gameState === 'aiming') { 
                if (targetId === 'game-canvas') { 
                    isAimingOnCanvas = true; 
                    updateAimFromCanvas(e); 
                    playAimingSound(); // Play sound on initial aim drag
                } else if (targetId === 'power-control') {
                    isPoweringUp = true;
                    playPowerSound(0); // Start power sound at low level
                } else if (targetId === 'pektus-control') { 
                    isDraggingPektusDot = true; 
                    handlePektusInput(e); 
                    playAimingSound(); // Play sound when adjusting pektus
                } else if (targetId === 'left-arrow') {
                    isRotatingLeft = true; 
                } else if (targetId === 'right-arrow') {
                    isRotatingRight = true; 
                }
            } 
        }

        function handlePointerMove(e) { 
            if (isTutorialActive) {
                const currentStep = tutorialSteps[tutorialStep];
                if (currentStep) {
                    if (isDraggingCueBall && currentStep.key === 'place') {
                        // Position is updated by the main logic below
                    } else if (isAimingOnCanvas && currentStep.key === 'aim') {
                        nextTutorialStep();
                    } else if (isDraggingPektusDot && currentStep.key === 'pektus') {
                        nextTutorialStep();
                    } else if (isPoweringUp && currentStep.key === 'power' && cueStick.power > 0.5) {
                        nextTutorialStep();
                    }
                }
            }

            if (isDraggingCueBall) { 
                e.preventDefault(); 
                const clientX = e.touches ? e.touches[0].clientX : e.clientX; 
                const clientY = e.touches ? e.touches[0].clientY : e.clientY; 
                ghostHand.style.left = `${clientX}px`; 
                ghostHand.style.top = `${clientY}px`; 
                updateCueBallPosition(e); 
            } else if (isPoweringUp) { 
                e.preventDefault(); 
                updatePower(e); 
            } else if (isAimingOnCanvas) { 
                e.preventDefault(); 
                updateAimFromCanvas(e); 
                playAimingSound(); // Play sound while dragging aim
            } else if (isDraggingPektusDot) { 
                e.preventDefault(); 
                handlePektusInput(e); 
                playAimingSound(); // Play sound while dragging pektus
            } 
        }

        function handlePointerUp(e) {
            if (isTutorialActive) {
                const currentStep = tutorialSteps[tutorialStep];
                if (currentStep) {
                     if (isDraggingCueBall && currentStep.key === 'place') {
                        if (!isInvalidPlacement) nextTutorialStep();
                    }
                }
            }

            if (isPoweringUp) {
                isPoweringUp = false;
                stopPowerSound(); // Stop the power sound
                if (cueStick.power > 0.05) {
                    shoot(cueStick.power * 40 + 2);
                } else {
                    cueStick.power = 0;
                    powerBar.style.height = '0%';
                    cueStick.pullback = 0;
                }
            }
            isAimingOnCanvas = false;
            if (isDraggingCueBall) {
                isDraggingCueBall = false;
                ghostHand.style.display = 'none';
                dragGuideText.style.display = 'none';
                if (!isInvalidPlacement) {
                    canMoveCueBall = false;
                    gameState = 'aiming';
                    resetPektus();
                    cueStick.visible = true;
                    if (cueStickElement) cueStickElement.style.display = 'block';
                    if (isOnlineGame && !isTutorialActive) {
                        const chipsToSend = chips.map(c => ({...c, x: c.x / canvas.width, y: c.y / canvas.height }));
                        updateDoc(doc(db, "games", gameId), { canMoveCueBall: false, chips: chipsToSend, liveAimData: null, currentTurnUid: localPlayerUid });
                    }
                } else {
                    cueStick.visible = true; 
                }
            }
            isDraggingPektusDot = false;
            isRotatingLeft = false;
            isRotatingRight = false;
            if (e.currentTarget.id === 'left-arrow' || e.currentTarget.id === 'right-arrow') {
                e.currentTarget.style.transform = '';
            }
        }
        // â–¼â–¼â–¼ PALITAN MO ITONG BUONG FUNCTION â–¼â–¼â–¼
// â–¼â–¼â–¼ IPALIT MO ITO SA LUMA MONG "getEventPos" â–¼â–¼â–¼

/**
 * Kinukuha ang mouse position para sa mga UI elements (Power, Pektus)
 * Ito ay kumukuha ng pixel coordinates (px)
 */
function getUIPos(e, relativeTo) {
    const rect = relativeTo.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
}

/**
 * Kinukuha ang mouse position para sa CANVAS
 * Ito ay nagco-convert ng pixel click papuntang Virtual World (1000x500)
 */
function getCanvasPos(e, relativeTo) { 
    const rect = relativeTo.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    const xRatio = (clientX - rect.left) / rect.width;
    const yRatio = (clientY - rect.top) / rect.height;

    return {
        x: xRatio * VIRTUAL_WIDTH,
        y: yRatio * VIRTUAL_HEIGHT
    };
}

// â–²â–²â–² HANGGANG DITO â–²â–²â–²

        // â–¼â–¼â–¼ IPALIT MO ITONG BUONG APAT (4) NA FUNCTIONS â–¼â–¼â–¼

function updatePower(e) {
    const pos = getUIPos(e, powerControl); // <-- Pinalitan na natin
    let p = pos.y / powerControl.clientHeight;
    cueStick.power = Math.max(0, Math.min(1, p));
    powerBar.style.height = `${cueStick.power * 100}%`;
    cueStick.pullback = cueStick.power * (150 * scale); // scale=1 na 'to, OK lang
    playPowerSound(cueStick.power);
}

function updateAimFromCanvas(e) {
    const cueChip = chips[0];
    if (!cueChip || !cueChip.inPlay) return;
    const pos = getCanvasPos(e, canvas); // <-- Pinalitan na natin
    cueStick.angle = Math.atan2(pos.y - cueChip.y, pos.x - cueChip.x);
    if (!isTutorialActive) sendLiveAimData();
}

function updateCueBallPosition(e) {
    const pos = getCanvasPos(e, canvas); // <-- Pinalitan na natin
    const cueChip = chips[0];
    const breakLineX = VIRTUAL_WIDTH * 0.25; // <-- Gumamit ng VIRTUAL_WIDTH
    let proposedX, proposedY;
    
    if (isBreakShot) {
        proposedX = Math.max(cueChip.radius, Math.min(breakLineX - cueChip.radius, pos.x));
        proposedY = Math.max(cueChip.radius, Math.min(VIRTUAL_HEIGHT - cueChip.radius, pos.y));
    } else {
        proposedX = Math.max(cueChip.radius, Math.min(VIRTUAL_WIDTH - cueChip.radius, pos.x));
        proposedY = Math.max(cueChip.radius, Math.min(VIRTUAL_HEIGHT - cueChip.radius, pos.y));
    }
    
    if (!isPositionOccupied(proposedX, proposedY, cueChip)) {
        cueChip.x = proposedX;
        cueChip.y = proposedY;
        isInvalidPlacement = false;
        if (!isTutorialActive) sendLiveAimData();
    } else isInvalidPlacement = true;
}

function handlePektusInput(e) {
    const rect = pektusControl.getBoundingClientRect();
    const pos = getUIPos(e, pektusControl); // <-- Pinalitan na natin
    const centerX = rect.width / 2, centerY = rect.height / 2;
    let dx = pos.x - centerX, dy = pos.y - centerY; // <-- Ginamit ang pos.x/pos.y
    
    // â–¼â–¼â–¼ IDAGDAG MO ITONG ISANG LINYA â–¼â–¼â–¼
    if (dy > 0) dy = 0; // Ito ang pipigil sa "backspin" (draw shot)
    // â–²â–²â–² HANGGANG DITO â–²â–²â–²

    const dist = Math.sqrt(dx * dx + dy * dy), maxDist = rect.width / 2;
    
    if (dist > maxDist) {
        dx = (dx / dist) * maxDist;
        dy = (dy / dist) * maxDist;
    }
    
    pektusOffset.x = dx / maxDist;
    pektusOffset.y = dy / maxDist;
    updatePektusUI();
    if (!isTutorialActive) sendLiveAimData();
}

// â–²â–²â–² HANGGANG DITO ANG PAGPALIT â–²â–²â–²
        function isPositionOccupied(x, y, draggedChip) { for (const chip of chips) { if (chip.id === draggedChip.id || !chip.inPlay) continue; if ((x-chip.x)**2 + (y-chip.y)**2 < (draggedChip.radius + chip.radius)**2) return true; } return false; }
        function updateCardDisplay() { if (gameMode.includes('poker')) { cardHandContainer.style.display = 'flex'; cardHandContainer.innerHTML = ''; let currentHand = playerHand; if (!currentHand) return; currentHand.forEach(card => { const cardDiv = document.createElement('div'); cardDiv.className = 'card'; const rankSpan = document.createElement('span'); rankSpan.className = 'card-rank'; rankSpan.textContent = card.rank; const suitSpan = document.createElement('span'); suitSpan.className = 'card-suit'; suitSpan.textContent = card.suit; if (card.suit === 'â™¥' || card.suit === 'â™¦') { rankSpan.style.color = '#D32F2F'; suitSpan.style.color = '#D32F2F'; } else { rankSpan.style.color = '#212121'; suitSpan.style.color = '#212121'; } cardDiv.appendChild(rankSpan); cardDiv.appendChild(suitSpan); cardHandContainer.appendChild(cardDiv); }); } else { cardHandContainer.style.display = 'none'; } updateInfoBox(); }
        
     // === START PLAYER NAME UPDATE & RING LIGHT (Step 3B - May Ranks na!) ===
function updateInfoBox() {Â 
Â  Â  // --- â— BAGONG CODE SIMULA DITO â— ---
Â  Â  // 1. Kunin ang rank data para sa IYO
Â  Â  const myRank = getPlayerRank(playerLevel);
Â  Â  // 2. Kunin ang rank data para sa KALABAN (gamit ang bagong variable)
Â  Â  const opponentRank = RANKS[opponentRankIndex] || RANKS[0]; // Fallback sa Beginner
Â  Â Â 
Â  Â  // 3. Gumawa ng HTML string para sa rank mo
Â  Â  const myRankDisplay = `<span style="color: ${myRank.color};">[${myRank.name}]</span>`;
Â  Â  // 4. Gumawa ng HTML string para sa rank ng kalaban
Â  Â  const opponentRankDisplay = `<span style="color: ${opponentRank.color};">[${opponentRank.name}]</span>`;
Â  Â  // --- â— BAGONG CODE HANGGANG DITO â— ---

Â  Â  const player1Name = localPlayerName || 'You';Â 
Â  Â  const player2Name = opponentPlayerName || 'Opponent';Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  if (gameMode.includes('poker')) {Â 
Â  Â  Â  Â  // Idagdag ang rank display bago ang pangalan
Â  Â  Â  Â  playerInfo.innerHTML = `${myRankDisplay} ${player1Name}: <span style="color: #33FF57;">${playerHand?.length || 0} cards</span>`;Â 
Â  Â  Â  Â  opponentInfo.innerHTML = `${opponentRankDisplay} ${player2Name}: <span style="color: #33FF57;">${opponentHand?.length || 0} cards</span>`;Â 
Â  Â  } else if (gameMode.includes('straight-ball')) {Â 
Â  Â  Â  Â  const vibrantRed = '#ff6b6b', vibrantBlue = '#54a0ff';Â 
Â  Â  Â  Â  const myColorName = playerChipsType ? playerChipsType.toUpperCase() : '?';Â 
Â  Â  Â  Â  const theirColorName = opponentChipsType ? opponentChipsType.toUpperCase() : '?';Â 
Â  Â  Â  Â  const myDisplayColor = playerChipsType === 'red' ? vibrantRed : (playerChipsType === 'blue' ? vibrantBlue : '#33FF57');Â 
Â  Â  Â  Â  const theirDisplayColor = opponentChipsType === 'red' ? vibrantRed : (opponentChipsType === 'blue' ? vibrantBlue : '#33FF57');Â 
Â  Â  Â  Â  // Idagdag ang rank display bago ang pangalan
Â  Â  Â  Â  playerInfo.innerHTML = `${myRankDisplay} ${player1Name}: <span style="color: ${myDisplayColor};">${myColorName}</span>`;Â 
Â  Â  Â  Â  opponentInfo.innerHTML = `${opponentRankDisplay} ${player2Name}: <span style="color: ${theirDisplayColor};">${theirColorName}</span>`;Â 
Â  Â  } else if (gameMode.includes('61-ball')) {Â 
Â  Â  Â  Â  // Idagdag ang rank display bago ang pangalan
Â  Â  Â  Â  playerInfo.innerHTML = `${myRankDisplay} ${player1Name}: <span style="color: #33FF57; font-weight: bold;">${player61Score} pts</span>`;Â 
Â  Â  Â  Â  opponentInfo.innerHTML = `${opponentRankDisplay} ${player2Name}: <span style="color: #33FF57; font-weight: bold;">${opponent61Score} pts</span>`;Â 
Â  Â  Â  Â  if(lowestChipNumber > 0 && gameState === 'aiming') {Â 
Â  Â  Â  Â  Â  Â  cueBallGuide.innerHTML = `Target: Chip #${lowestChipNumber}`;Â 
Â  Â  Â  Â  Â  Â  cueBallGuide.style.display = 'block';Â 
Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  cueBallGuide.style.display = 'none';Â 
Â  Â  Â  Â  }Â 
Â  Â  }Â 
Â  Â  updateLegalTargetChips();Â 
}
// === END (Step 3B) ===
// === END (Step 3) ===
        function updateLegalTargetChips() {
            legalTargetChipIds.clear(); // I-clear muna ang dating listahan
            const isMyTurn = isOnlineGame ? isMyTurnOnline : playerTurn;

            if (isMyTurn) { // Kunin lang ang legal targets kung turn ng player
                if (gameMode.includes('poker')) {
                    if (playerHand) {
                         playerHand.forEach(card => {
                            const targetChip = chips.find(c => c.inPlay && c.id === card.value);
                            if (targetChip) legalTargetChipIds.add(targetChip.id);
                        });
                    }
                } else if (gameMode.includes('61-ball')) {
                     // Sa 61-ball, ang lowest chip lang ang legal na UNANG tatamaan
                    if (lowestChipNumber > 0) {
                         const targetChip = chips.find(c => c.inPlay && c.id === lowestChipNumber);
                         if (targetChip) legalTargetChipIds.add(targetChip.id);
                    }
                } else if (gameMode.includes('straight-ball')) {
                     if (colorsAssigned && playerChipsType) {
                        // Kung may kulay na, 'yung kulay mo lang ang legal
                         chips.forEach(chip => {
                            if(chip.inPlay && chip.type === playerChipsType) {
                                legalTargetChipIds.add(chip.id);
                            }
                         });
                     } else {
                         // Kung wala pang kulay (open table), lahat pwede (maliban sa cue ball)
                         chips.forEach(chip => {
                            if(chip.inPlay && chip.id !== 0) {
                                legalTargetChipIds.add(chip.id);
                            }
                         });
                     }
                }
            }
            // Kung hindi turn ng player, or hindi pa nag-start ang game, or game over na,
            // 'legalTargetChipIds' ay mananatiling empty (walang iha-highlight)
        }
        // === END: RING LIGHT REQUEST (BAGONG FUNCTION) ===


        function resetPektus() { pektusOffset = { x: 0, y: 0 }; updatePektusUI(); }
        function updatePektusUI() { const controlSize = pektusControl.offsetWidth; if (controlSize === 0) return; const dotSize = pektusDot.offsetWidth; const maxOffset = (controlSize / 2) - (dotSize / 2); const dotX = (pektusOffset.x * maxOffset) + (controlSize / 2); const dotY = (pektusOffset.y * maxOffset) + (controlSize / 2); pektusDot.style.left = `${dotX}px`; pektusDot.style.top = `${dotY}px`; }
        
        // START: Tutorial Functions
        function startTutorial(mode, difficultyLevel) {
            resizeCanvas(); 
            const allModals = [gameModeSelect, aiMenu, /*difficultySelect,*/ straightBallInstructions, pokerInstructions, sixtyOneInstructions, onlineGameSelect, onlineMenu, waitingRoom, winnerModal, confirmExitModal, pokerFoulCardPickModal, leaderboardModal]; 
            allModals.forEach(modal => modal.classList.remove('show')); 
            gameMode = mode; 
            isOnlineGame = false; 
            difficulty = difficultyLevel; 
            playerTurn = true; 
            canMoveCueBall = true; 
            chipsMoving = false; 
            colorsAssigned = false;
            playerChipsType = null;
            opponentChipsType = null;
            setupChips();
            isBreakShot = true;
            gameState = 'moving';
            cueStick.visible = true;
            resetPektus();
            updateInfoBox(); // Tatawagin nito ang updateLegalTargetChips()
            
            isTutorialActive = true;
            tutorialStep = -1;

            tutorialSteps = [
                {
                    key: 'welcome',
                    elementId: null,
                    text: "Welcome sa Pinoy Pool! Turuan kita ng basics.",
                    trigger: 'button'
                },
                {
                    key: 'place',
                    elementId: 'game-canvas',
                    text: "Unang hakbang: i-drag ang cue ball (puting bola) sa kahit saang pwesto sa likod ng invisible line.",
                    trigger: 'release-cue-ball'
                },
                {
                    key: 'aim',
                    elementId: 'game-canvas',
                    text: "Kita mo ang tako? I-drag mo ang iyong mouse o daliri sa mesa para umasinta.",
                    trigger: 'drag'
                },
                 {
                    key: 'pektus',
                    elementId: 'pektus-control',
                    text: "Gusto mo ng spin? I-drag ang pulang tuldok dito para sa 'pektus'!",
                    trigger: 'drag'
                },
                {
                    key: 'power',
                    elementId: 'power-control',
                    text: "Ito naman ang power bar. I-drag ito pababa para i-set ang lakas ng tira mo.",
                    trigger: 'drag'
                },
                {
                    key: 'shoot',
                    elementId: 'power-control',
                    text: "Ayos! Bitawan mo na ang power bar para tumira.",
                    trigger: 'release-power'
                },
                {
                    key: 'finish',
                    elementId: null,
                    text: "Nice shot! Ganyan lang kadali. Ikaw na ang bahala sa laro. Good luck!",
                    trigger: 'button'
                }
            ];
            
            nextTutorialStep();
        }

        function updateTutorialStep(index) {
    const step = tutorialSteps[index];
    if (!step) {
        endTutorial();
        return;
    }

    interactiveElements.forEach(el => el.style.pointerEvents = 'none');
    
    tutorialOverlay.classList.add('show');
    tutorialText.textContent = step.text;

    if (step.elementId) {
        const targetElement = document.getElementById(step.elementId);
        targetElement.style.pointerEvents = 'all';

        const rect = targetElement.getBoundingClientRect();
        
        tutorialHighlight.style.display = 'block';
        tutorialHighlight.style.left = `${rect.left}px`;
        tutorialHighlight.style.top = `${rect.top}px`;
        tutorialHighlight.style.width = `${rect.width}px`;
        tutorialHighlight.style.height = `${rect.height}px`;

        // --- START OF FIX ---
        // Logic to intelligently position the tutorial box

        // Get the height of the tutorial box itself.
        // We use a slight delay to ensure it has rendered and has a height.
        setTimeout(() => {
            const boxHeight = tutorialBox.offsetHeight;
            let boxTopPosition = rect.bottom + 20; // Default position: below the element

            // Check if positioning it below makes it go off-screen
            if (boxTopPosition + boxHeight > window.innerHeight) {
                // If so, try positioning it above the element
                boxTopPosition = rect.top - boxHeight - 20;
            }

            // After trying above/below, check if it's still going off the top of the screen (especially on landscape)
            if (boxTopPosition < 0) {
                // If it goes off the top, just center it on the screen as a fallback
                tutorialBox.style.top = '50%';
                tutorialBox.style.left = '50%';
                tutorialBox.style.transform = 'translate(-50%, -50%)';
            } else {
                // Otherwise, the calculated position is fine. Center it horizontally.
                tutorialBox.style.top = `${boxTopPosition}px`;
                tutorialBox.style.left = '50%';
                tutorialBox.style.transform = 'translateX(-50%)';
            }
        }, 0);
        // --- END OF FIX ---

    } else {
        tutorialHighlight.style.display = 'none';
        tutorialBox.style.top = '50%';
        tutorialBox.style.left = '50%';
        tutorialBox.style.transform = 'translate(-50%, -50%)';
    }

    if (step.trigger === 'button') {
        tutorialNextBtn.style.display = 'block';
        tutorialNextBtn.textContent = (step.key === 'finish') ? 'Tapusin ang Tutorial' : 'Sige';
    } else {
        tutorialNextBtn.style.display = 'none';
    }
}


        function nextTutorialStep() {
            if (!isTutorialActive) return;
            
            tutorialStep++;
            if (tutorialStep < tutorialSteps.length) {
                updateTutorialStep(tutorialStep);
            } else {
                endTutorial();
            }
        }

        function resetControlInteractivity() {
            interactiveElements.forEach(el => el.style.pointerEvents = 'all');
        }

        function endTutorial() {
            isTutorialActive = false;
            tutorialOverlay.classList.remove('show');
            resetControlInteractivity();
            localStorage.setItem('pinoyPoolTutorialCompleted', 'true');
            showMessage("Tutorial finished. Good luck!", 3000);
            
            if (playerTurn) {
                 // Simulate starting the game after tutorial
                 canMoveCueBall = false; // Player already placed the ball
                 gameState = 'aiming'; // Ready to aim
                 cueStick.visible = true;
                 if(cueStickElement) cueStickElement.style.display = 'block';
                 updateLegalTargetChips(); // Update highlights for the actual game
            }
        }
        // END: Tutorial Functions

// ======================================================
// â–¼â–¼â–¼ SIMULA NG CODE PARA SA DAILY REWARDS â–¼â–¼â–¼
// ======================================================

// --- Variables para sa Daily Reward ---
const DAILY_REWARD_AMOUNT = 500; // Magkano ang reward
const DAILY_REWARD_COOLDOWN = 24 * 60 * 60 * 1000; // 24 oras in milliseconds (pwede mong babaan for testing, e.g., 60000 for 1 minute)
let lastRewardClaimTime = 0;

/**
 * Kinukuha ang timestamp ng huling claim mula sa localStorage.
 */
function loadLastClaimTime() {
    const savedTime = localStorage.getItem('pinoyPoolLastRewardClaim');
    lastRewardClaimTime = savedTime ? parseInt(savedTime, 10) : 0;
    // Hindi na kailangan i-update dito, tatawagin ito ng showLobbyUI or init
}

/**
 * Sine-save ang kasalukuyang oras bilang huling claim time.
 */
function saveLastClaimTime() {
    lastRewardClaimTime = Date.now();
    localStorage.setItem('pinoyPoolLastRewardClaim', lastRewardClaimTime.toString());
}

/**
 * Tinitingnan kung available na ba ang daily reward.
 * @returns {boolean} True kung available, false kung hindi pa.
 */
function isDailyRewardAvailable() {
    const currentTime = Date.now();
    // Check kung ang lastRewardClaimTime ay valid (hindi 0)
    if (lastRewardClaimTime === 0) {
        return true; // Available kung hindi pa naka-claim kahit kailan
    }
    return currentTime >= (lastRewardClaimTime + DAILY_REWARD_COOLDOWN);
}

/**
 * Ina-update ang itsura at text ng daily reward button.
 */
function updateDailyRewardButtonState() {
    const rewardButton = document.getElementById('daily-reward-button');
    if (!rewardButton) return; // Kung wala yung button, huwag ituloy

    if (isDailyRewardAvailable()) {
        rewardButton.classList.remove('claimed');
        rewardButton.classList.add('available');
        rewardButton.disabled = false;
        // Gumamit ng innerHTML para gumana ang span (at glow effect)
        rewardButton.innerHTML = 'ğŸ <span>Claim Daily Reward!</span>';
    } else {
        rewardButton.classList.remove('available');
        rewardButton.classList.add('claimed');
        rewardButton.disabled = true;
        // Kalkulahin ang natitirang oras
        const timeRemaining = (lastRewardClaimTime + DAILY_REWARD_COOLDOWN) - Date.now();

        // Siguraduhing hindi negative ang timeRemaining
        if (timeRemaining <= 0) {
             rewardButton.classList.remove('claimed');
             rewardButton.classList.add('available');
             rewardButton.disabled = false;
             rewardButton.innerHTML = 'ğŸ <span>Claim Daily Reward!</span>';
             return; // Available na pala, stop here
        }

        const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
        const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
        // Gumamit ng innerHTML para gumana ang span
        rewardButton.innerHTML = `ğŸ <span>Reward in ${hours}h ${minutes}m</span>`;
    }
}


/**
 * Ang function na tatawagin kapag pinindot ang claim button.
 */
function claimDailyReward() {
    if (isDailyRewardAvailable()) {
        playButtonSound(); // Patunugin ang button

        // 1. Idagdag ang reward sa currency
        playerTotalCurrency += DAILY_REWARD_AMOUNT;
        saveCurrency(); // I-save agad ang bagong total
        updateCurrencyDisplay(); // I-update ang display sa UI

        // 2. I-record ang oras ng pag-claim
        saveLastClaimTime();

        // 3. I-update ang itsura ng button
        updateDailyRewardButtonState();

        // 4. Ipakita ang confirmation modal
        const rewardModal = document.getElementById('daily-reward-modal');
        const rewardText = document.getElementById('reward-amount-text');
        if (rewardText) {
             rewardText.textContent = `+ ${DAILY_REWARD_AMOUNT} ${CURRENCY_NAME}!`;
        }
        if (rewardModal) {
            rewardModal.classList.add('show');
            // Hindi na natin kailangan i-push state dito kung gusto nating simpleng modal lang
            // history.pushState({ modal: 'dailyRewardModal' }, 'Reward Claimed', '#reward');
        }

    } else {
        // Magpakita ng message kung hindi pa pwede
        showMessage("Reward not available yet. Come back later!", 2000);
    }
}

/**
 * Isinasara ang daily reward modal.
 */
function closeDailyRewardModal() {
    playButtonSound();
    const rewardModal = document.getElementById('daily-reward-modal');
    if (rewardModal) {
        rewardModal.classList.remove('show');
        // Hindi na kailangan mag history.back kung hindi nag push state
        // if (history.state && history.state.modal === 'dailyRewardModal') {
        //      history.back();
        // }
    }
}

// Function para i-save ang currency (para reusable)
function saveCurrency() {
     localStorage.setItem('pinoyPoolCurrency', playerTotalCurrency.toString());
}

// ======================================================
// â–²â–²â–² DULO NG CODE PARA SA DAILY REWARDS â–²â–²â–²
// ======================================================

// â–¼â–¼â–¼ IDAGDAG MO ITONG MGA HELPER FUNCTIONS (PART B) â–¼â–¼â–¼

function showLobbyUI() {
    const lobbyContainer = document.getElementById('lobby-buttons-container');
    if (lobbyContainer) lobbyContainer.style.display = 'flex';

    // Itago ang mga game controls
    const gameControls = ['power-control', 'pektus-control', 'left-arrow', 'right-arrow', 'exit-button', 'player-info', 'opponent-info', 'card-hand-container', 'cue-stick-element', 'chat-toggle-button'];
    gameControls.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
    cueBallGuide.style.display = 'none';
    dragGuideText.style.display = 'none';

    // Ipakita ang chips (optional, kung gusto mong makita agad)
    // Check kung 'lobby' or 'menu' ang initial state, setup chips if needed
    if ((gameState === 'lobby' || gameState === 'menu') && chips.length === 0) {
         setupChips(); // I-setup kung wala pa
         draw(); // Draw the initial chips
    }
    gameState = 'lobby'; // Set state to lobby
    updateDailyRewardButtonState(); // I-update ang reward button
    setCueForCurrentTurn(); // I-set ang default cue view (para kita ang cue stick image)
     // Siguraduhing nakikita ang cue stick element sa lobby pero hindi interactive
     const cueEl = document.getElementById('cue-stick-element');
     if(cueEl) cueEl.style.display = 'none'; // Itago muna natin sa lobby view

     // Update currency display pagpasok sa lobby
     updateCurrencyDisplay();
}

function hideLobbyUI() {
    const lobbyContainer = document.getElementById('lobby-buttons-container');
    if (lobbyContainer) lobbyContainer.style.display = 'none';

     // Optional: Ipakita ang exit button pag alis sa lobby papunta sa menu
     const exitBtn = document.getElementById('exit-button');
     if (exitBtn) exitBtn.style.display = 'block';
}

function showGameUI() {
    hideLobbyUI(); // Siguraduhing tago ang lobby buttons

    // Ipakita ang mga game controls
    const gameControls = ['power-control', 'pektus-control', 'left-arrow', 'right-arrow', 'exit-button', 'player-info', 'opponent-info', 'cue-stick-element'];
    gameControls.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
             if (id.includes('-control') || id.includes('-arrow')) {
                 el.style.display = 'flex'; // Use flex for these
             } else if (id === 'cue-stick-element') {
                 // Show cue stick element only if aiming or animating, hide otherwise initially
                 if (gameState === 'aiming' || gameState === 'shooting_animation') {
                     el.style.display = 'block';
                 } else {
                     el.style.display = 'none';
                 }
             } else {
                 el.style.display = 'block'; // Use block for others like info boxes, exit button
             }
        }
    });

    // Handle visibility based on game mode/state
    if (gameMode.includes('poker')) {
        const cardHand = document.getElementById('card-hand-container');
        if (cardHand) cardHand.style.display = 'flex';
    } else {
         const cardHand = document.getElementById('card-hand-container');
         if (cardHand) cardHand.style.display = 'none';
    }
     const chatToggle = document.getElementById('chat-toggle-button');
     if (chatToggle) chatToggle.style.display = isOnlineGame ? 'flex' : 'none'; // Show chat toggle only in online game

    // Ensure instruction modals are hidden when game UI shows
     const instructionModals = document.querySelectorAll('.instruction-modal, #ai-menu, #online-game-select, #online-menu'); // Include other menus
     instructionModals.forEach(modal => modal.classList.remove('show'));
}

// â–²â–²â–² HANGGANG DITO (PART B) â–²â–²â–²

        init();
    </script>
</body>
</html>

